<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>{{ exam.title }} - {{ result.student_id }} è©³ç´°æ‰¹æ”¹çµæœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px}
    .wrap{max-width:1400px;margin:0 auto}
    .card{background:#fff;border-radius:14px;padding:24px;box-shadow:0 6px 20px rgba(0,0,0,.06);margin-bottom:24px}
    h1{margin:0 0 8px;font-size:24px;color:#1f2937}
    h2{margin:0 0 16px;font-size:20px;color:#1f2937}
    h3{margin:0 0 12px;font-size:18px;color:#374151}
    .exam-meta{color:#6b7280;margin-bottom:20px}
    .back-link{display:inline-block;margin-bottom:20px;color:#4f46e5;text-decoration:none}
    .back-link:hover{text-decoration:underline}
    .score-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
    .score-card{background:#f8fafc;border-radius:8px;padding:20px;text-align:center;border-left:4px solid #4f46e5}
    .score-card.gpt{border-left-color:#10b981}
    .score-card.claude{border-left-color:#3b82f6}
    .score-card.final{border-left-color:#f59e0b}
    .score-number{font-size:32px;font-weight:700;margin:0;color:#1f2937}
    .score-label{color:#6b7280;font-size:14px;margin:4px 0 0}
    .section{margin-bottom:32px}
    .grading-table{width:100%;border-collapse:collapse;margin-bottom:20px}
    .grading-table th,.grading-table td{padding:12px;text-align:left;border-bottom:1px solid #e5e7eb}
    .grading-table th{background:#f9fafb;font-weight:600;color:#374151}
    .grading-table tr:hover{background:#f9fafb}
    .feedback-section{background:#f8fafc;border-radius:8px;padding:20px;margin-bottom:20px}
    .feedback-content{white-space:pre-wrap;line-height:1.6;color:#374151}
    .weakness-analysis{background:#fef3c7;border-radius:8px;padding:20px;margin-bottom:20px}
    .weakness-analysis h3{color:#92400e;margin-bottom:16px}
    .weakness-item{margin-bottom:16px;padding:12px;background:#fff;border-radius:6px;border-left:4px solid #f59e0b}
    .weakness-topic{font-weight:600;color:#92400e;margin-bottom:8px}
    .weakness-details{color:#6b7280;font-size:14px}
    .tabs{display:flex;border-bottom:2px solid #e5e7eb;margin-bottom:20px}
    .tab{padding:12px 24px;cursor:pointer;border-bottom:2px solid transparent;color:#6b7280;font-weight:500}
    .tab.active{border-bottom-color:#4f46e5;color:#4f46e5}
    .tab:hover{color:#4f46e5}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .risk-score{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:500;background:#d1fae5;color:#065f46}
    .coach-comment{background:#eff6ff;border-radius:8px;padding:16px;margin-bottom:16px;border-left:4px solid #3b82f6}
    .coach-comment h4{margin:0 0 8px;color:#1e40af}
    .priority-actions{background:#f0fdf4;border-radius:8px;padding:16px;margin-bottom:16px;border-left:4px solid #10b981}
    .priority-actions h4{margin:0 0 8px;color:#16a34a}
    .practice-suggestions{background:#fef3c7;border-radius:8px;padding:16px;border-left:4px solid #f59e0b}
    .practice-suggestions h4{margin:0 0 8px;color:#92400e}
    .blackboard-container{max-height:600px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:8px;padding:16px}
    .blackboard-message{margin-bottom:16px;padding:12px;border-radius:6px;border-left:4px solid #6b7280}
    .blackboard-message.used{border-left-color:#10b981;background:#f0fdf4}
    .blackboard-message.consensus{border-left-color:#3b82f6;background:#eff6ff}
    .blackboard-message.disagreement{border-left-color:#f59e0b;background:#fffbeb}
    .blackboard-message.arbitration_summary{border-left-color:#8b5cf6;background:#f3e8ff}
    .blackboard-message.similarity_check{border-left-color:#06b6d4;background:#ecfeff}
    .blackboard-message.weakness_review{border-left-color:#f97316;background:#fff7ed}
    .blackboard-message.security_scan{border-left-color:#ef4444;background:#fef2f2}
    .message-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .message-type{font-weight:600;color:#374151;font-size:14px}
    .message-time{color:#6b7280;font-size:12px}
    .message-content{color:#1f2937;line-height:1.5;white-space:pre-wrap}
    .message-payload{margin-top:8px;font-size:12px}
    .message-payload details{color:#6b7280}
    .message-payload pre{background:#f9fafb;padding:8px;border-radius:4px;overflow-x:auto;font-size:11px}
    
    /* é¡Œè©å»ºè­°æ¨£å¼ */
    .prompt-suggestion{background:#e8f5e8;border:2px solid #28a745;border-radius:8px;padding:16px;margin-top:12px}
    .prompt-suggestion h4{color:#155724;margin:0 0 12px 0;font-size:16px}
    .prompt-suggestion h5{color:#155724;margin:12px 0 8px 0;font-size:14px}
    .prompt-content{background:#ffffff;border:1px solid #c3e6cb;border-radius:4px;padding:12px;margin:8px 0}
    .prompt-content pre{background:transparent;border:none;padding:0;margin:0;font-size:13px;line-height:1.4;white-space:pre-wrap;word-wrap:break-word}
    .suggestion-reason{background:#f8f9fa;border:1px solid #dee2e6;border-radius:4px;padding:12px;margin:8px 0}
    .suggestion-reason p{margin:0;color:#495057;line-height:1.5}
    .suggestion-actions{margin-top:12px;display:flex;align-items:center;gap:12px}
    .apply-status{font-size:14px;font-weight:500}
    .apply-status.success{color:#28a745}
    .apply-status.error{color:#dc3545}
    .btn{display:inline-block;padding:8px 16px;background:#4f46e5;color:#fff;border:none;border-radius:6px;cursor:pointer;text-decoration:none;font-size:14px;font-weight:500}
    .btn:hover{background:#4338ca}
    .btn-success{background:#28a745}
    .btn-success:hover{background:#218838}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="{{ url_for('exam_results', exam_id=exam.exam_id) }}" class="back-link">â† è¿”å›è€ƒè©¦çµæœ</a>
    
    <div class="card">
      <h1>{{ exam.title }} - {{ result.student_id }} è©³ç´°æ‰¹æ”¹çµæœ</h1>
      <div class="exam-meta">
        ç§‘ç›®ï¼š{{ exam.subject }} | 
        æ‰¹æ”¹æ™‚é–“ï¼š{{ result.graded_at.strftime('%Y-%m-%d %H:%M:%S') }} | 
        ç‹€æ…‹ï¼š<span class="status status-{{ result.status }}">{{ result.status }}</span>
      </div>

      <!-- åˆ†æ•¸æ‘˜è¦ -->
      <div class="score-summary">
        <div class="score-card gpt">
          <div class="score-number">{{ result.gpt_score }}</div>
          <div class="score-label">GPT åˆ†æ•¸</div>
        </div>
        <div class="score-card claude">
          <div class="score-number">{{ result.claude_score }}</div>
          <div class="score-label">Claude åˆ†æ•¸</div>
        </div>
        <div class="score-card final">
          <div class="score-number">{{ result.final_score }}</div>
          <div class="score-label">æœ€çµ‚åˆ†æ•¸</div>
        </div>
      </div>

      <!-- æ¨™ç±¤é  -->
      <div class="tabs">
        <div class="tab active" onclick="showTab('final')">æœ€çµ‚çµæœ</div>
        <div class="tab" onclick="showTab('gpt')">GPT è©•åˆ†</div>
        <div class="tab" onclick="showTab('claude')">Claude è©•åˆ†</div>
        {% if result.weakness_analysis %}
        <div class="tab" onclick="showTab('weakness')">å¼±é»åˆ†æ</div>
        {% endif %}
        {% if blackboard_messages %}
        <div class="tab" onclick="showTab('blackboard')">æ‰¹æ”¹éç¨‹</div>
        {% endif %}
        {% if learning_suggestions %}
        <div class="tab" onclick="showTab('suggestions')">å­¸ç¿’å»ºè­°</div>
        {% endif %}
      </div>

      <!-- æœ€çµ‚çµæœ -->
      <div id="final" class="tab-content active">
        <div class="section">
          <h2>æœ€çµ‚è©•åˆ†çµæœ</h2>
          {% if result.final_table %}
            <div class="feedback-content">{{ result.final_table | safe }}</div>
          {% else %}
            <p>æš«ç„¡è©³ç´°è©•åˆ†è¡¨æ ¼</p>
          {% endif %}
        </div>
        
        <div class="section">
          <h2>æœ€çµ‚åé¥‹</h2>
          <div class="feedback-section">
            <div class="feedback-content">{{ result.final_feedback }}</div>
          </div>
        </div>
      </div>

      <!-- GPT è©•åˆ† -->
      <div id="gpt" class="tab-content">
        <div class="section">
          <h2>GPT è©•åˆ†çµæœ</h2>
          {% if result.gpt_table %}
            <div class="feedback-content">{{ result.gpt_table | safe }}</div>
          {% else %}
            <p>æš«ç„¡ GPT è©³ç´°è©•åˆ†è¡¨æ ¼</p>
          {% endif %}
        </div>
        
        <div class="section">
          <h2>GPT åé¥‹</h2>
          <div class="feedback-section">
            <div class="feedback-content">{{ result.gpt_feedback }}</div>
          </div>
        </div>
      </div>

      <!-- Claude è©•åˆ† -->
      <div id="claude" class="tab-content">
        <div class="section">
          <h2>Claude è©•åˆ†çµæœ</h2>
          {% if result.claude_table %}
            <div class="feedback-content">{{ result.claude_table | safe }}</div>
          {% else %}
            <p>æš«ç„¡ Claude è©³ç´°è©•åˆ†è¡¨æ ¼</p>
          {% endif %}
        </div>
        
        <div class="section">
          <h2>Claude åé¥‹</h2>
          <div class="feedback-section">
            <div class="feedback-content">{{ result.claude_feedback }}</div>
          </div>
        </div>
      </div>

      <!-- è©³ç´°å­¸ç¿’å»ºè­° -->
      <div id="weakness" class="tab-content">
        <div class="section">
          <h2>ğŸ“Š è©³ç´°å­¸ç¿’åˆ†æ</h2>
          
          {# æ•™ç·´çŸ­è©•ï¼šå„ªå…ˆç”¨ result.weakness_analysisï¼›è‹¥ç„¡ï¼Œé€€å› learning_suggestions #}
          {% set wa = result.weakness_analysis if result.weakness_analysis else None %}
          {% if wa and wa.coach_comment %}
          <div class="coach-comment">
            <h4>æ•™ç·´çŸ­è©•</h4>
            <div class="feedback-content">{{ wa.coach_comment }}</div>
          </div>
          {% elif learning_suggestions and learning_suggestions.coach_comment %}
          <div class="coach-comment">
            <h4>æ•™ç·´çŸ­è©•</h4>
            <div class="feedback-content">{{ learning_suggestions.coach_comment }}</div>
          </div>
          {% endif %}

          
          <!-- å¼±é»åˆ†æè¡¨æ ¼ï¼šå„ªå…ˆä½¿ç”¨ result.weakness_analysis -->
          {% if wa and wa.weakness_clusters %}
          <div class="section">
            <h3>å¼±é»åˆ†æ</h3>
            <table class="grading-table">
              <thead>
                <tr>
                  <th>ä¸»é¡Œ</th>
                  <th>é »æ¬¡</th>
                  <th>ç›¸é—œé¡Œè™Ÿ</th>
                  <th>ä»£è¡¨æ€§ç‰‡èª</th>
                </tr>
              </thead>
              <tbody>
                {% for weakness in wa.weakness_clusters %}
                <tr>
                  <td>{{ weakness.topic }}</td>
                  <td>{{ weakness.frequency }}</td>
                  <td>{{ weakness.evidence_qids | join(', ') }}</td>
                  <td>
                    {% for phrase in weakness.evidence_snippets %}
                      <div class="weakness-item">
                        <div class="weakness-topic">{{ phrase }}</div>
                      </div>
                    {% endfor %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% elif learning_suggestions and learning_suggestions.weakness_clusters %}
          <div class="section">
            <h3>å¼±é»åˆ†æ</h3>
            <table class="grading-table">
              <thead>
                <tr>
                  <th>ä¸»é¡Œ</th>
                  <th>é »æ¬¡</th>
                  <th>ç›¸é—œé¡Œè™Ÿ</th>
                  <th>ä»£è¡¨æ€§ç‰‡èª</th>
                </tr>
              </thead>
              <tbody>
                {% for weakness in learning_suggestions.weakness_clusters %}
                <tr>
                  <td>{{ weakness.topic }}</td>
                  <td>{{ weakness.frequency }}</td>
                  <td>{{ weakness.evidence_qids | join(', ') }}</td>
                  <td>
                    {% for phrase in weakness.evidence_snippets %}
                      <div class="weakness-item">
                        <div class="weakness-topic">{{ phrase }}</div>
                      </div>
                    {% endfor %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}

          {# åœ¨å¼±é»åˆ†æé ä¸é¡¯ç¤ºå»ºè­°å…§å®¹ï¼Œé¿å…èˆ‡å­¸ç¿’å»ºè­°åˆ†é é‡è¤‡ #}
        </div>
      </div>

      <!-- æ‰¹æ”¹éç¨‹ï¼ˆé»‘æ¿è¨Šæ¯ï¼‰ -->
      {% if blackboard_messages %}
      <div id="blackboard" class="tab-content">
        <div class="section">
          <h2>æ‰¹æ”¹éç¨‹è©³æƒ…</h2>
          <div class="blackboard-container">
            {% for message in blackboard_messages %}
              <div class="blackboard-message {{ message.type }}">
                <div class="message-header">
                  <span class="message-type">{{ message.action or message.type }}</span>
                  <span class="message-time">
                    {% if message.timestamp %}
                      {{ message.timestamp }}
                    {% endif %}
                  </span>
                </div>
                <div class="message-content">
                  {{ message.content }}
                </div>
                
                <!-- ç‰¹åˆ¥è™•ç†é¡Œè©å»ºè­° -->
                {% if message.action == 'suggestion' and message.payload and message.payload.proposed %}
                <div class="prompt-suggestion">
                  <h4>ğŸ“ å»ºè­°çš„æ–°é¡Œè©ï¼š</h4>
                  <div class="prompt-content">
                    <pre>{{ message.payload.proposed }}</pre>
                  </div>
                  {% if message.payload.reason %}
                  <div class="suggestion-reason">
                    <h5>ğŸ’¡ å»ºè­°ç†ç”±ï¼š</h5>
                    <p>{{ message.payload.reason }}</p>
                  </div>
                  {% endif %}
                  <div class="suggestion-actions">
                    <button class="btn btn-success" onclick="applyPrompt(this, '{{ message.payload.proposed | replace("'", "\\'") | replace('"', '\\"') | replace('\n', '\\n') | replace('\r', '\\r') }}', '{{ result.task_id or "" }}')">
                      âœ… å¥—ç”¨å»ºè­°é¡Œè©
                    </button>
                    <span class="apply-status" id="apply-status-{{ loop.index }}"></span>
                  </div>
                </div>
                {% endif %}
                
                {% if message.payload %}
                <div class="message-payload">
                  <details>
                    <summary>è©³ç´°è³‡æ–™</summary>
                    <pre>{{ message.payload | tojson(indent=2) }}</pre>
                  </details>
                </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- å­¸ç¿’å»ºè­° -->
      {% if learning_suggestions %}
      <div id="suggestions" class="tab-content">
        <div class="section">
          <h2>ğŸ¯ å€‹äººå­¸ç¿’å»ºè­°</h2>
          
          <!-- è¡¨ç¾æ¦‚è¦½ -->
          <div class="score-summary">
            <div class="score-card">
              <div class="score-number">{{ learning_suggestions.performance_summary.student_score }}</div>
              <div class="score-label">æ‚¨çš„åˆ†æ•¸</div>
            </div>
            <div class="score-card">
              <div class="score-number">{{ learning_suggestions.performance_summary.avg_score }}</div>
              <div class="score-label">å…¨ç­å¹³å‡</div>
            </div>
            <div class="score-card">
              <div class="score-number">{{ learning_suggestions.performance_summary.rank_percentile }}%</div>
              <div class="score-label">æ’åç™¾åˆ†ä½</div>
            </div>
            <div class="score-card">
              <div class="score-number" style="color: {% if learning_suggestions.score_diff > 0 %}#10b981{% else %}#ef4444{% endif %};">
                {% if learning_suggestions.score_diff > 0 %}+{% endif %}{{ learning_suggestions.score_diff }}
              </div>
              <div class="score-label">èˆ‡å¹³å‡åˆ†å·®è·</div>
            </div>
          </div>

          <!-- æ•™ç·´çŸ­è©• -->
          {% if learning_suggestions and learning_suggestions.coach_comment %}
          <div class="coach-comment">
            <h4>æ•™ç·´çŸ­è©•</h4>
            <div class="feedback-content">{{ learning_suggestions.coach_comment }}</div>
          </div>
          {% endif %}

          
          {# å­¸ç¿’å»ºè­°é ä¸é¡¯ç¤ºå¼±é»èšé¡ï¼Œé¿å…èˆ‡ã€Œè©³ç´°å­¸ç¿’åˆ†æã€åˆ†é é‡è¤‡ #}

          <!-- å„ªå…ˆä¿®æ­£è¡Œå‹• -->
          {% if learning_suggestions and learning_suggestions.prioritized_actions %}
          <div class="priority-actions">
            <h4>å„ªå…ˆä¿®æ­£è¡Œå‹•</h4>
            {% for action in learning_suggestions.prioritized_actions %}
              <div class="weakness-item">
                <div class="weakness-topic">{{ action.action }}</div>
                <div class="weakness-details">
                  <strong>ä¿®æ­£ç¯„ä¾‹ï¼š</strong>{{ action.example_fix }}
                </div>
              </div>
            {% endfor %}
          </div>
          {% endif %}

          <!-- ç·´ç¿’å»ºè­° -->
          {% if learning_suggestions and learning_suggestions.practice_suggestions %}
          <div class="practice-suggestions">
            <h4>å­¸ç¿’å»ºè­°</h4>
            {% for suggestion in learning_suggestions.practice_suggestions %}
              <div class="weakness-item">
                <div class="weakness-topic">{{ suggestion.title }}</div>
                {% if suggestion.description %}
                <div class="weakness-details">
                  <strong>æè¿°ï¼š</strong>{{ suggestion.description }}
                </div>
                {% endif %}
                {% if suggestion.key_focus %}
                <div class="weakness-details">
                  <strong>é‡é»é—œæ³¨ï¼š</strong>
                  <ul>
                    {% for focus in suggestion.key_focus %}
                    <li>{{ focus }}</li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}
                {% if suggestion.examples %}
                <div class="weakness-details">
                  <strong>ç¯„ä¾‹ï¼š</strong>
                  <ul>
                    {% for example in suggestion.examples %}
                    <li>{{ example }}</li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}
                {% if suggestion.pre_submission_check %}
                <div class="weakness-details">
                  <strong>æäº¤å‰æª¢æŸ¥ï¼š</strong>
                  {{ suggestion.pre_submission_check }}
                </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <script>
    function showTab(tabName) {
      // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
      const contents = document.querySelectorAll('.tab-content');
      contents.forEach(content => content.classList.remove('active'));
      
      // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„ active é¡åˆ¥
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => tab.classList.remove('active'));
      
      // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
      document.getElementById(tabName).classList.add('active');
      
      // ç‚ºé¸ä¸­çš„æ¨™ç±¤æ·»åŠ  active é¡åˆ¥
      event.target.classList.add('active');
    }
    
    async function applyPrompt(button, promptContent, taskId) {
      const statusElement = button.nextElementSibling;
      
      // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      button.disabled = true;
      button.textContent = 'å¥—ç”¨ä¸­...';
      statusElement.textContent = '';
      
      console.log('å¥—ç”¨é¡Œè©:', {
        subject: '{{ exam.subject }}',
        promptContent: promptContent.substring(0, 100) + '...',
        taskId: taskId
      });
      
      try {
        const response = await fetch('/api/prompt/apply', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            subject: '{{ exam.subject }}',
            prompt_content: promptContent,
            task_id: taskId
          })
        });
        
        const result = await response.json();
        console.log('å¥—ç”¨çµæœ:', result);
        
        if (result.ok) {
          statusElement.textContent = `âœ… å·²å¥—ç”¨ï¼Œç‰ˆæœ¬å‡è‡³ v${result.version}`;
          statusElement.className = 'apply-status success';
          button.textContent = 'å·²å¥—ç”¨';
          button.style.background = '#6c757d';
        } else {
          statusElement.textContent = `âŒ å¥—ç”¨å¤±æ•—ï¼š${result.error}`;
          statusElement.className = 'apply-status error';
          button.disabled = false;
          button.textContent = 'âœ… å¥—ç”¨å»ºè­°é¡Œè©';
        }
      } catch (error) {
        console.error('å¥—ç”¨éŒ¯èª¤:', error);
        statusElement.textContent = `âŒ å¥—ç”¨å¤±æ•—ï¼š${error.message}`;
        statusElement.className = 'apply-status error';
        button.disabled = false;
        button.textContent = 'âœ… å¥—ç”¨å»ºè­°é¡Œè©';
      }
    }
  </script>
</body>
</html>


