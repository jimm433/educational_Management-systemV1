<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…¨ç­å­¸ç¿’ç‹€æ³åˆ†æ - {{ exam.title }}</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#f8fafc;color:#1f2937;line-height:1.6}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .back-link{display:inline-flex;align-items:center;color:#6b7280;text-decoration:none;margin-bottom:20px;font-size:14px}
    .back-link:hover{color:#374151}
    .card{background:white;border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .card h1{font-size:24px;font-weight:700;margin-bottom:8px;color:#111827}
    .card h2{font-size:20px;font-weight:600;margin-bottom:16px;color:#374151}
    .exam-meta{color:#6b7280;margin-bottom:24px;font-size:14px}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
    .stat-item{background:#f8fafc;border-radius:8px;padding:20px;text-align:center}
    .stat-number{font-size:32px;font-weight:700;color:#4f46e5;margin-bottom:4px}
    .stat-label{color:#6b7280;font-size:14px}
    .chart-container{position:relative;height:400px;margin-bottom:24px}
    .chart-container.small{height:300px}
    .analysis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:24px}
    .score-distribution{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-top:16px}
    .score-range{background:#f8fafc;border-radius:8px;padding:16px;text-align:center;border-left:4px solid #4f46e5}
    .score-range.excellent{border-left-color:#10b981}
    .score-range.good{border-left-color:#3b82f6}
    .score-range.average{border-left-color:#f59e0b}
    .score-range.poor{border-left-color:#ef4444}
    .score-range.fail{border-left-color:#6b7280}
    .range-label{font-size:14px;color:#6b7280;margin-bottom:4px}
    .range-count{font-size:24px;font-weight:700;color:#374151}
    .range-percentage{font-size:12px;color:#6b7280}
    .insights{background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:16px;margin-top:16px}
    .insights h3{color:#0369a1;margin-bottom:8px;font-size:16px}
    .insights ul{list-style:none;padding:0}
    .insights li{margin-bottom:8px;color:#0c4a6e}
    .insights li:before{content:"ğŸ’¡";margin-right:8px}
    .btn{display:inline-flex;align-items:center;padding:8px 16px;background:#4f46e5;color:white;text-decoration:none;border-radius:6px;font-size:14px;font-weight:500;border:none;cursor:pointer;transition:background 0.2s}
    .btn:hover{background:#4338ca}
    .btn-secondary{background:#6b7280}
    .btn-secondary:hover{background:#4b5563}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px}
    .empty-state{text-align:center;padding:40px;color:#6b7280}
    .empty-state h3{margin:0 0 8px;color:#374151}
    .empty-state p{margin:0 0 20px}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="{{ url_for('exam_detail', exam_id=exam.exam_id) }}" class="back-link">â† è¿”å›è€ƒè©¦è©³æƒ…</a>
    
    <div class="card">
      <h1>ğŸ“Š {{ exam.title }} - å…¨ç­å­¸ç¿’ç‹€æ³åˆ†æ</h1>
      <div class="exam-meta">
        ç§‘ç›®ï¼š{{ exam.subject }} | 
        æ»¿åˆ†ï¼š{{ exam.max_score }}åˆ† | 
        åˆ†ææ™‚é–“ï¼š{{ moment().strftime('%Y-%m-%d %H:%M') if moment else '2025-09-14 20:00' }}
      </div>

      {% if class_stats %}
        <!-- åŸºæœ¬çµ±è¨ˆ -->
        <div class="stats">
          <div class="stat-item">
            <div class="stat-number">{{ class_stats.total_students }}</div>
            <div class="stat-label">ç¸½äººæ•¸</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ class_stats.avg_score }}</div>
            <div class="stat-label">å¹³å‡åˆ†</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ class_stats.max_score }}</div>
            <div class="stat-label">æœ€é«˜åˆ†</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ class_stats.min_score }}</div>
            <div class="stat-label">æœ€ä½åˆ†</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ class_stats.pass_rate }}%</div>
            <div class="stat-label">åŠæ ¼ç‡</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ class_stats.std_dev }}</div>
            <div class="stat-label">æ¨™æº–å·®</div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰éˆ• -->
        <div class="actions">
          <a href="{{ url_for('exam_results', exam_id=exam.exam_id) }}" class="btn btn-secondary">æŸ¥çœ‹è©³ç´°æˆç¸¾</a>
          <a href="{{ url_for('exam_detail', exam_id=exam.exam_id) }}" class="btn btn-secondary">è¿”å›è€ƒè©¦è©³æƒ…</a>
        </div>
      {% endif %}
    </div>

    {% if class_stats %}
      <div class="analysis-grid">
        <!-- æˆç¸¾åˆ†å¸ƒåœ– -->
        <div class="card">
          <h2>ğŸ“ˆ æˆç¸¾åˆ†å¸ƒåœ–</h2>
          <div class="chart-container">
            <canvas id="scoreDistributionChart"></canvas>
          </div>
        </div>

        <!-- æˆç¸¾åˆ†å¸ƒçµ±è¨ˆ -->
        <div class="card">
          <h2>ğŸ“Š æˆç¸¾åˆ†å¸ƒçµ±è¨ˆ</h2>
          <div class="score-distribution">
            {% if exam.max_score <= 10 %}
              <!-- å°åˆ†æ•¸è€ƒè©¦çš„åˆ†å¸ƒ -->
              <div class="score-range excellent">
                <div class="range-label">å„ªç§€ ({{ (exam.max_score * 0.9)|round|int }}-{{ exam.max_score }})</div>
                <div class="range-count">{{ class_stats.score_ranges['å„ªç§€'] }}</div>
                <div class="range-percentage">{{ "%.1f"|format(class_stats.score_ranges['å„ªç§€'] / class_stats.total_students * 100) }}%</div>
              </div>
              <div class="score-range good">
                <div class="range-label">è‰¯å¥½ ({{ (exam.max_score * 0.8)|round|int }}-{{ (exam.max_score * 0.9 - 0.1)|round|int }})</div>
                <div class="range-count">{{ class_stats.score_ranges['è‰¯å¥½'] }}</div>
                <div class="range-percentage">{{ "%.1f"|format(class_stats.score_ranges['è‰¯å¥½'] / class_stats.total_students * 100) }}%</div>
              </div>
              <div class="score-range average">
                <div class="range-label">ä¸­ç­‰ ({{ (exam.max_score * 0.7)|round|int }}-{{ (exam.max_score * 0.8 - 0.1)|round|int }})</div>
                <div class="range-count">{{ class_stats.score_ranges['ä¸­ç­‰'] }}</div>
                <div class="range-percentage">{{ "%.1f"|format(class_stats.score_ranges['ä¸­ç­‰'] / class_stats.total_students * 100) }}%</div>
              </div>
              <div class="score-range poor">
                <div class="range-label">å¾…æ”¹é€² ({{ (exam.max_score * 0.6)|round|int }}-{{ (exam.max_score * 0.7 - 0.1)|round|int }})</div>
                <div class="range-count">{{ class_stats.score_ranges['å¾…æ”¹é€²'] }}</div>
                <div class="range-percentage">{{ "%.1f"|format(class_stats.score_ranges['å¾…æ”¹é€²'] / class_stats.total_students * 100) }}%</div>
              </div>
              <div class="score-range fail">
                <div class="range-label">éœ€è¦åŠ å¼· (0-{{ (exam.max_score * 0.6 - 0.1)|round|int }})</div>
                <div class="range-count">{{ class_stats.score_ranges['éœ€è¦åŠ å¼·'] }}</div>
                <div class="range-percentage">{{ "%.1f"|format(class_stats.score_ranges['éœ€è¦åŠ å¼·'] / class_stats.total_students * 100) }}%</div>
              </div>
            {% else %}
              <!-- ä¸€èˆ¬æ»¿åˆ†è€ƒè©¦ï¼ˆä»¥æ»¿åˆ†æ›ç®—å¯¦éš›åˆ†æ•¸å€é–“é¡¯ç¤ºï¼‰ -->
              <div class="score-range excellent">
                <div class="range-label">å„ªç§€ ({{ (exam.max_score * 0.9)|round|int }}-{{ exam.max_score }})</div>
                <div class="range-count">{{ class_stats.score_ranges['å„ªç§€'] }}</div>
                <div class="range-percentage">{{ "%.1f"|format(class_stats.score_ranges['å„ªç§€'] / class_stats.total_students * 100) }}%</div>
              </div>
              <div class="score-range good">
                <div class="range-label">è‰¯å¥½ ({{ (exam.max_score * 0.8)|round|int }}-{{ (exam.max_score * 0.9 - 1)|round|int }})</div>
                <div class="range-count">{{ class_stats.score_ranges['è‰¯å¥½'] }}</div>
                <div class="range-percentage">{{ "%.1f"|format(class_stats.score_ranges['è‰¯å¥½'] / class_stats.total_students * 100) }}%</div>
              </div>
              <div class="score-range average">
                <div class="range-label">ä¸­ç­‰ ({{ (exam.max_score * 0.7)|round|int }}-{{ (exam.max_score * 0.8 - 1)|round|int }})</div>
                <div class="range-count">{{ class_stats.score_ranges['ä¸­ç­‰'] }}</div>
                <div class="range-percentage">{{ "%.1f"|format(class_stats.score_ranges['ä¸­ç­‰'] / class_stats.total_students * 100) }}%</div>
              </div>
              <div class="score-range poor">
                <div class="range-label">å¾…æ”¹é€² ({{ (exam.max_score * 0.6)|round|int }}-{{ (exam.max_score * 0.7 - 1)|round|int }})</div>
                <div class="range-count">{{ class_stats.score_ranges['å¾…æ”¹é€²'] }}</div>
                <div class="range-percentage">{{ "%.1f"|format(class_stats.score_ranges['å¾…æ”¹é€²'] / class_stats.total_students * 100) }}%</div>
              </div>
              <div class="score-range fail">
                <div class="range-label">éœ€è¦åŠ å¼· (0-{{ (exam.max_score * 0.6 - 1)|round|int }})</div>
                <div class="range-count">{{ class_stats.score_ranges['éœ€è¦åŠ å¼·'] }}</div>
                <div class="range-percentage">{{ "%.1f"|format(class_stats.score_ranges['éœ€è¦åŠ å¼·'] / class_stats.total_students * 100) }}%</div>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- æˆç¸¾è¶¨å‹¢åœ– -->
        <div class="card">
          <h2>ğŸ“‰ æˆç¸¾è¶¨å‹¢åˆ†æ</h2>
          <div class="chart-container small">
            <canvas id="scoreTrendChart"></canvas>
          </div>
        </div>

        <!-- å­¸ç¿’æ´å¯Ÿ -->
        <div class="card">
          <h2>ğŸ” å­¸ç¿’æ´å¯Ÿ</h2>
          <div class="insights">
            <h3>æ•´é«”è¡¨ç¾åˆ†æ</h3>
            <ul>
              {% if class_stats.avg_score >= 80 %}
                <li>å…¨ç­å¹³å‡åˆ†æ•¸è¡¨ç¾å„ªç§€ï¼Œå­¸ç¿’æ•ˆæœè‰¯å¥½</li>
              {% elif class_stats.avg_score >= 70 %}
                <li>å…¨ç­å¹³å‡åˆ†æ•¸ä¸­ç­‰ï¼Œæœ‰é€²æ­¥ç©ºé–“</li>
              {% else %}
                <li>å…¨ç­å¹³å‡åˆ†æ•¸åä½ï¼Œéœ€è¦åŠ å¼·å­¸ç¿’</li>
              {% endif %}
              
              {% if class_stats.pass_rate >= 80 %}
                <li>åŠæ ¼ç‡è¼ƒé«˜ï¼Œå¤§éƒ¨åˆ†å­¸ç”ŸæŒæ¡åŸºæœ¬æ¦‚å¿µ</li>
              {% elif class_stats.pass_rate >= 60 %}
                <li>åŠæ ¼ç‡ä¸­ç­‰ï¼Œéƒ¨åˆ†å­¸ç”Ÿéœ€è¦é¡å¤–è¼”å°</li>
              {% else %}
                <li>åŠæ ¼ç‡åä½ï¼Œå»ºè­°é‡æ–°æª¢è¦–æ•™å­¸å…§å®¹</li>
              {% endif %}
              
              {% if class_stats.std_dev <= 10 %}
                <li>æˆç¸¾åˆ†å¸ƒè¼ƒç‚ºé›†ä¸­ï¼Œå­¸ç”Ÿç¨‹åº¦ç›¸è¿‘</li>
              {% elif class_stats.std_dev <= 20 %}
                <li>æˆç¸¾åˆ†å¸ƒé©ä¸­ï¼Œå­˜åœ¨ä¸€å®šå·®ç•°</li>
              {% else %}
                <li>æˆç¸¾åˆ†å¸ƒè¼ƒç‚ºåˆ†æ•£ï¼Œå­¸ç”Ÿç¨‹åº¦å·®ç•°è¼ƒå¤§</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>

      <!-- å€‹äººå­¸ç¿’å»ºè­° -->
      <div class="card">
        <h2>ğŸ¯ å€‹äººå­¸ç¿’å»ºè­°</h2>
        <p style="color: #6b7280; margin-bottom: 16px;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŸ¥çœ‹æ¯ä½å­¸ç”Ÿçš„å€‹äººåŒ–å­¸ç¿’å»ºè­°</p>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
          {% for result in grading_results %}
            <a href="{{ url_for('student_detail', exam_id=exam.exam_id, student_id=result.student_id, result_id=result.result_id) }}" 
               class="btn" 
               style="text-decoration: none; justify-content: center;">
              {{ result.student_id }} ({{ result.final_score }}åˆ†)
            </a>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div class="card">
        <div class="empty-state">
          <h3>é‚„æ²’æœ‰åˆ†ææ•¸æ“š</h3>
          <p>è«‹å…ˆå®Œæˆæ‰¹æ”¹æµç¨‹ï¼Œç„¶å¾Œå†æŸ¥çœ‹åˆ†æçµæœ</p>
          <a href="{{ url_for('exam_detail', exam_id=exam.exam_id) }}" class="btn">è¿”å›è€ƒè©¦è©³æƒ…</a>
        </div>
      </div>
    {% endif %}
  </div>

  {% if class_stats %}
  <script>
    // æˆç¸¾åˆ†å¸ƒåœ–
    const scoreDistributionCtx = document.getElementById('scoreDistributionChart').getContext('2d');
    
    // æ ¹æ“šè€ƒè©¦æ»¿åˆ†å‹•æ…‹è¨­ç½®åœ–è¡¨æ•¸æ“š
    {% if exam.max_score <= 10 %}
      const chartLabels = [
        'å„ªç§€ ({{ (exam.max_score * 0.9)|round|int }}-{{ exam.max_score }})',
        'è‰¯å¥½ ({{ (exam.max_score * 0.8)|round|int }}-{{ (exam.max_score * 0.9 - 0.1)|round|int }})',
        'ä¸­ç­‰ ({{ (exam.max_score * 0.7)|round|int }}-{{ (exam.max_score * 0.8 - 0.1)|round|int }})',
        'å¾…æ”¹é€² ({{ (exam.max_score * 0.6)|round|int }}-{{ (exam.max_score * 0.7 - 0.1)|round|int }})',
        'éœ€è¦åŠ å¼· (0-{{ (exam.max_score * 0.6 - 0.1)|round|int }})'
      ];
      const chartData = [
        {{ class_stats.score_ranges['å„ªç§€'] }},
        {{ class_stats.score_ranges['è‰¯å¥½'] }},
        {{ class_stats.score_ranges['ä¸­ç­‰'] }},
        {{ class_stats.score_ranges['å¾…æ”¹é€²'] }},
        {{ class_stats.score_ranges['éœ€è¦åŠ å¼·'] }}
      ];
    {% else %}
      const chartLabels = [
        'å„ªç§€ ({{ (exam.max_score * 0.9)|round|int }}-{{ exam.max_score }})',
        'è‰¯å¥½ ({{ (exam.max_score * 0.8)|round|int }}-{{ (exam.max_score * 0.9 - 1)|round|int }})',
        'ä¸­ç­‰ ({{ (exam.max_score * 0.7)|round|int }}-{{ (exam.max_score * 0.8 - 1)|round|int }})',
        'å¾…æ”¹é€² ({{ (exam.max_score * 0.6)|round|int }}-{{ (exam.max_score * 0.7 - 1)|round|int }})',
        'éœ€è¦åŠ å¼· (0-{{ (exam.max_score * 0.6 - 1)|round|int }})'
      ];
      const chartData = [
        {{ class_stats.score_ranges['å„ªç§€'] }},
        {{ class_stats.score_ranges['è‰¯å¥½'] }},
        {{ class_stats.score_ranges['ä¸­ç­‰'] }},
        {{ class_stats.score_ranges['å¾…æ”¹é€²'] }},
        {{ class_stats.score_ranges['éœ€è¦åŠ å¼·'] }}
      ];
    {% endif %}
    
    new Chart(scoreDistributionCtx, {
      type: 'doughnut',
      data: {
        labels: chartLabels,
        datasets: [{
          data: chartData,
          backgroundColor: [
            '#10b981',
            '#3b82f6',
            '#f59e0b',
            '#ef4444',
            '#6b7280'
          ],
          borderWidth: 2,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = {{ class_stats.total_students }};
                const percentage = ((context.parsed / total) * 100).toFixed(1);
                return context.label + ': ' + context.parsed + 'äºº (' + percentage + '%)';
              }
            }
          }
        }
      }
    });

    // æˆç¸¾è¶¨å‹¢åœ–ï¼ˆç›´æ–¹åœ–ï¼‰
    const scoreTrendCtx = document.getElementById('scoreTrendChart').getContext('2d');
    const scores = {{ class_stats.scores | tojson }};
    const maxScore = {{ exam.max_score }};
    
    // æ ¹æ“šè€ƒè©¦æ»¿åˆ†å‹•æ…‹å‰µå»ºåˆ†çµ„æ•¸æ“š
    const bins = [];
    const binLabels = [];
    
    {% if exam.max_score <= 10 %}
      // å°åˆ†æ•¸è€ƒè©¦ï¼šæ¯å€‹åˆ†æ•¸ä¸€å€‹å€é–“
      for (let i = 0; i <= maxScore; i++) {
        const count = scores.filter(score => score === i).length;
        bins.push(count);
        binLabels.push(i.toString());
      }
    {% else %}
      // ä¸€èˆ¬æ»¿åˆ†è€ƒè©¦ï¼šä»¥æ»¿åˆ†çš„ 10% ç‚ºä¸€å€‹å€é–“
      const binSize = Math.max(1, Math.floor(maxScore / 10));
      for (let i = 0; i <= maxScore; i += binSize) {
        const binStart = i;
        const binEnd = Math.min(maxScore, i + binSize - 1);
        const count = scores.filter(score => score >= binStart && score <= binEnd).length;
        bins.push(count);
        binLabels.push(binStart + '-' + binEnd);
      }
    {% endif %}
    
    new Chart(scoreTrendCtx, {
      type: 'bar',
      data: {
        labels: binLabels,
        datasets: [{
          label: 'äººæ•¸',
          data: bins,
          backgroundColor: '#4f46e5',
          borderColor: '#4338ca',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          },
          x: {
            {% if exam.max_score <= 10 %}
            title: {
              display: true,
              text: 'åˆ†æ•¸'
            }
            {% else %}
            title: {
              display: true,
              text: 'åˆ†æ•¸å€é–“'
            }
            {% endif %}
          }
        },
        plugins: {
          legend: {
            display: false
          }
        }
      }
    });
  </script>
  {% endif %}
</body>
</html>
