<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>{{ exam.title }} - è€ƒè©¦çµæœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px}
    .wrap{max-width:1200px;margin:0 auto}
    .card{background:#fff;border-radius:14px;padding:24px;box-shadow:0 6px 20px rgba(0,0,0,.06);margin-bottom:24px}
    h1{margin:0 0 8px;font-size:24px;color:#1f2937}
    .exam-meta{color:#6b7280;margin-bottom:20px}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:24px}
    .stat-item{background:#f8fafc;border-radius:8px;padding:16px;text-align:center}
    .stat-number{font-size:24px;font-weight:700;color:#4f46e5;margin:0}
    .stat-label{color:#6b7280;font-size:12px;margin:4px 0 0}
    .btn{display:inline-block;background:#4f46e5;color:#fff;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;text-decoration:none;font-size:14px;font-weight:500;margin-right:8px;margin-bottom:8px}
    .btn:hover{background:#4338ca}
    .btn-success{background:#10b981}
    .btn-success:hover{background:#059669}
    .btn-secondary{background:#6b7280}
    .btn-secondary:hover{background:#4b5563}
    .back-link{display:inline-block;margin-bottom:20px;color:#4f46e5;text-decoration:none}
    .back-link:hover{text-decoration:underline}
    .results-table{width:100%;border-collapse:collapse;margin-top:20px}
    .results-table th,.results-table td{border:1px solid #e5e7eb;padding:12px;text-align:left}
    .results-table thead{background:#f8fafc}
    .results-table th{font-weight:600;color:#374151}
    .results-table tr:nth-child(even){background:#f9fafb}
    .results-table tr:hover{background:#f3f4f6}
    .score{font-weight:600}
    .score-high{color:#10b981}
    .score-medium{color:#f59e0b}
    .score-low{color:#ef4444}
    .empty-state{text-align:center;padding:40px;color:#6b7280}
    .empty-state h3{margin:0 0 8px;color:#374151}
    .empty-state p{margin:0 0 20px}
    .grade-distribution{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
    .grade-range{background:#f8fafc;border-radius:8px;padding:16px;text-align:center}
    .grade-range h4{margin:0 0 8px;color:#374151}
    .grade-count{font-size:24px;font-weight:700;color:#4f46e5}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="{{ url_for('exam_detail', exam_id=exam.exam_id) }}" class="back-link">â† è¿”å›è€ƒè©¦è©³æƒ…</a>
    
    <div class="card">
      <h1>ğŸ“Š {{ exam.title }} - è€ƒè©¦çµæœ</h1>
      <div class="exam-meta">
        ç§‘ç›®ï¼š{{ exam.subject }} | 
        æ»¿åˆ†ï¼š{{ exam.max_score }}åˆ† | 
        æ‰¹æ”¹å®Œæˆæ™‚é–“ï¼š{{ grading_results[0].graded_at.strftime('%Y-%m-%d %H:%M') if grading_results else 'æœªå®Œæˆ' }}
      </div>

      <!-- çµ±è¨ˆè³‡è¨Š -->
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number">{{ grading_results|length }}</div>
          <div class="stat-label">ç¸½äººæ•¸</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ "%.1f"|format(avg_score) }}</div>
          <div class="stat-label">å¹³å‡åˆ†</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ max_score }}</div>
          <div class="stat-label">æœ€é«˜åˆ†</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ min_score }}</div>
          <div class="stat-label">æœ€ä½åˆ†</div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰éˆ• -->
      <div class="actions">
        <a href="{{ url_for('class_analysis', exam_id=exam.exam_id) }}" class="btn">ğŸ“Š å…¨ç­åˆ†æ</a>
        <a href="{{ url_for('export_results', exam_id=exam.exam_id) }}" class="btn btn-success">ğŸ“¥ åŒ¯å‡ºExcel</a>
        <a href="{{ url_for('exam_detail', exam_id=exam.exam_id) }}" class="btn btn-secondary">è¿”å›è©³æƒ…</a>
      </div>

      <!-- æˆç¸¾åˆ†å¸ƒ -->
      {% if grading_results %}
        <div class="grade-distribution">
          {% if exam.max_score <= 10 %}
            <!-- å°åˆ†æ•¸è€ƒè©¦çš„åˆ†å¸ƒ -->
            <div class="grade-range">
              <h4>å„ªç§€ ({{ (exam.max_score * 0.9)|round|int }}-{{ exam.max_score }})</h4>
              <div class="grade-count">{{ grading_results|selectattr('final_score', 'ge', (exam.max_score * 0.9)|round|int)|list|length }}</div>
            </div>
            <div class="grade-range">
              <h4>è‰¯å¥½ ({{ (exam.max_score * 0.8)|round|int }}-{{ (exam.max_score * 0.9 - 0.1)|round|int }})</h4>
              <div class="grade-count">{{ grading_results|selectattr('final_score', 'ge', (exam.max_score * 0.8)|round|int)|selectattr('final_score', 'lt', (exam.max_score * 0.9)|round|int)|list|length }}</div>
            </div>
            <div class="grade-range">
              <h4>ä¸­ç­‰ ({{ (exam.max_score * 0.7)|round|int }}-{{ (exam.max_score * 0.8 - 0.1)|round|int }})</h4>
              <div class="grade-count">{{ grading_results|selectattr('final_score', 'ge', (exam.max_score * 0.7)|round|int)|selectattr('final_score', 'lt', (exam.max_score * 0.8)|round|int)|list|length }}</div>
            </div>
            <div class="grade-range">
              <h4>å¾…æ”¹é€² ({{ (exam.max_score * 0.6)|round|int }}-{{ (exam.max_score * 0.7 - 0.1)|round|int }})</h4>
              <div class="grade-count">{{ grading_results|selectattr('final_score', 'ge', (exam.max_score * 0.6)|round|int)|selectattr('final_score', 'lt', (exam.max_score * 0.7)|round|int)|list|length }}</div>
            </div>
            <div class="grade-range">
              <h4>éœ€è¦åŠ å¼· (0-{{ (exam.max_score * 0.6 - 0.1)|round|int }})</h4>
              <div class="grade-count">{{ grading_results|selectattr('final_score', 'lt', (exam.max_score * 0.6)|round|int)|list|length }}</div>
            </div>
          {% else %}
            <!-- æ¨™æº–100åˆ†åˆ¶è€ƒè©¦çš„åˆ†å¸ƒ -->
            <div class="grade-range">
              <h4>90-100åˆ†</h4>
              <div class="grade-count">{{ grading_results|selectattr('final_score', 'ge', 90)|list|length }}</div>
            </div>
            <div class="grade-range">
              <h4>80-89åˆ†</h4>
              <div class="grade-count">{{ grading_results|selectattr('final_score', 'ge', 80)|selectattr('final_score', 'lt', 90)|list|length }}</div>
            </div>
            <div class="grade-range">
              <h4>70-79åˆ†</h4>
              <div class="grade-count">{{ grading_results|selectattr('final_score', 'ge', 70)|selectattr('final_score', 'lt', 80)|list|length }}</div>
            </div>
            <div class="grade-range">
              <h4>60-69åˆ†</h4>
              <div class="grade-count">{{ grading_results|selectattr('final_score', 'ge', 60)|selectattr('final_score', 'lt', 70)|list|length }}</div>
            </div>
            <div class="grade-range">
              <h4>60åˆ†ä»¥ä¸‹</h4>
              <div class="grade-count">{{ grading_results|selectattr('final_score', 'lt', 60)|list|length }}</div>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <!-- è©³ç´°çµæœè¡¨æ ¼ -->
    <div class="card">
      <h2>è©³ç´°æˆç¸¾</h2>
      {% if grading_results %}
        <table class="results-table">
          <thead>
            <tr>
              <th>å­¸ç”ŸID</th>
              <th>GPTåˆ†æ•¸</th>
              <th>Claudeåˆ†æ•¸</th>
              <th>æœ€çµ‚åˆ†æ•¸</th>
              <th>æ‰¹æ”¹æ™‚é–“</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {% for result in grading_results %}
              <tr>
                <td>{{ result.student_id }}</td>
                <td class="score">{{ result.gpt_score }}</td>
                <td class="score">{{ result.claude_score }}</td>
                <td class="score {% if result.final_score >= 80 %}score-high{% elif result.final_score >= 60 %}score-medium{% else %}score-low{% endif %}">
                  {{ result.final_score }}
                </td>
                <td>{{ result.graded_at.strftime('%m-%d %H:%M') }}</td>
                <td>
                  <a href="{{ url_for('student_detail', exam_id=exam.exam_id, student_id=result.student_id, result_id=result.result_id) }}" class="btn btn-sm">æŸ¥çœ‹è©³æƒ…</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="empty-state">
          <h3>é‚„æ²’æœ‰æ‰¹æ”¹çµæœ</h3>
          <p>è«‹å…ˆå®Œæˆæ‰¹æ”¹æµç¨‹</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- è©³æƒ…æ¨¡æ…‹æ¡† -->
  <div id="detailModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:12px;padding:24px;max-width:800px;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h3>æ‰¹æ”¹è©³æƒ…</h3>
        <button onclick="closeDetail()" style="background:none;border:none;font-size:24px;cursor:pointer">&times;</button>
      </div>
      <div id="detailContent"></div>
    </div>
  </div>

  <script>
    function showDetail(resultId) {
      // é€™è£¡å¯ä»¥é€šéAJAXç²å–è©³ç´°çš„æ‰¹æ”¹çµæœ
      // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘é¡¯ç¤ºä¸€å€‹åŸºæœ¬çš„è©³æƒ…
      const modal = document.getElementById('detailModal');
      const content = document.getElementById('detailContent');
      
      content.innerHTML = `
        <div style="margin-bottom:16px">
          <h4>GPTæ‰¹æ”¹çµæœ</h4>
          <p>åˆ†æ•¸ï¼š${resultId}</p>
        </div>
        <div style="margin-bottom:16px">
          <h4>Claudeæ‰¹æ”¹çµæœ</h4>
          <p>åˆ†æ•¸ï¼š${resultId}</p>
        </div>
        <div>
          <h4>æœ€çµ‚çµæœ</h4>
          <p>åˆ†æ•¸ï¼š${resultId}</p>
        </div>
      `;
      
      modal.style.display = 'block';
    }

    function closeDetail() {
      document.getElementById('detailModal').style.display = 'none';
    }

    // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
    document.getElementById('detailModal').addEventListener('click', (e) => {
      if (e.target.id === 'detailModal') {
        closeDetail();
      }
    });
  </script>
</body>
</html>

