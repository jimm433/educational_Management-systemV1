<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>{{ exam.title }} - è€ƒè©¦è©³æƒ…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px}
    .wrap{max-width:1200px;margin:0 auto}
    .card{background:#fff;border-radius:14px;padding:24px;box-shadow:0 6px 20px rgba(0,0,0,.06);margin-bottom:24px}
    h1{margin:0 0 8px;font-size:24px;color:#1f2937}
    .exam-meta{color:#6b7280;margin-bottom:20px}
    .status{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:500}
    .status-draft{background:#fef3c7;color:#92400e}
    .status-active{background:#dbeafe;color:#1e40af}
    .status-grading{background:#fce7f3;color:#be185d}
    .status-completed{background:#d1fae5;color:#065f46}
    .btn{display:inline-block;background:#4f46e5;color:#fff;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;text-decoration:none;font-size:14px;font-weight:500;margin-right:8px;margin-bottom:8px}
    .btn:hover{background:#4338ca}
    .btn-success{background:#10b981}
    .btn-success:hover{background:#059669}
    .btn-warning{background:#f59e0b}
    .btn-warning:hover{background:#d97706}
    .btn-secondary{background:#6b7280}
    .btn-secondary:hover{background:#4b5563}
    .btn-danger{background:#ef4444}
    .btn-danger:hover{background:#dc2626}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:24px}
    .stat-item{background:#f8fafc;border-radius:8px;padding:16px;text-align:center}
    .stat-number{font-size:24px;font-weight:700;color:#4f46e5;margin:0}
    .stat-label{color:#6b7280;font-size:12px;margin:4px 0 0}
    .section{margin-bottom:24px}
    .section h2{margin:0 0 16px;font-size:18px;color:#1f2937}
    .submission-list{display:grid;gap:12px}
    .submission-item{background:#f8fafc;border-radius:8px;padding:16px;border-left:4px solid #4f46e5}
    .submission-meta{color:#6b7280;font-size:12px;margin-bottom:8px}
    .submission-actions{display:flex;gap:8px;flex-wrap:wrap}
    .empty-state{text-align:center;padding:40px;color:#6b7280}
    .empty-state h3{margin:0 0 8px;color:#374151}
    .empty-state p{margin:0 0 20px}
    .back-link{display:inline-block;margin-bottom:20px;color:#4f46e5;text-decoration:none}
    .back-link:hover{text-decoration:underline}
    .alert{padding:12px 16px;border-radius:8px;margin-bottom:20px}
    .alert-info{background:#eff6ff;color:#1e40af;border-left:4px solid #3b82f6}
    .alert-warning{background:#fffbeb;color:#92400e;border-left:4px solid #f59e0b}
    .alert-success{background:#f0fdf4;color:#16a34a;border-left:4px solid #10b981}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="{{ url_for('dashboard') }}" class="back-link">â† è¿”å›å„€è¡¨æ¿</a>
    
    <div class="card">
      <h1>{{ exam.title }}</h1>
      <div class="exam-meta">
        ç§‘ç›®ï¼š{{ exam.subject }} | 
        å‰µå»ºæ™‚é–“ï¼š{{ exam.created_at.strftime('%Y-%m-%d %H:%M') }} | 
        ç‹€æ…‹ï¼š<span class="status status-{{ exam.status }}">{{ exam.status }}</span>
        {% if exam.description %}
          <br>æè¿°ï¼š{{ exam.description }}
        {% endif %}
      </div>

      <!-- çµ±è¨ˆè³‡è¨Š -->
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number">{{ total_submissions }}</div>
          <div class="stat-label">æäº¤æ•¸é‡</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ completed_gradings }}</div>
          <div class="stat-label">å·²å®Œæˆæ‰¹æ”¹</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ exam.max_score }}</div>
          <div class="stat-label">æ»¿åˆ†</div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰éˆ• -->
      <div class="section">
        <h2>æ“ä½œ</h2>
        {% if exam.status == 'draft' %}
          <div class="alert alert-info">
            <strong>è€ƒè©¦å·²å‰µå»º</strong> - è«‹ä¸Šå‚³å­¸ç”Ÿç­”æ¡ˆæª”æ¡ˆé–‹å§‹æ‰¹æ”¹
          </div>
          <a href="{{ url_for('upload_answers', exam_id=exam.exam_id) }}" class="btn btn-success">ğŸ“ ä¸Šå‚³å­¸ç”Ÿç­”æ¡ˆ</a>
        {% elif exam.status == 'active' %}
          <div class="alert alert-warning">
            <strong>è€ƒè©¦é€²è¡Œä¸­</strong> - å¯ä»¥ç¹¼çºŒä¸Šå‚³ç­”æ¡ˆæˆ–é–‹å§‹æ‰¹æ”¹
          </div>
          <a href="{{ url_for('upload_answers', exam_id=exam.exam_id) }}" class="btn btn-success">ğŸ“ ä¸Šå‚³æ›´å¤šç­”æ¡ˆ</a>
          <button onclick="startGrading()" class="btn btn-warning">ğŸš€ é–‹å§‹æ‰¹æ”¹</button>
        {% elif exam.status == 'grading' %}
          <div class="alert alert-warning">
            <strong>æ‰¹æ”¹é€²è¡Œä¸­</strong> - è«‹ç¨å€™ï¼Œç³»çµ±æ­£åœ¨è™•ç†...
          </div>
          <button onclick="checkStatus()" class="btn btn-secondary">ğŸ”„ æª¢æŸ¥ç‹€æ…‹</button>
        {% elif exam.status == 'completed' %}
          <div class="alert alert-success">
            <strong>æ‰¹æ”¹å®Œæˆ</strong> - æ‰€æœ‰ç­”æ¡ˆå·²æ‰¹æ”¹å®Œæˆ
          </div>
          <a href="{{ url_for('exam_results', exam_id=exam.exam_id) }}" class="btn btn-success">ğŸ“Š æŸ¥çœ‹çµæœ</a>
          <a href="{{ url_for('export_results', exam_id=exam.exam_id) }}" class="btn btn-secondary">ğŸ“¥ åŒ¯å‡ºExcel</a>
        {% endif %}
      </div>
    </div>

    <!-- æäº¤åˆ—è¡¨ -->
    <div class="card">
      <div class="section">
        <h2>å­¸ç”Ÿæäº¤ ({{ total_submissions }})</h2>
        {% if submissions %}
          <div class="submission-list">
            {% for submission in submissions %}
              <div class="submission-item">
                <div class="submission-meta">
                  å­¸ç”ŸIDï¼š{{ submission.student_id }} | 
                  æª”æ¡ˆï¼š{{ submission.answer_file }} | 
                  æäº¤æ™‚é–“ï¼š{{ submission.submitted_at.strftime('%Y-%m-%d %H:%M') }} | 
                  ç‹€æ…‹ï¼š<span class="status status-{{ submission.status }}">{{ submission.status }}</span>
                </div>
                <div class="submission-actions">
                  {% if submission.status == 'completed' %}
                    <a href="{{ url_for('exam_results', exam_id=exam.exam_id) }}" class="btn btn-sm">æŸ¥çœ‹çµæœ</a>
                  {% elif submission.status == 'failed' %}
                    <span style="color:#dc2626;font-size:12px">æ‰¹æ”¹å¤±æ•—</span>
                  {% else %}
                    <span style="color:#6b7280;font-size:12px">ç­‰å¾…æ‰¹æ”¹</span>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <h3>é‚„æ²’æœ‰å­¸ç”Ÿæäº¤ç­”æ¡ˆ</h3>
            <p>è«‹ä¸Šå‚³å­¸ç”Ÿç­”æ¡ˆæª”æ¡ˆ</p>
            <a href="{{ url_for('upload_answers', exam_id=exam.exam_id) }}" class="btn">ä¸Šå‚³ç­”æ¡ˆ</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    function startGrading() {
      if (!confirm('ç¢ºå®šè¦é–‹å§‹æ‰¹æ”¹å—ï¼Ÿé€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ã€‚')) {
        return;
      }
      
      fetch('{{ url_for("start_grading", exam_id=exam.exam_id) }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert('éŒ¯èª¤ï¼š' + data.message);
        }
      })
      .catch(error => {
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error);
      });
    }

    function checkStatus() {
      location.reload();
    }
  </script>
</body>
</html>

