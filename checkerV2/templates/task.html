<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>æ‰¹æ”¹çµæœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:#fff;border-radius:14px;padding:18px 18px 22px;box-shadow:0 6px 20px rgba(0,0,0,.06);margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    h2{margin:6px 0 10px}
    .score{font-size:34px;color:#16a34a;margin:4px 0 10px}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1020;color:#dbeafe;border-radius:10px;padding:12px;font-size:13px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border:1px solid #e5e7eb;padding:8px;text-align:left}
    .table thead{background:#eef2ff}
    .table .total{background:#fafafa;font-weight:700}
    .muted{color:#777}
    button{padding:8px 14px;border:none;border-radius:8px;background:#4f46e5;color:#fff;font-size:14px;cursor:pointer}
    button:hover{background:#4338ca}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="muted">ä»»å‹™ï¼š{{ task.task_id }} ï½œ ç§‘ç›®ï¼š{{ task.subject }} ï½œ æè©ç‰ˆæœ¬ï¼šv<span id="promptVersion">{{ task.prompt_version }}</span></div>
      <h2>ğŸ¯ ä»²è£å¾Œæœ€çµ‚åˆ†æ•¸</h2>
      <div class="score">{{ "%.2f"|format(task.arbitration.final_score) }}</div>
      <div class="card" style="padding:10px">
        {{ task.arbitration.final_table_html|safe }}
      </div>
      <div class="muted">ä»²è£æ±ºç­–ï¼š{{ task.arbitration.decision }} ï½œ ç†ç”±ï¼š{{ task.arbitration.reason }}</div>
    </div>

    {% if task.weakness_review %}
      <div class="card">
        <h2>ğŸ©º æ•´å·å¼±é»åˆ†æ</h2>
        {% if task.weakness_review.coach_comment %}
          <p><b>æ•™ç·´çŸ­è©•ï¼š</b>{{ task.weakness_review.coach_comment }}</p>
        {% endif %}
        <p class="muted">é¢¨éšªåˆ†æ•¸ï¼š{{ task.weakness_review.risk_score }}</p>

        {% if task.weakness_review.weakness_clusters and task.weakness_review.weakness_clusters|length > 0 %}
          <div class="card" style="padding:10px">
            <table class="table">
              <thead>
                <tr>
                  <th>ä¸»é¡Œ</th>
                  <th>é »æ¬¡</th>
                  <th>ç›¸é—œé¡Œè™Ÿ</th>
                  <th>ä»£è¡¨æ€§ç‰‡èª</th>
                </tr>
              </thead>
              <tbody>
                {% for w in task.weakness_review.weakness_clusters %}
                  <tr>
                    <td>{{ w.topic }}</td>
                    <td style="text-align:center">{{ w.frequency }}</td>
                    <td>{{ (w.evidence_qids or [])|join(", ") }}</td>
                    <td>
                      <div class="muted">
                        {% for s in (w.evidence_snippets or [])[:3] %}
                          <div>â€¢ {{ s }}</div>
                        {% endfor %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}

        {% if task.weakness_review.prioritized_actions and task.weakness_review.prioritized_actions|length > 0 %}
          <h3 style="margin:12px 0 6px">å„ªå…ˆä¿®æ­£è¡Œå‹•</h3>
          <ul>
            {% for a in task.weakness_review.prioritized_actions %}
              <li>
                <b>{{ a.action }}</b>
                {% if a.mapping_topics %}<span class="muted">ï¼ˆ{{ a.mapping_topics|join("ã€") }}ï¼‰</span>{% endif %}
                {% if a.example_fix %}<div class="muted">ä¾‹ï¼š{{ a.example_fix }}</div>{% endif %}
              </li>
            {% endfor %}
          </ul>
        {% endif %}

        {% if task.weakness_review.practice_suggestions and task.weakness_review.practice_suggestions|length > 0 %}
          <h3 style="margin:12px 0 6px">ç·´ç¿’å»ºè­°</h3>
          <ul>
            {% for s in task.weakness_review.practice_suggestions %}
              <li>{{ s }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    {% endif %}

    <div class="grid">
      <div class="card">
        <h2>ğŸ¤– GPT æ‰¹æ”¹ï¼š{{ "%.2f"|format(task.gpt.score) }} åˆ†</h2>
        {% if task.gpt.part4_table %}
        <div class="card" style="padding:10px">{{ task.gpt.part4_table|safe }}</div>
        {% endif %}
        {% if task.gpt.feedback %}
          <pre>{{ task.gpt.feedback }}</pre>
        {% endif %}
      </div>

      <div class="card">
        <h2>ğŸ¤– Claude æ‰¹æ”¹ï¼š{{ "%.2f"|format(task.claude.score) }} åˆ†</h2>
        {% if task.claude.part4_table %}
        <div class="card" style="padding:10px">{{ task.claude.part4_table|safe }}</div>
        {% endif %}
        {% if task.claude.feedback %}
          <pre>{{ task.claude.feedback }}</pre>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <h2>ğŸ§  é»‘æ¿ï¼ˆæœ¬æ¬¡æè©ç›¸é—œç´€éŒ„ï¼‰</h2>
      <div id="bb"></div>
      <div style="margin-top:12px">
        <button onclick="applyPrompt()">å¥—ç”¨å»ºè­°é¡Œè©</button>
        <span id="applyMsg" class="muted"></span>
      </div>
    </div>

    <div><a href="{{ url_for('index', subject=task.subject) }}">â† è¿”å›é¦–é </a></div>
  </div>

  <script>
    let suggestedPrompt = "";

    async function loadBB() {
      const res = await fetch("{{ url_for('api_bb', task_id=task.task_id) }}");
      const data = await res.json();
      const bb = document.getElementById('bb');
      if(!data.length){ 
        bb.innerHTML='<div class="muted">ï¼ˆç„¡æè©ç›¸é—œç´€éŒ„ï¼‰</div>'; 
        return; 
      }
      bb.innerHTML = data.map(x => {
        let highlight = "";
        if(x.type === "suggestion" && x.payload && x.payload.proposed){
          suggestedPrompt = x.payload.proposed || "";
          highlight = `<div style="margin-top:6px;padding:6px;background:#eef2ff;border-radius:6px">
                         <b>Gemini å»ºè­°é¡Œè©ï¼š</b><br><pre style="background:#f8fafc;color:#111;padding:8px;border-radius:6px">${suggestedPrompt}</pre>
                       </div>`;
        }
        return `
          <div style="margin:8px 0;padding:8px;border-left:4px solid #4f46e5;background:#f8fafc;border-radius:8px">
            <div><b>${x.action}</b> ï½œ <span class="muted">${x.timestamp || ''}</span></div>
            <div style="white-space:pre-wrap">${x.content}</div>
            ${highlight}
          </div>
        `;
      }).join('');
    }

    async function applyPrompt(){
      if(!suggestedPrompt){
        document.getElementById('applyMsg').innerText = "âš ï¸ æ²’æœ‰å¯å¥—ç”¨çš„å»ºè­°é¡Œè©";
        return;
      }
      const res = await fetch("{{ url_for('api_prompt_apply') }}", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          subject: "{{ task.subject }}",
          prompt_content: suggestedPrompt,
          task_id: "{{ task.task_id }}"
        })
      });
      const data = await res.json();
      if(data.ok){
        document.getElementById('promptVersion').innerText = data.version;
        document.getElementById('applyMsg').innerText = "âœ… å·²æ›´æ–°ç‚º v"+data.version;
      }else{
        document.getElementById('applyMsg').innerText = "âŒ å¥—ç”¨å¤±æ•—: "+(data.error || "");
      }
    }

    loadBB();
  </script>
</body>
</html>
