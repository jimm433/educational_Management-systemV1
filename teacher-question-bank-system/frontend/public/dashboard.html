<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„€è¡¨æ¿ - æ•™è‚²ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="assets/css/dashboard.css">
    <link rel="stylesheet" href="assets/css/mobile.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body>
    <!-- è¼‰å…¥ç•«é¢ -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <p class="loading-text">è¼‰å…¥ä¸­...</p>
    </div>

    <!-- ä¸»è¦æ‡‰ç”¨ç¨‹å¼ -->
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- å´é‚Šå°èˆªæ¬„ -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="dashboard.html" class="app-logo">
                    <div class="logo-icon">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <rect x="3" y="5" width="14" height="12" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M3 8h14M7 5v-2M13 5v-2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span class="logo-text">æ•™è‚²ç®¡ç†ç³»çµ±</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                    <a href="dashboard.html" class="nav-item active">
                        <svg viewBox="0 0 20 20" fill="none">
                            <rect x="3" y="3" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <rect x="11" y="3" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <rect x="3" y="11" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <rect x="11" y="11" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        <span>å„€è¡¨æ¿</span>
                    </a>
                    <a href="teacher/question.html" class="nav-item" id="navQuestions">
                        <svg viewBox="0 0 20 20" fill="none">
                            <path d="M4 6h12M4 10h12M4 14h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span>é¡Œåº«ç®¡ç†</span>
                    </a>
                    <a href="teacher/exam.html" class="nav-item" id="navExams">
                        <svg viewBox="0 0 20 20" fill="none">
                            <rect x="4" y="3" width="12" height="14" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M7 7h6M7 10h6M7 13h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span>è€ƒè©¦ç®¡ç†</span>
                    </a>
                    <a href="teacher/course.html" class="nav-item" id="navCourses">
                        <svg viewBox="0 0 20 20" fill="none">
                            <path d="M10 3L3 7l7 4 7-4-7-4z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M3 11l7 4 7-4M3 15l7 4 7-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>èª²ç¨‹ç®¡ç†</span>
                    </a>
                    <a href="teacher/grading.html" class="nav-item" id="navGrading">
                        <svg viewBox="0 0 20 20" fill="none">
                            <path d="M5 10l3 3 7-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        <span>ä½œæ¥­æ‰¹æ”¹</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">åˆ†æèˆ‡è¨­å®š</div>
                    <a href="teacher/analytic.html" class="nav-item" id="navAnalytics">
                        <svg viewBox="0 0 20 20" fill="none">
                            <path d="M4 14v-4M10 14V8M16 14v-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span>æ•¸æ“šåˆ†æ</span>
                    </a>
                    <a href="teacher/ai-assistant.html" class="nav-item" id="navAIAssistant">
                        <svg viewBox="0 0 20 20" fill="none">
                            <path d="M10 2L3 6v8l7 4 7-4V6l-7-4z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
                            <path d="M10 6v8M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>AI åŠ©ç†</span>
                    </a>
                    <a href="teacher/setting.html" class="nav-item" id="navSettings">
                        <svg viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M10 2v2M10 16v2M18 10h-2M6 10H4M15.66 4.34l-1.41 1.41M5.75 14.25l-1.41 1.41M15.66 15.66l-1.41-1.41M5.75 5.75L4.34 4.34" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span>ç³»çµ±è¨­å®š</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <div class="main-wrapper">
            <!-- é ‚éƒ¨æ¨™é¡Œæ¬„ -->
            <header class="app-header">
                <h1 class="page-title">å„€è¡¨æ¿</h1>
                <div class="header-actions">
                    <div class="user-menu">
                        <div class="user-info">
                            <div class="user-name" id="userName">è¼‰å…¥ä¸­...</div>
                            <div class="user-role" id="userRole">è¼‰å…¥ä¸­...</div>
                        </div>
                        <div class="user-avatar" id="userAvatar">
                            <span id="avatarText">U</span>
                        </div>
                    </div>
                    <button class="logout-btn" id="logoutBtn">ç™»å‡º</button>
                </div>
            </header>

            <!-- å…§å®¹å€åŸŸ -->
            <main class="main-content">
                <!-- æ­¡è¿æ©«å¹… -->
                <div class="welcome-banner">
                    <div class="welcome-content">
                        <h1>æ­¡è¿å›ä¾†ï¼Œ<span id="welcomeUserName">ä½¿ç”¨è€…</span>ï¼</h1>
                        <p>é€™æ˜¯æ‚¨çš„æ•™è‚²ç®¡ç†ä¸­å¿ƒï¼Œè®“æˆ‘å€‘é–‹å§‹ä»Šå¤©çš„å·¥ä½œ</p>
                    </div>
                </div>

                <!-- çµ±è¨ˆå¡ç‰‡ -->
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon blue">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-number" id="statQuestions">0</div>
                        <div class="stat-label">é¡Œç›®ç¸½æ•¸</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-number" id="statExams">0</div>
                        <div class="stat-label">è€ƒè©¦ç¸½æ•¸</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon orange">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-number" id="statSubmissions">0</div>
                        <div class="stat-label">æäº¤ç¸½æ•¸</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon teal">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-number" id="statStudents">0</div>
                        <div class="stat-label">å­¸ç”Ÿäººæ•¸</div>
                    </div>
                </div>

                <!-- å…§å®¹ç¶²æ ¼ -->
                <div class="content-grid">
                    <!-- æœ€è¿‘æ´»å‹• -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">æœ€è¿‘æ´»å‹•</h2>
                            <a href="#" class="card-action">æŸ¥çœ‹å…¨éƒ¨</a>
                        </div>
                        <div class="card-body">
                            <div class="activity-list" id="activityList">
                                <div class="activity-item">
                                    <div class="activity-icon-wrapper">
                                        <svg viewBox="0 0 20 20" fill="none">
                                            <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm0 0v5l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                        </svg>
                                    </div>
                                    <div class="activity-content">
                                        <div class="activity-title">æˆåŠŸç™»å…¥ç³»çµ±</div>
                                        <div class="activity-time">å‰›å‰›</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³å´æ¬„ -->
                    <div>
                        <!-- å¿«é€Ÿæ“ä½œ -->
                        <div class="card mb-24">
                            <div class="card-header">
                                <h2 class="card-title">å¿«é€Ÿæ“ä½œ</h2>
                            </div>
                            <div class="card-body">
                                <div class="quick-actions-grid" id="quickActionsGrid">
                                    <a href="teacher/question.html" class="quick-action-btn">
                                        <svg viewBox="0 0 24 24" fill="none">
                                            <path d="M12 4v16m8-8H4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                        <span>æ–°å¢é¡Œç›®</span>
                                    </a>
                                    <a href="teacher/exam.html" class="quick-action-btn">
                                        <svg viewBox="0 0 24 24" fill="none">
                                            <rect x="5" y="4" width="14" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
                                            <path d="M9 9h6M9 13h6M9 17h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                        <span>å»ºç«‹è€ƒè©¦</span>
                                    </a>
                                    <a href="teacher/grading.html" class="quick-action-btn">
                                        <svg viewBox="0 0 24 24" fill="none">
                                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <span>æ‰¹æ”¹ä½œæ¥­</span>
                                    </a>
                                    <a href="teacher/analytic.html" class="quick-action-btn">
                                        <svg viewBox="0 0 24 24" fill="none">
                                            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <span>æŸ¥çœ‹åˆ†æ</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- ç³»çµ±ç‹€æ…‹ -->
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">ç³»çµ±ç‹€æ…‹</h2>
                            </div>
                            <div class="card-body">
                                <div class="status-list">
                                    <div class="status-item">
                                        <span class="status-label">Firebase é€£æ¥</span>
                                        <span class="status-value" id="firebaseStatus">
                                            <span class="status-indicator"></span> æ­£å¸¸
                                        </span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">è³‡æ–™åº«ç‹€æ…‹</span>
                                        <span class="status-value" id="databaseStatus">
                                            <span class="status-indicator"></span> æ­£å¸¸
                                        </span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">ä¸Šæ¬¡ç™»å…¥</span>
                                        <span class="status-value" id="lastLoginTime">è¼‰å…¥ä¸­...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // å…¨åŸŸè®Šæ•¸
        let dashboardUser = null;
        let dashboardUserRole = null;

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“‹ å„€è¡¨æ¿é é¢è¼‰å…¥ä¸­...');
            initializeDashboard();
        });

        // åˆå§‹åŒ–å„€è¡¨æ¿
        async function initializeDashboard() {
            try {
                console.log('ğŸ”„ é–‹å§‹åˆå§‹åŒ–å„€è¡¨æ¿...');

                // æª¢æŸ¥ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹
                await checkDashboardAuthState();

                // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
                await loadDashboardUserData();

                // è¼‰å…¥çµ±è¨ˆè³‡æ–™
                await loadDashboardStatistics();

                // è¼‰å…¥å¿«é€Ÿæ“ä½œ
                loadDashboardQuickActions();

                // è¼‰å…¥æœ€è¿‘æ´»å‹•
                await loadDashboardRecentActivity();

                // æª¢æŸ¥ç³»çµ±ç‹€æ…‹
                checkDashboardSystemStatus();

                // éš±è—è¼‰å…¥ç•«é¢ï¼Œé¡¯ç¤ºä¸»å…§å®¹
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';

                console.log('âœ… å„€è¡¨æ¿åˆå§‹åŒ–å®Œæˆ');

            } catch (error) {
                console.error('âŒ å„€è¡¨æ¿åˆå§‹åŒ–å¤±æ•—:', error);
                showErrorAndRedirect('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥', 'index.html');
            }
        }

        // æª¢æŸ¥èº«ä»½é©—è­‰ç‹€æ…‹
        function checkDashboardAuthState() {
            return new Promise((resolve, reject) => {
                if (typeof firebase === 'undefined') {
                    reject(new Error('Firebase æœªè¼‰å…¥'));
                    return;
                }

                firebase.auth().onAuthStateChanged(function(user) {
                    if (user) {
                        dashboardUser = user;
                        console.log('âœ… ä½¿ç”¨è€…å·²ç™»å…¥:', user.email);
                        resolve(user);
                    } else {
                        console.log('âŒ ä½¿ç”¨è€…æœªç™»å…¥ï¼Œé‡å°å‘åˆ°ç™»å…¥é é¢');
                        window.location.href = 'index.html';
                        reject(new Error('ä½¿ç”¨è€…æœªç™»å…¥'));
                    }
                });
            });
        }

        // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
        async function loadDashboardUserData() {
            try {
                if (!dashboardUser) {
                    throw new Error('ç„¡ä½¿ç”¨è€…è³‡è¨Š');
                }

                console.log('ğŸ“ è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™:', dashboardUser.uid);

                // æª¢æŸ¥ Firebase æ˜¯å¦æ­£ç¢ºåˆå§‹åŒ–
                if (typeof db === 'undefined' || !db) {
                    throw new Error('Firebase Firestore æœªåˆå§‹åŒ–');
                }

                // é¦–å…ˆå˜—è©¦å¾ user_settings è¼‰å…¥è‡ªè¨‚åç¨±
                let displayName = dashboardUser.displayName || dashboardUser.email;
                let userPhotoURL = dashboardUser.photoURL;

                try {
                    const settingsDoc = await db.collection('user_settings').doc(dashboardUser.uid).get();
                    if (settingsDoc.exists) {
                        const settings = settingsDoc.data();
                        if (settings.profile && settings.profile.displayName) {
                            displayName = settings.profile.displayName;
                        }
                    }
                } catch (settingsError) {
                    console.log('âš ï¸ ç„¡æ³•è¼‰å…¥è‡ªè¨‚è¨­å®šï¼Œä½¿ç”¨é è¨­åç¨±:', settingsError);
                }

                // è¼‰å…¥ä½¿ç”¨è€…åŸºæœ¬è³‡æ–™
                console.log('ğŸ“¥ æ­£åœ¨å¾ Firestore è¼‰å…¥ä½¿ç”¨è€…æ–‡æª”...');
                const userDoc = await db.collection('users').doc(dashboardUser.uid).get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    dashboardUserRole = userData.role;

                    console.log('âœ… ä½¿ç”¨è€…è³‡æ–™è¼‰å…¥æˆåŠŸ:', {
                        uid: dashboardUser.uid,
                        email: dashboardUser.email,
                        role: userData.role
                    });

                    // æ›´æ–° UI - å„ªå…ˆä½¿ç”¨è‡ªè¨‚åç¨±
                    document.getElementById('userName').textContent = displayName;
                    document.getElementById('userRole').textContent = userData.role === 'teacher' ? 'æ•™å¸«' : 'å­¸ç”Ÿ';
                    document.getElementById('welcomeUserName').textContent = displayName;

                    // æ›´æ–°é ­åƒ - å„ªå…ˆä½¿ç”¨è‡ªè¨‚é ­åƒ
                    const avatarElement = document.getElementById('userAvatar');
                    if (userPhotoURL) {
                        avatarElement.innerHTML = `<img src="${userPhotoURL}" alt="ä½¿ç”¨è€…é ­åƒ">`;
                    } else {
                        const initial = displayName.charAt(0);
                        document.getElementById('avatarText').textContent = initial;
                    }

                    // è¨­å®šä¸Šæ¬¡ç™»å…¥æ™‚é–“
                    if (userData.lastLoginAt) {
                        const lastLogin = userData.lastLoginAt.toDate();
                        document.getElementById('lastLoginTime').textContent = formatDateTime(lastLogin);
                    }

                    // æ ¹æ“šè§’è‰²é¡¯ç¤ºä¸åŒçš„å°èˆª
                    updateNavigationForRole(userData.role);

                    console.log('âœ… ä½¿ç”¨è€…è³‡æ–™è¼‰å…¥å®Œæˆ');
                } else {
                    // ä½¿ç”¨è€…è³‡æ–™ä¸å­˜åœ¨ï¼Œå˜—è©¦è‡ªå‹•å‰µå»º
                    console.warn('âš ï¸ æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™ï¼Œå˜—è©¦è‡ªå‹•å‰µå»º...');
                    await createMissingUserData(dashboardUser);

                    // é‡æ–°è¼‰å…¥
                    console.log('ğŸ”„ é‡æ–°è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™...');
                    return await loadDashboardUserData();
                }
            } catch (error) {
                console.error('âŒ è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:', error);
                console.error('ğŸ“‹ éŒ¯èª¤è©³æƒ…:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                throw error;
            }
        }

        // è‡ªå‹•å‰µå»ºç¼ºå¤±çš„ä½¿ç”¨è€…è³‡æ–™
        async function createMissingUserData(user) {
            try {
                console.log('ğŸ”§ æ­£åœ¨å‰µå»ºä½¿ç”¨è€…è³‡æ–™...');

                const userData = {
                    email: user.email,
                    displayName: user.displayName || user.email.split('@')[0],
                    role: 'teacher', // é è¨­ç‚ºæ•™å¸«
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                    photoURL: user.photoURL || null
                };

                await db.collection('users').doc(user.uid).set(userData);
                console.log('âœ… ä½¿ç”¨è€…è³‡æ–™å‰µå»ºæˆåŠŸ');

                return userData;
            } catch (error) {
                console.error('âŒ å‰µå»ºä½¿ç”¨è€…è³‡æ–™å¤±æ•—:', error);
                throw new Error('ç„¡æ³•å‰µå»ºä½¿ç”¨è€…è³‡æ–™ï¼š' + error.message);
            }
        }

        // æ ¹æ“šè§’è‰²æ›´æ–°å°èˆª
        function updateNavigationForRole(role) {
            if (role === 'student') {
                // æ›´æ–°å°èˆªé€£çµç‚ºå­¸ç”Ÿç‰ˆæœ¬
                document.getElementById('navQuestions').href = 'student/exam.html';
                document.getElementById('navQuestions').querySelector('span').textContent = 'åƒåŠ è€ƒè©¦';

                document.getElementById('navExams').href = 'student/course.html';
                document.getElementById('navExams').querySelector('span').textContent = 'æˆ‘çš„èª²ç¨‹';

                document.getElementById('navCourses').href = 'student/assignment.html';
                document.getElementById('navCourses').querySelector('span').textContent = 'æˆ‘çš„ä½œæ¥­';

                document.getElementById('navGrading').href = 'student/result.html';
                document.getElementById('navGrading').querySelector('span').textContent = 'æŸ¥çœ‹æˆç¸¾';

                document.getElementById('navAnalytics').href = 'student/profile.html';
                document.getElementById('navAnalytics').querySelector('span').textContent = 'å€‹äººæª”æ¡ˆ';

                document.getElementById('navSettings').style.display = 'none';
            }
        }

        // è¼‰å…¥çµ±è¨ˆè³‡æ–™
        async function loadDashboardStatistics() {
            try {
                if (dashboardUserRole === 'teacher') {
                    // æ•™å¸«çµ±è¨ˆ
                    const [questionsSnapshot, examsSnapshot, resultsSnapshot] = await Promise.all([
                        db.collection('questions').where('createdBy', '==', dashboardUser.uid).get(),
                        db.collection('exams').where('createdBy', '==', dashboardUser.uid).get(),
                        db.collection('examResults').where('teacherId', '==', dashboardUser.uid).get()
                    ]);

                    document.getElementById('statQuestions').textContent = questionsSnapshot.size;
                    document.getElementById('statExams').textContent = examsSnapshot.size;
                    document.getElementById('statSubmissions').textContent = resultsSnapshot.size;
                    document.getElementById('statStudents').textContent = new Set(resultsSnapshot.docs.map(doc => doc.data().studentId)).size;

                } else {
                    // å­¸ç”Ÿçµ±è¨ˆ
                    const resultsSnapshot = await db.collection('examResults')
                        .where('studentId', '==', dashboardUser.uid)
                        .get();

                    let totalScore = 0;
                    let totalMaxScore = 0;
                    let completedExams = resultsSnapshot.size;

                    resultsSnapshot.forEach(doc => {
                        const result = doc.data();
                        totalScore += result.score || 0;
                        totalMaxScore += result.totalPoints || 0;
                    });

                    const averageScore = totalMaxScore > 0 ? Math.round((totalScore / totalMaxScore) * 100) : 0;

                    document.getElementById('statQuestions').textContent = completedExams;
                    document.querySelector('#statQuestions').nextElementSibling.textContent = 'å®Œæˆè€ƒè©¦';

                    document.getElementById('statExams').textContent = averageScore + '%';
                    document.querySelector('#statExams').nextElementSibling.textContent = 'å¹³å‡åˆ†æ•¸';

                    document.getElementById('statSubmissions').textContent = totalScore;
                    document.querySelector('#statSubmissions').nextElementSibling.textContent = 'ç¸½å¾—åˆ†';

                    document.getElementById('statStudents').textContent = 'A';
                    document.querySelector('#statStudents').nextElementSibling.textContent = 'å¹³å‡ç­‰ç´š';
                }

                console.log('âœ… çµ±è¨ˆè³‡æ–™è¼‰å…¥å®Œæˆ');

            } catch (error) {
                console.error('âŒ è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥å¿«é€Ÿæ“ä½œ
        function loadDashboardQuickActions() {
            const quickActionsGrid = document.getElementById('quickActionsGrid');

            if (dashboardUserRole === 'student') {
                quickActionsGrid.innerHTML = `
                    <a href="student/exam.html" class="quick-action-btn">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>åƒåŠ è€ƒè©¦</span>
                    </a>
                    <a href="student/course.html" class="quick-action-btn">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>æˆ‘çš„èª²ç¨‹</span>
                    </a>
                    <a href="student/assignment.html" class="quick-action-btn">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>æˆ‘çš„ä½œæ¥­</span>
                    </a>
                    <a href="student/result.html" class="quick-action-btn">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>æŸ¥çœ‹æˆç¸¾</span>
                    </a>
                `;
            }
        }

        // è¼‰å…¥æœ€è¿‘æ´»å‹•
        async function loadDashboardRecentActivity() {
            const activityList = document.getElementById('activityList');

            try {
                const activities = [{
                    title: 'æˆåŠŸç™»å…¥ç³»çµ±',
                    time: new Date()
                }, {
                    title: 'è¼‰å…¥ä½¿ç”¨è€…çµ±è¨ˆè³‡æ–™',
                    time: new Date(Date.now() - 60000)
                }];

                activityList.innerHTML = activities.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon-wrapper">
                            <svg viewBox="0 0 20 20" fill="none">
                                <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm0 0v5l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-time">${formatTimeAgo(activity.time)}</div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('âŒ è¼‰å…¥æ´»å‹•è¨˜éŒ„å¤±æ•—:', error);
            }
        }

        // æª¢æŸ¥ç³»çµ±ç‹€æ…‹
        function checkDashboardSystemStatus() {
            // è³‡æ–™åº«ç‹€æ…‹
            if (typeof db !== 'undefined') {
                db.collection('test').limit(1).get()
                    .then(() => {
                        console.log('âœ… è³‡æ–™åº«é€£æ¥æ­£å¸¸');
                    })
                    .catch(() => {
                        const statusIndicator = document.querySelector('#databaseStatus .status-indicator');
                        statusIndicator.classList.add('warning');
                        document.getElementById('databaseStatus').innerHTML = '<span class="status-indicator warning"></span>ç•°å¸¸';
                    });
            }
        }

        // ç™»å‡ºåŠŸèƒ½
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await firebase.auth().signOut();
                console.log('âœ… ç™»å‡ºæˆåŠŸ');
                window.location.href = 'index.html';
            } catch (error) {
                console.error('âŒ ç™»å‡ºå¤±æ•—:', error);
                alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        });

        // éŒ¯èª¤è™•ç†å’Œé‡å°å‘
        function showErrorAndRedirect(message, redirectUrl) {
            alert(message);
            setTimeout(() => {
                window.location.href = redirectUrl;
            }, 2000);
        }

        // å·¥å…·å‡½æ•¸
        function formatDateTime(date) {
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);

            if (minutes < 1) return 'å‰›å‰›';
            if (minutes < 60) return `${minutes} åˆ†é˜å‰`;

            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} å°æ™‚å‰`;

            const days = Math.floor(hours / 24);
            return `${days} å¤©å‰`;
        }
    </script>

    <!-- æ‰‹æ©Ÿé¸å–®æ§åˆ¶ -->
    <script src="assets/js/mobile-menu.js"></script>
</body>

</html>