<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½œæ¥­æ‰¹æ”¹ - æ•™è‚²ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="../assets/css/dashboard.css?v=4">
    <link rel="stylesheet" href="../assets/css/teacher.css?v=4">
    <link rel="stylesheet" href="../assets/css/teacher-question.css?v=4">
    <link rel="stylesheet" href="../assets/css/layout-fix.css?v=4">
    <link rel="stylesheet" href="../assets/css/mobile.css">
    <link rel="stylesheet" href="../assets/css/grading-mobile.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body>
    <!-- è¼‰å…¥ç•«é¢ -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <p class="loading-text">è¼‰å…¥ä½œæ¥­æ‰¹æ”¹ä¸­...</p>
    </div>

    <!-- ä¸»è¦æ‡‰ç”¨ç¨‹å¼ -->
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- å´é‚Šå°èˆªæ¬„ -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../dashboard.html" class="app-logo">
                    <div class="logo-icon">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <rect x="3" y="5" width="14" height="12" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M3 8h14M7 5v-2M13 5v-2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span class="logo-text">æ•™è‚²ç®¡ç†ç³»çµ±</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                    <a href="../dashboard.html" class="nav-item">
                        <svg viewBox="0 0 20 20" fill="none">
                            <rect x="3" y="3" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <rect x="11" y="3" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <rect x="3" y="11" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <rect x="11" y="11" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        <span>å„€è¡¨æ¿</span>
                    </a>
                    <a href="question.html" class="nav-item">
                        <svg viewBox="0 0 20 20" fill="none">
                            <path d="M4 6h12M4 10h12M4 14h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span>é¡Œåº«ç®¡ç†</span>
                    </a>
                    <a href="exam.html" class="nav-item">
                        <svg viewBox="0 0 20 20" fill="none">
                            <rect x="4" y="3" width="12" height="14" rx="1" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M7 7h6M7 10h6M7 13h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span>è€ƒè©¦ç®¡ç†</span>
                    </a>
                    <a href="course.html" class="nav-item">
                        <svg viewBox="0 0 20 20" fill="none">
                            <path d="M10 3L3 7l7 4 7-4-7-4z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M3 11l7 4 7-4M3 15l7 4 7-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>èª²ç¨‹ç®¡ç†</span>
                    </a>
                    <a href="grading.html" class="nav-item active">
                        <svg viewBox="0 0 20 20" fill="none">
                            <path d="M5 10l3 3 7-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        <span>ä½œæ¥­æ‰¹æ”¹</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">åˆ†æèˆ‡è¨­å®š</div>
                    <a href="analytic.html" class="nav-item">
                        <svg viewBox="0 0 20 20" fill="none">
                            <path d="M4 14v-4M10 14V8M16 14v-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span>æ•¸æ“šåˆ†æ</span>
                    </a>
                    <a href="ai-assistant.html" class="nav-item">
                        <svg viewBox="0 0 20 20" fill="none">
                            <path d="M10 2L3 7v6l7 5 7-5V7l-7-5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M10 12V8M8 10h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span>AI å­¸ç¿’åŠ©æ‰‹</span>
                    </a>
                    <a href="setting.html" class="nav-item">
                        <svg viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M10 2v2M10 16v2M18 10h-2M6 10H4M15.66 4.34l-1.41 1.41M5.75 14.25l-1.41 1.41M15.66 15.66l-1.41-1.41M5.75 5.75L4.34 4.34" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span>ç³»çµ±è¨­å®š</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <div class="main-wrapper">
            <!-- é ‚éƒ¨æ¨™é¡Œæ¬„ -->
            <header class="app-header">
                <div class="header-content">
                    <div class="breadcrumb">
                        <a href="../dashboard.html">å„€è¡¨æ¿</a>
                        <span class="breadcrumb-separator">/</span>
                        <span>ä½œæ¥­æ‰¹æ”¹</span>
                    </div>
                    <div class="user-menu">
                        <div class="user-info">
                            <div class="user-name" id="userName">æ•™å¸«</div>
                            <div class="user-role">æ•™å¸«</div>
                        </div>
                        <button class="logout-btn" id="logoutBtn">ç™»å‡º</button>
                    </div>
                </div>
            </header>

            <!-- å…§å®¹å€åŸŸ -->
            <main class="main-content">
                <!-- é é¢æ¨™é¡Œ -->
                <div class="page-header">
                    <h1 class="page-title">ä½œæ¥­æ‰¹æ”¹</h1>
                    <p class="page-subtitle">ä½¿ç”¨ AI æ™ºèƒ½æ‰¹æ”¹å’Œæ‰‹å‹•æ‰¹æ”¹å­¸ç”Ÿä½œæ¥­</p>
                </div>

                <!-- çµ±è¨ˆå¡ç‰‡ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon blue">
                                <svg viewBox="0 0 20 20" fill="none">
                                    <rect x="4" y="3" width="12" height="14" rx="1" stroke="currentColor" stroke-width="1.5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-number" id="totalSubmissions">0</div>
                        <div class="stat-label">ç¸½æäº¤æ•¸</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon orange">
                                <svg viewBox="0 0 20 20" fill="none">
                                    <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.5"/>
                                    <path d="M10 6v4l3 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-number" id="pendingCount">0</div>
                        <div class="stat-label">å¾…æ‰¹æ”¹</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green">
                                <svg viewBox="0 0 20 20" fill="none">
                                    <path d="M5 10l3 3 7-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-number" id="completedCount">0</div>
                        <div class="stat-label">å·²å®Œæˆ</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon purple">
                                <svg viewBox="0 0 20 20" fill="none">
                                    <path d="M10 3v14M3 10h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-number" id="averageScore">0</div>
                        <div class="stat-label">å¹³å‡åˆ†æ•¸</div>
                    </div>
                </div>

                <!-- å·¥å…·æ¬„ -->
                <div class="toolbar">
                    <div class="toolbar-section">
                        <div class="search-container">
                            <div class="search-input-group">
                                <svg class="search-icon" viewBox="0 0 20 20" fill="none">
                                    <path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16zM19 19l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <input type="text" id="searchInput" class="search-input" placeholder="æœå°‹å­¸ç”Ÿå§“åã€ä½œæ¥­æ¨™é¡Œ...">
                            </div>
                        </div>
                    </div>

                    <div class="toolbar-section">
                        <div class="filter-group">
                            <select id="statusFilter" class="filter-select" onchange="applyFilters()">
                                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                                <option value="pending">å¾…æ‰¹æ”¹</option>
                                <option value="grading">æ‰¹æ”¹ä¸­</option>
                                <option value="completed">å·²å®Œæˆ</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="batchAIGrading()">
                            <svg viewBox="0 0 20 20" fill="none" style="width: 16px; height: 16px;">
                                <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M10 6v4l3 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            æ‰¹é‡ AI æ‰¹æ”¹
                        </button>
                    </div>
                </div>

                <!-- ä½œæ¥­åˆ—è¡¨ -->
                <div class="content-card">
                    <div class="assignments-list" id="assignmentsList">
                        <!-- ä½œæ¥­é …ç›®å°‡å‹•æ…‹è¼‰å…¥ -->
                    </div>

                    <div class="empty-state" id="emptyState" style="display: none;">
                        <div class="empty-icon">
                            <svg viewBox="0 0 80 80" fill="none" style="width: 80px; height: 80px; stroke: #cbd5e0;">
                                <path d="M20 40l12 12 28-28" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="40" cy="40" r="30" stroke="currentColor" stroke-width="3"/>
                            </svg>
                        </div>
                        <h3>æ²’æœ‰å¾…æ‰¹æ”¹çš„ä½œæ¥­</h3>
                        <p>æ‰€æœ‰ä½œæ¥­éƒ½å·²æ‰¹æ”¹å®Œæˆï¼Œæˆ–è€…é‚„æ²’æœ‰å­¸ç”Ÿæäº¤ä½œæ¥­</p>
                    </div>

                    <!-- åˆ†é  -->
                    <div class="pagination" id="pagination" style="display: none;">
                        <button class="pagination-btn" id="prevPage">â€¹ ä¸Šä¸€é </button>
                        <div class="page-numbers" id="pageNumbers"></div>
                        <button class="pagination-btn" id="nextPage">ä¸‹ä¸€é  â€º</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- æŸ¥çœ‹è©³æƒ…æ¨¡æ…‹æ¡† -->
    <div class="modal" id="detailModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">ä½œæ¥­è©³æƒ…</h2>
                <button class="modal-close" onclick="closeDetailModal()">
                    <svg viewBox="0 0 20 20" fill="none">
                        <path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="detailModalBody">
                <!-- å‹•æ…‹å…§å®¹ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetailModal()">é—œé–‰</button>
                <button class="btn btn-primary" onclick="openEditModalFromDetail()">ç·¨è¼¯æ‰¹æ”¹</button>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯æ‰¹æ”¹æ¨¡æ…‹æ¡† -->
    <div class="modal" id="editModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">ç·¨è¼¯æ‰¹æ”¹</h2>
                <button class="modal-close" onclick="closeEditModal()">
                    <svg viewBox="0 0 20 20" fill="none">
                        <path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="form-group">
                        <label class="form-label">å­¸ç”Ÿå§“å</label>
                        <input type="text" class="form-input" id="editStudentName" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ä½œæ¥­æ¨™é¡Œ</label>
                        <input type="text" class="form-input" id="editAssignmentTitle" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å­¸ç”Ÿç­”æ¡ˆ</label>
                        <textarea class="form-textarea" id="editStudentAnswer" rows="6" readonly></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ‰¹æ”¹è©•èª</label>
                        <textarea class="form-textarea" id="editFeedback" rows="6" placeholder="è¼¸å…¥æ‰¹æ”¹è©•èª..."></textarea>
                    </div>

                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">åˆ†æ•¸</label>
                            <input type="number" class="form-input" id="editScore" min="0" max="100" placeholder="0-100">
                        </div>

                        <div class="form-group">
                            <label class="form-label">ç‹€æ…‹</label>
                            <select class="form-select" id="editStatus">
                                <option value="pending">å¾…æ‰¹æ”¹</option>
                                <option value="completed">å·²å®Œæˆ</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveGrading()">å„²å­˜æ‰¹æ”¹</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        // åˆå§‹åŒ– Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // å•Ÿç”¨é•·è¼ªè©¢æ¨¡å¼ä»¥æ¸›å°‘ WebChannel 404 éŒ¯èª¤å’Œæ”¹å–„æ€§èƒ½
        db.settings({
            experimentalForceLongPolling: true,
            cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
        });

        // å…¨åŸŸè®Šæ•¸
        let currentUser = null;
        let allSubmissions = [];
        let filteredSubmissions = [];
        let examCache = {}; // è€ƒè©¦è³‡æ–™ç·©å­˜ï¼Œé¿å…é‡è¤‡æŸ¥è©¢
        let lastLoadTime = 0; // æœ€å¾Œè¼‰å…¥æ™‚é–“ï¼Œç”¨æ–¼æ§åˆ¶åˆ·æ–°é »ç‡
        let currentPage = 1;
        const itemsPerPage = 10;

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“ ä½œæ¥­æ‰¹æ”¹é é¢è¼‰å…¥ä¸­... [ç‰ˆæœ¬: 2025-10-29-1330]');
            initializeGradingPage();
        });

        // åˆå§‹åŒ–é é¢
        async function initializeGradingPage() {
            try {
                await checkAuthState();
                await loadSubmissions();
                bindEventListeners();

                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';

                console.log('âœ… ä½œæ¥­æ‰¹æ”¹é é¢åˆå§‹åŒ–å®Œæˆ');

            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±æ•—:', error);
                alert('åˆå§‹åŒ–å¤±æ•—ï¼š' + error.message);
            }
        }

        // æª¢æŸ¥èº«ä»½é©—è­‰ç‹€æ…‹
        function checkAuthState() {
            return new Promise((resolve, reject) => {
                auth.onAuthStateChanged(function(user) {
                    if (user) {
                        console.log('âœ… ä½¿ç”¨è€…å·²ç™»å…¥:', user.email);
                        currentUser = user;
                        document.getElementById('userName').textContent = user.displayName || user.email;
                        resolve(user);
                    } else {
                        console.log('âŒ ä½¿ç”¨è€…æœªç™»å…¥');
                        window.location.href = '../dashboard.html';
                        reject(new Error('æœªç™»å…¥'));
                    }
                });
            });
        }

        // è¼‰å…¥ä½œæ¥­æäº¤
        async function loadSubmissions() {
            try {
                // é˜²æŠ–ï¼šå¦‚æœè·é›¢ä¸Šæ¬¡è¼‰å…¥ä¸åˆ° 3 ç§’ï¼Œè·³é
                const now = Date.now();
                if (now - lastLoadTime < 3000) {
                    console.log('â­ï¸ è·³éé‡è¤‡è¼‰å…¥ï¼ˆè·é›¢ä¸Šæ¬¡è¼‰å…¥ä¸åˆ° 3 ç§’ï¼‰');
                    return;
                }
                lastLoadTime = now;

                console.log('ğŸ“ è¼‰å…¥ä½œæ¥­è³‡æ–™...');

                const snapshot = await db.collection('grading_events')
                    .orderBy('created_at', 'desc')
                    .limit(100)
                    .get();

                // å…ˆæ”¶é›†æ‰€æœ‰ form_idï¼Œæ‰¹æ¬¡è¼‰å…¥è€ƒè©¦è³‡æ–™ï¼ˆä½¿ç”¨ç·©å­˜ï¼‰
                const formIds = [...new Set(snapshot.docs.map(doc => doc.data().form_id).filter(id => id))];
                const examMap = {};

                console.log(`ğŸ“š è¼‰å…¥ ${formIds.length} å€‹è€ƒè©¦çš„èª²ç¨‹è³‡è¨Š...`);
                console.log(`ğŸ“ form_id åˆ—è¡¨:`, formIds.map(id => id.substring(0, 16) + '...'));

                for (const formId of formIds) {
                    console.log(`  ğŸ” è™•ç† formId: ${formId.substring(0, 16)}...`);
                    // å„ªå…ˆå¾ç·©å­˜è®€å–
                    if (examCache[formId]) {
                        examMap[formId] = examCache[formId];
                        continue;
                    }

                    let courseInfo = {
                        courseName: null,
                        courseId: null
                    };

                    try {
                        // æ–¹æ³•1: å¾ exams çš„ googleFormId æŸ¥è©¢
                        console.log(`    ğŸ” æŸ¥è©¢ exams.googleFormId == ${formId.substring(0, 16)}...`);
                        const ex1 = await db.collection('exams')
                            .where('googleFormId', '==', formId)
                            .limit(1)
                            .get();

                        console.log(`    ğŸ“‹ exams.googleFormId æŸ¥è©¢çµæœ: ${ex1.empty ? 'ç©º' : 'æ‰¾åˆ°'}`);
                        if (!ex1.empty) {
                            const examData = ex1.docs[0].data();
                            console.log(`    ğŸ“„ è€ƒè©¦è³‡æ–™:`, Object.keys(examData));
                            courseInfo = {
                                courseName: examData.courseName || null,
                                courseId: examData.courseId || null
                            };
                            console.log(`  âœ… å¾ exams.googleFormId æ‰¾åˆ°: ${formId.substring(0, 12)}... â†’ ${courseInfo.courseName || 'ç„¡'}`);
                        }

                        // æ–¹æ³•2: å¾ exams çš„ formId æŸ¥è©¢
                        if (!courseInfo.courseId) {
                            console.log(`    ğŸ” æŸ¥è©¢ exams.formId == ${formId.substring(0, 16)}...`);
                            const ex2 = await db.collection('exams')
                                .where('formId', '==', formId)
                                .limit(1)
                                .get();

                            console.log(`    ğŸ“‹ exams.formId æŸ¥è©¢çµæœ: ${ex2.empty ? 'ç©º' : 'æ‰¾åˆ°'}`);
                            if (!ex2.empty) {
                                const examData = ex2.docs[0].data();
                                console.log(`    ğŸ“„ è€ƒè©¦è³‡æ–™:`, Object.keys(examData));
                                courseInfo = {
                                    courseName: examData.courseName || null,
                                    courseId: examData.courseId || null
                                };
                                console.log(`  âœ… å¾ exams.formId æ‰¾åˆ°: ${formId.substring(0, 12)}... â†’ ${courseInfo.courseName || 'ç„¡'}`);
                            }
                        }

                        // æ–¹æ³•3: å¾ googleForms æŸ¥è©¢ä¸¦åå‘é—œè¯åˆ° exams
                        if (!courseInfo.courseId) {
                            console.log(`    ğŸ” æŸ¥è©¢ googleForms.formId == ${formId.substring(0, 16)}...`);
                            const gf = await db.collection('googleForms')
                                .where('formId', '==', formId)
                                .limit(1)
                                .get();

                            console.log(`    ğŸ“‹ googleForms æŸ¥è©¢çµæœ: ${gf.empty ? 'ç©º' : 'æ‰¾åˆ°'}`);
                            if (!gf.empty) {
                                const gfData = gf.docs[0].data();
                                console.log(`    ğŸ“„ googleForms è³‡æ–™:`, Object.keys(gfData));

                                // å…ˆå˜—è©¦å¾ googleForms æœ¬èº«å–å¾—èª²ç¨‹è³‡è¨Š
                                const dataSrc = gfData.examData || gfData;
                                courseInfo = {
                                    courseName: dataSrc.courseName || gfData.courseName || null,
                                    courseId: dataSrc.courseId || gfData.courseId || null
                                };

                                // å¦‚æœæ²’æœ‰ï¼Œå˜—è©¦é€é examId åå‘æŸ¥è©¢ exams
                                if (!courseInfo.courseId && gfData.examId) {
                                    console.log(`    ğŸ”„ é€é examId=${gfData.examId} åå‘æŸ¥è©¢ exams...`);
                                    try {
                                        const examDoc = await db.collection('exams').doc(gfData.examId).get();
                                        if (examDoc.exists) {
                                            const examData = examDoc.data();
                                            console.log(`    ğŸ“„ å¾ exams å–å¾—:`, Object.keys(examData));
                                            courseInfo = {
                                                courseName: examData.courseName || null,
                                                courseId: examData.courseId || null
                                            };
                                            console.log(`    âœ… åå‘æŸ¥è©¢æˆåŠŸ â†’ ${courseInfo.courseName || 'ç„¡'}`);
                                        }
                                    } catch (e) {
                                        console.warn(`    âš ï¸ åå‘æŸ¥è©¢å¤±æ•—:`, e);
                                    }
                                }

                                console.log(`  âœ… å¾ googleForms æ‰¾åˆ°: ${formId.substring(0, 12)}... â†’ ${courseInfo.courseName || 'ç„¡'}`);
                            }
                        }

                        if (!courseInfo.courseId) {
                            console.log(`  âš ï¸ æœªæ‰¾åˆ° ${formId.substring(0, 12)}... çš„èª²ç¨‹è³‡è¨Š`);
                        }

                        examMap[formId] = courseInfo;
                        examCache[formId] = courseInfo; // å­˜å…¥ç·©å­˜
                    } catch (err) {
                        console.warn(`âš ï¸ ç„¡æ³•è¼‰å…¥ form ${formId} çš„è€ƒè©¦è³‡æ–™:`, err);
                    }
                }

                allSubmissions = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const formId = data.form_id || data.exam_id;
                    const examInfo = examMap[formId] || {};

                    return {
                        id: doc.id,
                        studentName: data.student_name || data.student_email || 'æœªçŸ¥å­¸ç”Ÿ',
                        studentEmail: data.student_email || '',
                        assignmentTitle: data.form_title || data.subject || 'ä½œæ¥­',
                        submissionTime: (data.created_at && data.created_at.toDate) ? data.created_at.toDate() : new Date(),
                        content: data.preview || 'æŸ¥çœ‹è©³æƒ…',
                        score: (data.arbitration && data.arbitration.final_score) ? data.arbitration.final_score : (data.total_score || 0),
                        totalPoints: 100,
                        status: data.status || 'pending',
                        // ä¿å­˜å®Œæ•´çš„ answers ç‰©ä»¶ï¼ˆç”¨æ–¼é€é¡Œæ‰¹æ”¹ï¼‰
                        answers: data.answers || {},
                        formId: formId,
                        // èª²ç¨‹è³‡è¨Š
                        courseName: examInfo.courseName || null,
                        courseId: examInfo.courseId || null
                    };
                });

                filteredSubmissions = [...allSubmissions];
                renderSubmissions();
                updateStatistics();

                console.log(`âœ… æˆåŠŸè¼‰å…¥ ${allSubmissions.length} å€‹ä½œæ¥­æäº¤`);
                console.log(`ğŸ“Š èª²ç¨‹åˆ†å¸ƒ:`, Object.keys(examMap).length, 'å€‹è€ƒè©¦é—œè¯åˆ°èª²ç¨‹');

            } catch (error) {
                console.error('âŒ è¼‰å…¥ä½œæ¥­å¤±æ•—:', error);
                document.getElementById('assignmentsList').innerHTML = `
                    <div class="empty-state">
                        <h3>è¼‰å…¥å¤±æ•—</h3>
                        <p style="color: var(--error-color);">${error.message}</p>
                        <button class="btn btn-primary" onclick="location.reload()">é‡æ–°è¼‰å…¥</button>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“ä½œæ¥­åˆ—è¡¨ï¼ˆæŒ‰èª²ç¨‹åˆ†çµ„ï¼‰
        function renderSubmissions() {
            const container = document.getElementById('assignmentsList');
            const emptyState = document.getElementById('emptyState');

            if (filteredSubmissions.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'flex';
                return;
            }

            emptyState.style.display = 'none';

            // æŒ‰èª²ç¨‹åˆ†çµ„
            const groupedByCourse = {};
            filteredSubmissions.forEach(item => {
                const courseKey = item.courseName || 'ç¨ç«‹ä½œæ¥­';
                if (!groupedByCourse[courseKey]) {
                    groupedByCourse[courseKey] = [];
                }
                groupedByCourse[courseKey].push(item);
            });

            // ç”ŸæˆæŒ‰èª²ç¨‹åˆ†çµ„çš„ HTML
            let html = '';
            Object.keys(groupedByCourse).sort().forEach(courseName => {
                        const items = groupedByCourse[courseName];

                        html += `
                    <div class="course-group" style="margin-bottom: 32px;">
                        <div class="course-group-header" style="
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            padding: 12px 16px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border-radius: 8px;
                            margin-bottom: 16px;
                            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
                        ">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <svg viewBox="0 0 20 20" fill="none" style="width: 20px; height: 20px; color: white;">
                                    <path d="M10 3L3 7l7 4 7-4-7-4z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M3 11l7 4 7-4M3 15l7 4 7-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <h3 style="margin: 0; color: white; font-size: 16px; font-weight: 600;">${courseName}</h3>
                            </div>
                            <span style="
                                background: rgba(255, 255, 255, 0.2);
                                color: white;
                                padding: 4px 12px;
                                border-radius: 12px;
                                font-size: 13px;
                                font-weight: 600;
                            ">${items.length} ä»½ä½œæ¥­</span>
                        </div>
                        <div class="course-submissions">
                `;

                        // é¡¯ç¤ºè©²èª²ç¨‹çš„æ‰€æœ‰ä½œæ¥­
                        html += items.map(item => {
                                    const statusText = getStatusText(item.status);
                                    return `
                    <div class="exam-card" data-id="${item.id}" style="position: relative;">
                        <input type="checkbox" class="submission-checkbox" data-id="${item.id}" style="
                            position: absolute;
                            top: 12px;
                            left: 12px;
                            width: 18px;
                            height: 18px;
                            cursor: pointer;
                            z-index: 10;
                        ">
                        <div class="exam-content" style="padding-left: 40px;">
                            <div class="exam-header">
                                <h3 class="exam-title">${item.studentName} - ${item.assignmentTitle}</h3>
                                <span class="status-badge status-${item.status}">${statusText}</span>
                    </div>
                    
                            <div class="exam-meta">
                                <span class="meta-badge">
                                    æäº¤æ™‚é–“ï¼š${formatDateTime(item.submissionTime)}
                                </span>
                                <span class="meta-badge badge-subject">
                                    åˆ†æ•¸ï¼š${item.score} / ${item.totalPoints}
                                </span>
                        </div>
                        </div>
                        
                        <div class="exam-actions">
                            <button class="action-btn view" onclick="viewDetails('${item.id}')" title="æŸ¥çœ‹è©³æƒ…">
                                <svg viewBox="0 0 20 20" fill="none" style="width: 14px; height: 14px;">
                                    <path d="M10 3C5 3 1.73 6.11 1 10c.73 3.89 4 7 9 7s8.27-3.11 9-7c-.73-3.89-4-7-9-7z" stroke="currentColor" stroke-width="1.5"/>
                                    <circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="1.5"/>
                                </svg>
                                æŸ¥çœ‹
                        </button>
                            <button class="action-btn edit" onclick="openEditModal('${item.id}')" title="ç·¨è¼¯æ‰¹æ”¹">
                                <svg viewBox="0 0 20 20" fill="none" style="width: 14px; height: 14px;">
                                    <path d="M14.5 2.5a2.121 2.121 0 0 1 3 3L6 17H3v-3L14.5 2.5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                ç·¨è¼¯
                        </button>
                            ${item.ai_result || item.gpt_score ? `
                            <button class="action-btn" onclick="viewAIGradingDetails('${item.id}')" title="æŸ¥çœ‹ AI æ‰¹æ”¹è©³æƒ…" style="background: #4A90E2; color: white;">
                                <svg viewBox="0 0 20 20" fill="none" style="width: 14px; height: 14px;">
                                    <path d="M3 3h14v14H3z" stroke="currentColor" stroke-width="1.5"/>
                                    <path d="M3 8h14M8 3v14" stroke="currentColor" stroke-width="1.5"/>
                                </svg>
                                AI è©³æƒ…
                            </button>
                            ` : `
                            <button class="action-btn ai" onclick="startSingleAIGrading('${item.id}')" title="AI æ‰¹æ”¹">
                                <svg viewBox="0 0 20 20" fill="none" style="width: 14px; height: 14px;">
                                    <path d="M10 2L3 7v6l7 5 7-5V7l-7-5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M10 12V8M8 10h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                                AI æ‰¹æ”¹
                        </button>
                            `}
                            <button class="action-btn" onclick="viewGradingHistory('${item.id}')" title="æ‰¹æ”¹æ­·å²è¨˜éŒ„" style="background: #ff9800; color: white;">
                                <svg viewBox="0 0 20 20" fill="none" style="width: 14px; height: 14px;">
                                    <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.5"/>
                                    <path d="M10 5v5l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                                æ‰¹æ”¹æ­·å²
                        </button>
                            <button class="action-btn delete" onclick="deleteSubmission('${item.id}')" title="åˆªé™¤">
                                <svg viewBox="0 0 20 20" fill="none" style="width: 14px; height: 14px;">
                                    <path d="M3 6h14M8 6V4h4v2m1 0v10a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h8z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                åˆªé™¤
                        </button>
                            <button class="action-btn" onclick="viewInAnalytics('${item.studentEmail}')" title="æŸ¥çœ‹æ•¸æ“šåˆ†æ" style="background: #9C27B0; color: white;">
                                <svg viewBox="0 0 20 20" fill="none" style="width: 14px; height: 14px;">
                                    <rect x="3" y="10" width="3" height="7" stroke="currentColor" stroke-width="1.5" fill="currentColor" opacity="0.3"/>
                                    <rect x="8.5" y="6" width="3" height="11" stroke="currentColor" stroke-width="1.5" fill="currentColor" opacity="0.5"/>
                                    <rect x="14" y="3" width="3" height="14" stroke="currentColor" stroke-width="1.5" fill="currentColor" opacity="0.7"/>
                                </svg>
                                æ•¸æ“šåˆ†æ
                        </button>
                    </div>
                </div>
                `;
                }).join('');
                
                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            renderPagination();
        }

        // æ¸²æŸ“åˆ†é 
        function renderPagination() {
            const totalPages = Math.ceil(filteredSubmissions.length / itemsPerPage);
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';

            const pageNumbers = document.getElementById('pageNumbers');
            let pagesHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                pagesHTML += `
                    <button class="page-number ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                        ${i}
                    </button>
                `;
            }

            pageNumbers.innerHTML = pagesHTML;

            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        function updateStatistics() {
            const total = allSubmissions.length;
            const pending = allSubmissions.filter(s => s.status === 'pending').length;
            const completed = allSubmissions.filter(s => s.status === 'completed').length;
            const avgScore = total > 0 ?
                (allSubmissions.reduce((sum, s) => sum + s.score, 0) / total).toFixed(1) :
                0;

            document.getElementById('totalSubmissions').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('averageScore').textContent = avgScore;
        }

        // æ‡‰ç”¨ç¯©é¸
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            filteredSubmissions = allSubmissions.filter(item => {
                if (searchTerm &&
                    !item.studentName.toLowerCase().includes(searchTerm) &&
                    !item.assignmentTitle.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                if (statusFilter && item.status !== statusFilter) {
                    return false;
                }

                return true;
            });

            currentPage = 1;
            renderSubmissions();
        }

        // æ‰¹é‡ AI æ‰¹æ”¹
        async function batchAIGrading() {
            const selectedIds = Array.from(document.querySelectorAll('.submission-checkbox:checked'))
                .map(cb => cb.dataset.id);
            
            if (selectedIds.length === 0) {
                showErrorToast('è«‹å…ˆé¸æ“‡è¦æ‰¹æ”¹çš„ä½œæ¥­');
                return;
            }

            if (!confirm(`ç¢ºå®šè¦æ‰¹æ”¹é¸ä¸­çš„ ${selectedIds.length} ä»½ä½œæ¥­å—ï¼Ÿ\n\né€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“...`)) {
                return;
            }

            // å‰µå»ºé€²åº¦è¦–çª—
            const progressModal = document.createElement('div');
            progressModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.75);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 20000;
            `;

            progressModal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    width: 90%;
                    max-width: 600px;
                    padding: 24px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #2c3e50;">ğŸ¤– æ‰¹é‡ AI æ‰¹æ”¹é€²è¡Œä¸­</h3>
                    <div id="batchProgressBar" style="
                        width: 100%;
                        height: 8px;
                        background: #e9ecef;
                        border-radius: 4px;
                        overflow: hidden;
                        margin-bottom: 12px;
                    ">
                        <div id="batchProgressFill" style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #4A90E2, #357ABD);
                            transition: width 0.3s ease;
                        "></div>
                    </div>
                    <div id="batchProgressText" style="font-size: 14px; color: #7f8c8d; text-align: center;">
                        æº–å‚™ä¸­...
                    </div>
                    <div id="batchProgressLog" style="
                        margin-top: 16px;
                        max-height: 300px;
                        overflow-y: auto;
                        background: #f8f9fa;
                        padding: 12px;
                        border-radius: 6px;
                        font-size: 13px;
                        line-height: 1.8;
                    "></div>
                </div>
            `;

            document.body.appendChild(progressModal);

            const progressBar = document.getElementById('batchProgressFill');
            const progressText = document.getElementById('batchProgressText');
            const progressLog = document.getElementById('batchProgressLog');

            let completed = 0;
            let succeeded = 0;
            let failed = 0;

            function addProgressLog(message, type = 'info') {
                const colors = {
                    'info': '#2196f3',
                    'success': '#4caf50',
                    'error': '#f44336'
                };
                progressLog.innerHTML += `<div style="color: ${colors[type]};">â€¢ ${message}</div>`;
                progressLog.scrollTop = progressLog.scrollHeight;
            }

            for (const id of selectedIds) {
                const item = allSubmissions.find(s => s.id === id);
                if (!item) continue;

                try {
                    addProgressLog(`æ‰¹æ”¹ä¸­ï¼š${item.studentName} - ${item.assignmentTitle}`, 'info');
                    
                    // èª¿ç”¨å–®ä¸€ä½œæ¥­æ‰¹æ”¹ï¼ˆé‡ç”¨ç¾æœ‰é‚è¼¯ï¼‰
                    await executeAIGradingInternal(id);
                    
                    succeeded++;
                    addProgressLog(`âœ“ å®Œæˆï¼š${item.studentName}`, 'success');
                } catch (error) {
                    failed++;
                    addProgressLog(`âœ— å¤±æ•—ï¼š${item.studentName} - ${error.message}`, 'error');
                }

                completed++;
                const progress = (completed / selectedIds.length) * 100;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `å·²å®Œæˆ ${completed}/${selectedIds.length} ä»½ï¼ˆæˆåŠŸ ${succeeded}ï¼Œå¤±æ•— ${failed}ï¼‰`;
            }

            addProgressLog(`\næ‰¹é‡æ‰¹æ”¹å®Œæˆï¼æˆåŠŸ ${succeeded} ä»½ï¼Œå¤±æ•— ${failed} ä»½`, succeeded === selectedIds.length ? 'success' : 'info');

            // 3 ç§’å¾Œè‡ªå‹•é—œé–‰
            setTimeout(() => {
                progressModal.remove();
                loadSubmissions(); // é‡æ–°è¼‰å…¥ä½œæ¥­åˆ—è¡¨
                showSuccessToast(`æ‰¹é‡æ‰¹æ”¹å®Œæˆï¼æˆåŠŸ ${succeeded} ä»½`);
            }, 3000);
        }

        // å…§éƒ¨æ‰¹æ”¹å‡½æ•¸ï¼ˆä¾›æ‰¹é‡èª¿ç”¨ï¼‰
        async function executeAIGradingInternal(id) {
            const item = allSubmissions.find(s => s.id === id);
            if (!item) throw new Error('æ‰¾ä¸åˆ°ä½œæ¥­');

            // æº–å‚™æ‰¹æ”¹è³‡æ–™
            const questions = [];
            const answers = [];
            
            if (item.answers && typeof item.answers === 'object') {
                const answerKeys = Object.keys(item.answers);
                const totalQuestions = answerKeys.length;
                const totalPoints = item.totalPoints || 100;
                const baseScore = Math.floor(totalPoints / totalQuestions);
                const remainder = totalPoints - (baseScore * totalQuestions);
                
                answerKeys.forEach((questionText, idx) => {
                    const maxScore = idx === 0 ? baseScore + remainder : baseScore;
                    questions.push({ text: questionText, maxScore: maxScore });
                    answers.push(item.answers[questionText]);
                });
            } else {
                questions.push({ text: item.assignmentTitle, maxScore: item.totalPoints || 100 });
                answers.push(item.content);
            }

            // ç²å–è‡ªè¨‚æç¤ºè©
            const customPrompt = localStorage.getItem('customGradingPrompt') || 
                'è«‹æ ¹æ“šé¡Œç›®è¦æ±‚æ‰¹æ”¹å­¸ç”Ÿç­”æ¡ˆï¼Œçµ¦å‡ºåˆ†æ•¸å’Œå…·é«”å»ºè­°ã€‚';

            // å‘¼å« AI æ‰¹æ”¹
            const functionUrl = 'https://us-central1-YOUR_PROJECT_ID.cloudfunctions.net/aiGradeThreeAgent';
            const response = await fetch(functionUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    questions: questions,
                    answers: answers,
                    customPrompt: customPrompt
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'æ‰¹æ”¹å¤±æ•—');
            }

            const result = await response.json();

            // æ›´æ–°è³‡æ–™åº«
            const updateData = {
                status: 'completed',
                graded_at: firebase.firestore.FieldValue.serverTimestamp(),
                graded_by: result.gradedBy,
                ai_result: result
            };
            
            if (result.results && Array.isArray(result.results)) {
                updateData.total_score = result.totalScore;
                updateData.max_total_score = result.maxTotalScore;
                updateData.total_questions = result.results.length;
                
                const arbitratedCount = result.results.filter(q => q.arbitrated).length;
                const consensusCount = result.results.filter(q => q.directConsensus).length;
                updateData.arbitrated_questions = arbitratedCount;
                updateData.consensus_questions = consensusCount;
                updateData.need_arbitration = arbitratedCount > 0;
                
                // å½™ç¸½è©•èª
                let gptTotalScore = 0;
                let claudeTotalScore = 0;
                const gptComments = [];
                const claudeComments = [];
                
                result.results.forEach((q, idx) => {
                    gptTotalScore += q.gptScore || 0;
                    claudeTotalScore += q.claudeScore || 0;
                    if (q.gptFeedback) gptComments.push(`ç¬¬${idx + 1}é¡Œ: ${q.gptFeedback}`);
                    if (q.claudeFeedback) claudeComments.push(`ç¬¬${idx + 1}é¡Œ: ${q.claudeFeedback}`);
                });
                
                updateData.gpt_score = gptTotalScore;
                updateData.gpt_feedback = gptComments.join('\n\n');
                updateData.claude_score = claudeTotalScore;
                updateData.claude_feedback = claudeComments.join('\n\n');
                
                if (arbitratedCount > 0) {
                    const arbitrationComments = result.results
                        .filter(q => q.arbitrated && q.arbitrationFeedback)
                        .map((q, idx) => `ç¬¬${idx + 1}é¡Œ: ${q.arbitrationFeedback}`);
                    updateData.feedback = arbitrationComments.join('\n\n');
                } else {
                    updateData.feedback = `æœ¬æ¬¡æ‰¹æ”¹å…± ${result.results.length} é¡Œï¼Œç¸½åˆ† ${result.totalScore}/${result.maxTotalScore}ã€‚æ‰€æœ‰é¡Œç›®å‡é”æˆå…±è­˜ï¼Œç„¡éœ€ä»²è£ã€‚`;
                }
            }
            
            // ğŸ”¥ ç”Ÿæˆåˆ†æå°ˆç”¨æ•¸æ“šï¼ˆä¾›æ•¸æ“šåˆ†æé é¢ç›´æ¥ä½¿ç”¨ï¼‰
            // å…ˆå¾ Firestore è®€å–å®Œæ•´çš„ä½œæ¥­æ•¸æ“šï¼ˆåŒ…å« answers ç­‰ï¼‰
            const submissionDoc = await db.collection('grading_events').doc(id).get();
            const submissionData = submissionDoc.exists ? submissionDoc.data() : {};
            
            // è§£æèª²ç¨‹è³‡è¨Šï¼ˆä»¥ form_id æŸ¥æ‰¾ exams æˆ– googleFormsï¼‰
            try {
                const formId = submissionData.form_id || submissionData.exam_id || submissionData.examId;
                if (formId) {
                    let courseId = null;
                    let courseName = null;
                    let examTitle = submissionData.form_title || submissionData.exam_title || null;
                    let examQuestions = null; // ä¾†æºé¡Œç›®ï¼ˆç”¨æ–¼æ‹¿ tags/æ­£ç¢ºç­”æ¡ˆï¼‰

                    // å„ªå…ˆå¾ exams ä»¥ googleFormId å°æ‡‰
                    try {
                        const ex1 = await db.collection('exams').where('googleFormId', '==', formId).limit(1).get();
                        if (!ex1.empty) {
                            const ex = ex1.docs[0].data();
                            courseId = ex.courseId || null;
                            courseName = ex.courseName || null;
                            examTitle = examTitle || ex.title || ex.name || null;
                            if (Array.isArray(ex.questions)) {
                                examQuestions = ex.questions;
                            }
                        }
                    } catch (e) { /* ignore */ }

                    // å…¶æ¬¡å¾ exams çš„ formId æ¬„ä½
                    if (!courseId) {
                        try {
                            const ex2 = await db.collection('exams').where('formId', '==', formId).limit(1).get();
                            if (!ex2.empty) {
                                const ex = ex2.docs[0].data();
                                courseId = ex.courseId || null;
                                courseName = ex.courseName || null;
                                examTitle = examTitle || ex.title || ex.name || null;
                                if (!examQuestions && Array.isArray(ex.questions)) {
                                    examQuestions = ex.questions;
                                }
                            }
                        } catch (e) { /* ignore */ }
                    }

                    // å†å¾ googleFormsï¼ˆæœ‰äº›è³‡æ–™åœ¨ examData å…§ï¼‰
                    if (!courseId) {
                        try {
                            const gf = await db.collection('googleForms').where('formId', '==', formId).limit(1).get();
                            if (!gf.empty) {
                                const gd = gf.docs[0].data();
                                const dataSrc = gd.examData || gd;
                                courseId = dataSrc.courseId || gd.courseId || null;
                                courseName = dataSrc.courseName || gd.courseName || null;
                                examTitle = examTitle || gd.title || dataSrc.title || null;
                                if (!examQuestions && Array.isArray((dataSrc && dataSrc.questions))) {
                                    examQuestions = dataSrc.questions;
                                }
                                
                                // ğŸ”¥ å¦‚æœ googleForms æ²’æœ‰èª²ç¨‹è³‡è¨Šï¼Œé€é examId åå‘æŸ¥è©¢
                                if (!courseId && gd.examId) {
                                    console.log(`    ğŸ”„ é€é examId=${gd.examId} åå‘æŸ¥è©¢ exams...`);
                                    try {
                                        const examDoc = await db.collection('exams').doc(gd.examId).get();
                                        if (examDoc.exists) {
                                            const examData = examDoc.data();
                                            courseId = examData.courseId || null;
                                            courseName = examData.courseName || null;
                                            examTitle = examTitle || examData.title || examData.name || null;
                                            if (!examQuestions && Array.isArray(examData.questions)) {
                                                examQuestions = examData.questions;
                                            }
                                            console.log(`    âœ… åå‘æŸ¥è©¢æˆåŠŸ â†’ ${courseName || 'ç„¡'}`);
                                        }
                                    } catch (e) {
                                        console.warn(`    âš ï¸ åå‘æŸ¥è©¢å¤±æ•—:`, e);
                                    }
                                }
                            }
                        } catch (e) { /* ignore */ }
                    }

                    submissionData.courseId = submissionData.courseId || courseId || null;
                    submissionData.courseName = submissionData.courseName || courseName || null;
                    submissionData.examTitle = submissionData.examTitle || examTitle || null;
                    submissionData.examQuestions = examQuestions || submissionData.examQuestions || null;
                    
                    console.log(`ğŸ“š è§£æèª²ç¨‹è³‡è¨Š: formId=${formId.substring(0, 12)}... â†’ courseId=${courseId || 'ç„¡'}, courseName=${courseName || 'ç„¡'}`);
                    
                    // ğŸ”¥ å¦‚æœ examQuestions æ˜¯ ID é™£åˆ—ï¼Œéœ€è¦å¾ Firestore æŸ¥è©¢å¯¦éš›é¡Œç›®è³‡æ–™
                    if (submissionData.examQuestions && Array.isArray(submissionData.examQuestions) && submissionData.examQuestions.length > 0) {
                        const firstItem = submissionData.examQuestions[0];
                        if (typeof firstItem === 'string') {
                            // æ˜¯ ID é™£åˆ—ï¼Œéœ€è¦æŸ¥è©¢
                            console.log(`  ğŸ” åµæ¸¬åˆ° examQuestions ç‚º ID é™£åˆ—ï¼ŒæŸ¥è©¢å¯¦éš›é¡Œç›®è³‡æ–™...`);
                            try {
                                const questionIds = submissionData.examQuestions.slice(0, 50); // æœ€å¤š 50 é¡Œ
                                const questionPromises = questionIds.map(qId => 
                                    db.collection('questions').doc(qId).get().catch(() => null)
                                );
                                const questionDocs = await Promise.all(questionPromises);
                                const validQuestions = questionDocs
                                    .filter(doc => doc && doc.exists)
                                    .map(doc => ({ id: doc.id, ...doc.data() }));
                                
                                console.log(`  âœ… æˆåŠŸè¼‰å…¥ ${validQuestions.length}/${questionIds.length} å€‹é¡Œç›®`);
                                submissionData.examQuestions = validQuestions;
                            } catch (e) {
                                console.warn(`  âš ï¸ æŸ¥è©¢é¡Œç›®è³‡æ–™å¤±æ•—:`, e);
                            }
                        }
                    }
                }
            } catch (e) {
                console.warn('âš ï¸ è§£æèª²ç¨‹è³‡è¨Šå¤±æ•—:', e);
            }

            // ğŸ” è¨ºæ–·ï¼šæª¢æŸ¥ submissionData çš„å…§å®¹
            console.log('ğŸ“‹ æº–å‚™ç”Ÿæˆåˆ†ææ•¸æ“šï¼ŒsubmissionData å…§å®¹:', {
                courseId: submissionData.courseId,
                courseName: submissionData.courseName,
                examTitle: submissionData.examTitle,
                examQuestions: submissionData.examQuestions ? 
                    `${submissionData.examQuestions.length} é¡Œ (${typeof submissionData.examQuestions[0]})` : 'ç„¡',
                formId: submissionData.form_id
            });

            const analyticsData = generateAnalyticsData(submissionData, result);
            if (analyticsData) {
                updateData.analytics_data = analyticsData;
                console.log('âœ… ç”Ÿæˆåˆ†ææ•¸æ“š:', analyticsData);
            } else {
                console.warn('âš ï¸ æœªèƒ½ç”Ÿæˆåˆ†ææ•¸æ“š');
            }
            
            await db.collection('grading_events').doc(id).set(updateData, { merge: true });
        }

        /**
         * ç”Ÿæˆåˆ†æå°ˆç”¨æ•¸æ“š
         * @param {Object} submission - æäº¤çš„ä½œæ¥­æ•¸æ“š
         * @param {Object} result - AI æ‰¹æ”¹çµæœ
         * @returns {Object} åˆ†æå°ˆç”¨æ•¸æ“š
         */
        function generateAnalyticsData(submission, result) {
            try {
                if (!result || !result.results || !Array.isArray(result.results)) {
                    console.warn('âš ï¸ ç„¡æ³•ç”Ÿæˆåˆ†ææ•¸æ“šï¼šAI çµæœä¸å®Œæ•´');
                    return null;
                }

                // æ”¶é›†æ‰€æœ‰æ¨™ç±¤å’Œçµ±è¨ˆ
                const allTags = new Set();
                const tagStats = {};
                const questions = [];
                
                let correctCount = 0;
                let wrongCount = 0;

                result.results.forEach((q, idx) => {
                    const questionNum = q.questionNum || (idx + 1);
                    
                    // ğŸ”¥ ä¿®æ­£ isCorrect åˆ¤æ–·ï¼šæå– maxScore ä¸¦ä»¥ 60% ç‚ºæ­£ç¢ºé–€æª»
                    let maxScore = q.maxScore;
                    if (!maxScore && submission.examQuestions && Array.isArray(submission.examQuestions)) {
                        const qByIndex = submission.examQuestions[questionNum - 1];
                        if (qByIndex && (qByIndex.maxScore || qByIndex.points)) {
                            maxScore = qByIndex.maxScore || qByIndex.points;
                        }
                    }
                    if (!maxScore) {
                        maxScore = 10; // é è¨­å€¼
                    }
                    
                    const finalScore = q.finalScore != null ? q.finalScore : (q.score != null ? q.score : 0);
                    const isCorrect = finalScore >= (maxScore * 0.6);
                    
                    if (isCorrect) {
                        correctCount++;
                    } else {
                        wrongCount++;
                    }

                    // ğŸ”¥ æå–é¡Œç›®æ¨™ç±¤ï¼ˆå„ªå…ˆå¾ examQuestions é€é¡Œæå–ï¼‰
                    let questionTags = [];
                    
                    // æ–¹æ³•1ï¼ˆæœ€å„ªå…ˆï¼‰: å¾ examQuestions ä¾é¡Œè™Ÿç´¢å¼•æå–è©²é¡Œçš„ tags
                    if (submission.examQuestions && Array.isArray(submission.examQuestions)) {
                        const byIndex = submission.examQuestions[questionNum - 1];
                        if (byIndex && Array.isArray(byIndex.tags) && byIndex.tags.length > 0) {
                            questionTags = byIndex.tags;
                        }
                    }
                    // æ–¹æ³•2: å¾ AI æ‰¹æ”¹çµæœçš„ question.tags
                    if (questionTags.length === 0 && q.question && q.question.tags && Array.isArray(q.question.tags)) {
                        questionTags = q.question.tags;
                    }
                    // æ–¹æ³•3: å¾ AI æ‰¹æ”¹çµæœçš„é ‚å±¤ tags
                    if (questionTags.length === 0 && q.tags && Array.isArray(q.tags)) {
                        questionTags = q.tags;
                    }
                    
                    // å¦‚æœé‚„æ˜¯æ²’æœ‰ï¼Œä½¿ç”¨é è¨­
                    if (questionTags.length === 0) {
                        questionTags = ['æœªåˆ†é¡'];
                        console.warn(`  âš ï¸ ç¬¬ ${questionNum} é¡Œæ²’æœ‰æ¨™ç±¤ï¼Œä½¿ç”¨ã€Œæœªåˆ†é¡ã€`);
                    } else {
                        console.log(`  âœ… ç¬¬ ${questionNum} é¡Œæ¨™ç±¤:`, questionTags);
                    }

                    // çµ±è¨ˆæ¨™ç±¤
                    questionTags.forEach(tag => {
                        allTags.add(tag);
                        if (!tagStats[tag]) {
                            tagStats[tag] = { total: 0, wrong: 0 };
                        }
                        tagStats[tag].total++;
                        if (!isCorrect) {
                            tagStats[tag].wrong++;
                        }
                    });

                    // æå–é¡Œç›®æ–‡å­—
                    let questionText = `ç¬¬ ${questionNum} é¡Œ`;
                    if (q.question && q.question.question) {
                        questionText = q.question.question;
                    }

                    // æå–å­¸ç”Ÿç­”æ¡ˆ
                    let studentAnswer = 'æœªä½œç­”';
                    const answers = submission.answers || {};
                    const answerKey = Object.keys(answers).find(key => 
                        key.startsWith(`${questionNum}.`) || key.includes(`${questionNum}`)
                    );
                    if (answerKey) {
                        studentAnswer = answers[answerKey];
                        if (typeof studentAnswer === 'object' && studentAnswer !== null) {
                            studentAnswer = studentAnswer.answer || studentAnswer.text || JSON.stringify(studentAnswer);
                        }
                    }

                    // æå–æ­£ç¢ºç­”æ¡ˆï¼ˆå¤šé‡ä¾†æºï¼‰
                    let correctAnswer = 'æœªæä¾›';
                    
                    // ä¾†æº 1: q.question.answer
                    if (q.question && q.question.answer) {
                        correctAnswer = q.question.answer;
                    } 
                    // ä¾†æº 2: q.question.correctAnswer
                    else if (q.question && q.question.correctAnswer) {
                        correctAnswer = q.question.correctAnswer;
                    } 
                    // ä¾†æº 3: examQuestions[index]
                    else if (submission.examQuestions && Array.isArray(submission.examQuestions)) {
                        const byIndex = submission.examQuestions[questionNum - 1];
                        if (byIndex) {
                            correctAnswer = byIndex.answer || 
                                          byIndex.correctAnswer || 
                                          byIndex.standardAnswer || 
                                          byIndex.solution ||
                                          byIndex.expectedAnswer ||
                                          'æœªæä¾›';
                        }
                    }
                    // ä¾†æº 4: ç›´æ¥å¾ q ç‰©ä»¶ï¼ˆå¯èƒ½æ˜¯èˆŠæ ¼å¼ï¼‰
                    if (correctAnswer === 'æœªæä¾›' && q.correctAnswer) {
                        correctAnswer = q.correctAnswer;
                    }

                    // âœ… ä½¿ç”¨å‰é¢å·²ç¶“è¨ˆç®—å¥½çš„ maxScore å’Œ isCorrect
                    questions.push({
                        questionNum: questionNum,
                        questionText: questionText,
                        studentAnswer: studentAnswer,
                        correctAnswer: correctAnswer,
                        score: finalScore,
                        maxScore: maxScore, // ä½¿ç”¨å‰é¢è¨ˆç®—çš„å€¼
                        isCorrect: isCorrect, // ä½¿ç”¨å‰é¢è¨ˆç®—çš„å€¼
                        tags: questionTags,
                        gptScore: q.gptScore || 0,
                        claudeScore: q.claudeScore || 0,
                        arbitrated: q.arbitrated || false
                    });
                });

                // æ§‹å»ºå®Œæ•´çš„åˆ†ææ•¸æ“š
                const analyticsData = {
                    // èª²ç¨‹è³‡è¨Šï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                    courseId: submission.courseId || null,
                    courseName: submission.courseName || null,
                    examId: submission.form_id || submission.exam_id || null,
                    examTitle: submission.form_title || submission.exam_title || 'æœªå‘½åè€ƒè©¦',
                    
                    // æ•´é«”çµ±è¨ˆ
                    summary: {
                        totalQuestions: result.results.length,
                        correctCount: correctCount,
                        wrongCount: wrongCount,
                        totalScore: result.totalScore || 0,
                        maxScore: result.maxTotalScore || 100,
                        percentage: result.maxTotalScore > 0 
                            ? Math.round((result.totalScore / result.maxTotalScore) * 100) 
                            : 0
                    },
                    
                    // æ¨™ç±¤çµ±è¨ˆ
                    tags: Array.from(allTags),
                    tagStats: tagStats,
                    
                    // æ¯é¡Œè©³ç´°è³‡æ–™
                    questions: questions,
                    
                    // ç”Ÿæˆæ™‚é–“
                    generatedAt: new Date().toISOString()
                };

                console.log('âœ… ç”Ÿæˆåˆ†ææ•¸æ“š:', analyticsData);
                return analyticsData;

            } catch (error) {
                console.error('âŒ ç”Ÿæˆåˆ†ææ•¸æ“šå¤±æ•—:', error);
                return null;
            }
        }

        // å…¨åŸŸè®Šæ•¸ï¼šç•¶å‰ç·¨è¼¯çš„ä½œæ¥­ ID
        let currentEditingId = null;

        // æŸ¥çœ‹ä½œæ¥­è©³æƒ…
        function viewDetails(id) {
            const item = allSubmissions.find(s => s.id === id);
            if (!item) return;

            currentEditingId = id;

            const detailBody = document.getElementById('detailModalBody');
            detailBody.innerHTML = `
                <div style="display: grid; gap: 20px;">
                    <div>
                        <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 14px;">å­¸ç”Ÿè³‡è¨Š</h4>
                        <p style="margin: 0; color: var(--text-secondary);">${item.studentName} (${item.studentEmail || 'ç„¡éƒµä»¶'})</p>
                    </div>
                    
                    <div>
                        <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 14px;">ä½œæ¥­æ¨™é¡Œ</h4>
                        <p style="margin: 0; color: var(--text-secondary);">${item.assignmentTitle}</p>
                    </div>
                    
                    <div>
                        <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 14px;">æäº¤æ™‚é–“</h4>
                        <p style="margin: 0; color: var(--text-secondary);">${formatDateTime(item.submissionTime)}</p>
                    </div>
                    
                    <div>
                        <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 14px;">å­¸ç”Ÿç­”æ¡ˆ</h4>
                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; white-space: pre-wrap; color: var(--text-primary);">${item.content || 'ç„¡å…§å®¹'}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 14px;">åˆ†æ•¸</h4>
                            <p style="margin: 0; color: var(--primary-color); font-size: 24px; font-weight: 600;">${item.score} / ${item.totalPoints}</p>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 14px;">ç‹€æ…‹</h4>
                            <span class="status-badge status-${item.status}">${getStatusText(item.status)}</span>
                        </div>
                    </div>
                    
                    ${item.feedback ? `
                    <div>
                        <h4 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 14px;">æ‰¹æ”¹è©•èª</h4>
                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; white-space: pre-wrap; color: var(--text-primary);">${item.feedback}</div>
                    </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('detailModal').style.display = 'flex';
        }

        // é—œé–‰è©³æƒ…æ¨¡æ…‹æ¡†
        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // å¾è©³æƒ…æ¨¡æ…‹æ¡†æ‰“é–‹ç·¨è¼¯æ¨¡æ…‹æ¡†
        function openEditModalFromDetail() {
            closeDetailModal();
            openEditModal(currentEditingId);
        }

        // æ‰“é–‹ç·¨è¼¯æ‰¹æ”¹æ¨¡æ…‹æ¡†
        function openEditModal(id) {
            const item = allSubmissions.find(s => s.id === id);
            if (!item) return;

            currentEditingId = id;

            document.getElementById('editStudentName').value = item.studentName;
            document.getElementById('editAssignmentTitle').value = item.assignmentTitle;
            document.getElementById('editStudentAnswer').value = item.content || 'ç„¡å…§å®¹';
            document.getElementById('editFeedback').value = item.feedback || '';
            document.getElementById('editScore').value = item.score || 0;
            document.getElementById('editStatus').value = item.status || 'pending';

            document.getElementById('editModal').style.display = 'flex';
        }

        // é—œé–‰ç·¨è¼¯æ¨¡æ…‹æ¡†
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditingId = null;
        }

        // å„²å­˜æ‰¹æ”¹
        async function saveGrading() {
            if (!currentEditingId) return;

            try {
                const feedback = document.getElementById('editFeedback').value.trim();
                const score = parseInt(document.getElementById('editScore').value) || 0;
                const status = document.getElementById('editStatus').value;

                await db.collection('grading_events').doc(currentEditingId).update({
                    feedback: feedback,
                    total_score: score,
                    status: status,
                    updated_at: firebase.firestore.FieldValue.serverTimestamp(),
                    graded_by: currentUser.uid
                });

                alert('æ‰¹æ”¹å·²å„²å­˜ï¼');
                closeEditModal();
                await loadSubmissions();

            } catch (error) {
                console.error('âŒ å„²å­˜æ‰¹æ”¹å¤±æ•—:', error);
                alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
            }
        }

        // å–®ç¨ AI æ‰¹æ”¹ï¼ˆä½¿ç”¨ä¸‰ä»£ç†äººç³»çµ± - Firebase Functionï¼‰
        async function startSingleAIGrading(id) {
            const item = allSubmissions.find(s => s.id === id);
            if (!item) return;

            // é¡¯ç¤º AI æ‰¹æ”¹æ—¥èªŒå½ˆå‡ºè¦–çª—
            showAIGradingModal(id, item);
        }

        // é¡¯ç¤º AI æ‰¹æ”¹æ—¥èªŒå½ˆå‡ºè¦–çª—
        function showAIGradingModal(id, item) {
            const modal = document.createElement('div');
            modal.id = 'aiGradingModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    width: 90%;
                    max-width: 800px;
                    max-height: 90vh;
                    overflow: hidden;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    display: flex;
                    flex-direction: column;
                    animation: slideUp 0.3s ease;
                ">
                    <!-- æ¨™é¡Œæ¬„ -->
                    <div style="
                        padding: 20px 24px;
                        background: #f8f9fa;
                        border-bottom: 2px solid #4A90E2;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    ">
                        <div>
                            <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #2c3e50;">AI æ‰¹æ”¹ç³»çµ±</h2>
                            <p style="margin: 6px 0 0 0; font-size: 13px; color: #7f8c8d;">å­¸ç”Ÿï¼š${item.studentName} | ä½œæ¥­ï¼š${item.assignmentTitle}</p>
                        </div>
                        <button onclick="closeAIGradingModal()" style="
                            background: #e9ecef;
                            border: 1px solid #dee2e6;
                            color: #6c757d;
                            width: 32px;
                            height: 32px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 18px;
                            line-height: 1;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#dee2e6'" onmouseout="this.style.background='#e9ecef'">Ã—</button>
                    </div>

                    <!-- è©•åˆ†æç¤ºè©è¨­å®šå€ -->
                    <div style="
                        padding: 16px 24px;
                        background: #e7f3ff;
                        border-bottom: 1px solid #d0e7ff;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 14px; font-weight: 600; color: #2c5282;">è©•åˆ†æç¤ºè©è¨­å®š</span>
                                <span style="font-size: 12px; color: #4a5568; opacity: 0.8;">(å¯è‡ªå®šç¾©æ‰¹æ”¹æ¨™æº–)</span>
                            </div>
                            <button id="togglePromptBtn" onclick="togglePromptEditor()" style="
                                background: white;
                                border: 1px solid #cbd5e0;
                                color: #4a5568;
                                padding: 5px 12px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 12px;
                                font-weight: 500;
                                transition: all 0.2s;
                            " onmouseover="this.style.background='#f7fafc'; this.style.borderColor='#4A90E2'" onmouseout="this.style.background='white'; this.style.borderColor='#cbd5e0'">â–¼ å±•é–‹ç·¨è¼¯</button>
                        </div>
                        <div id="promptEditorContainer" style="display: none;">
                            <textarea id="customPromptInput" style="
                                width: 100%;
                                min-height: 200px;
                                max-height: 400px;
                                padding: 12px;
                                border: 1px solid #cbd5e0;
                                border-radius: 6px;
                                font-family: 'Consolas', 'Monaco', monospace;
                                font-size: 12px;
                                line-height: 1.6;
                                resize: vertical;
                                background: white;
                            " placeholder="è«‹è¼¸å…¥è‡ªå®šç¾©è©•åˆ†æç¤ºè©..."></textarea>
                            <div style="margin-top: 10px; display: flex; gap: 8px;">
                                <button onclick="resetPromptToDefault()" style="
                                    padding: 7px 14px;
                                    background: #f7fafc;
                                    color: #4a5568;
                                    border: 1px solid #cbd5e0;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 13px;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f7fafc'">æ¢å¾©é è¨­</button>
                                <button onclick="saveCustomPrompt()" style="
                                    padding: 7px 14px;
                                    background: #4A90E2;
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 13px;
                                    font-weight: 500;
                                    transition: all 0.2s;
                                " onmouseover="this.style.background='#357ABD'" onmouseout="this.style.background='#4A90E2'">å„²å­˜æç¤ºè©</button>
                            </div>
                        </div>
                    </div>

                    <!-- æ—¥èªŒå€åŸŸ -->
                    <div id="gradingLogContent" style="
                        flex: 1;
                        overflow-y: auto;
                        padding: 24px;
                        background: #f8f9fa;
                    ">
                        <div id="gradingStatus" style="
                            text-align: center;
                            padding: 40px;
                            color: #666;
                        ">
                            <div style="font-size: 48px; margin-bottom: 16px;">â³</div>
                            <div style="font-size: 16px; font-weight: 500;">æº–å‚™é–‹å§‹æ‰¹æ”¹...</div>
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰éˆ• -->
                    <div style="
                        padding: 16px 24px;
                        background: #f8f9fa;
                        border-top: 1px solid #dee2e6;
                        display: flex;
                        justify-content: flex-end;
                        align-items: center;
                        gap: 12px;
                    ">
                        <button onclick="closeAIGradingModal()" style="
                            padding: 10px 20px;
                            background: white;
                            color: #6c757d;
                            border: 1px solid #dee2e6;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 500;
                            font-size: 14px;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">
                            å–æ¶ˆ
                        </button>
                        <button id="startGradingBtn" onclick="executeAIGrading('${id}')" style="
                            padding: 10px 24px;
                            background: #4A90E2;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 500;
                            font-size: 14px;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#357ABD'" onmouseout="this.style.background='#4A90E2'">
                            é–‹å§‹æ‰¹æ”¹
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // åˆå§‹åŒ–æç¤ºè©æ–‡æœ¬æ¡†
            setTimeout(() => {
                const textarea = document.getElementById('customPromptInput');
                if (textarea) {
                    textarea.value = getCurrentPrompt();
                }
            }, 100);

            // é»æ“ŠèƒŒæ™¯é—œé–‰
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeAIGradingModal();
                }
            });
        }

        // é—œé–‰ AI æ‰¹æ”¹å½ˆå‡ºè¦–çª—
        function closeAIGradingModal() {
            const modal = document.getElementById('aiGradingModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => modal.remove(), 300);
            }
        }

        // ç²å–é è¨­è©•åˆ†æç¤ºè©
        function getDefaultGradingPrompt() {
            return `ä½ æ˜¯ä¸€ä½å°ˆæ¥­ã€åš´è¬¹ä¸”å¯Œæœ‰æ•™å­¸ç¶“é©—çš„C#ç¨‹å¼è¨­è¨ˆåŠ©æ•™ã€‚ä½ çš„ä»»å‹™æ˜¯æ‰¹æ”¹åˆå­¸è€…çš„ç¨‹å¼ä½œæ¥­ã€‚

**æœ€é«˜æŒ‡ä»¤ï¼šä½ çš„é¦–è¦ä¸”å”¯ä¸€çš„ä»»å‹™æ˜¯åš´æ ¼éµå¾æŒ‡å®šçš„è¼¸å‡ºæ ¼å¼èˆ‡æ‰¹æ”¹æµç¨‹ã€‚ä½ çš„æ€è€ƒèˆ‡æ‰¹æ”¹éç¨‹éƒ½å¿…é ˆå°å‘ä¸€å€‹æœ€çµ‚ç›®æ¨™ï¼šè¼¸å‡ºä¸€å€‹èªæ³•å®Œå…¨æ­£ç¢ºã€åˆ†æ•¸è¨ˆç®—ç„¡èª¤ã€å…§å®¹ç¬¦åˆæ‰€æœ‰è¦ç¯„çš„ JSON ç‰©Objectã€‚æ­¤ JSON ç‰©ä»¶å…§çš„ä»»ä½•å­—ä¸²å€¼ï¼Œç‰¹åˆ¥æ˜¯ \`part4_table\`ï¼Œçµ•ä¸å…è¨±åŒ…å« HTML æ¨™ç±¤ã€‚ä¸å¾—åŒ…å«ä»»ä½• JSON æ ¼å¼ä»¥å¤–çš„æ–‡å­—ã€‚**

### æ ¸å¿ƒæ‰¹æ”¹åŸå‰‡
1. **ä»¥åˆå­¸è€…è§’åº¦å‡ºç™¼èˆ‡æ ¸å¿ƒæ¦‚å¿µå„ªå…ˆ**ï¼šè©•ä¼°é‡é»æ˜¯å­¸ç”Ÿæ˜¯å¦ç†è§£äº†é¡Œç›®çš„æ ¸å¿ƒè§€å¿µã€‚å°æ–¼éé—œéµæ€§çš„èªæ³•æˆ–æ ¼å¼å°éŒ¯èª¤æ‡‰çµ¦äºˆå¯¬å®¹ï¼Œåœ¨æ„è¦‹ä¸­æé†’å³å¯ï¼Œé¿å…éé‡æ‰£åˆ†ã€‚
2. **åŠŸå‹é©…å‹•è©•åˆ† (Credit for What's Right)**ï¼šå„ªå…ˆçå‹µå­¸ç”Ÿç­”å°çš„éƒ¨åˆ†ï¼Œç‰¹åˆ¥æ˜¯æ ¸å¿ƒé‚è¼¯ã€‚å³ä½¿ç¨‹å¼å› å°éŒ¯ç„¡æ³•åŸ·è¡Œï¼Œåªè¦èƒ½å±•ç¾æ­£ç¢ºçš„æ€è·¯ï¼Œå°±æ‡‰åœ¨ã€Œé‚è¼¯æ­£ç¢ºæ€§ã€éƒ¨åˆ†çµ¦äºˆé«˜åº¦è‚¯å®šã€‚
3. **ä¸€è‡´æ€§èˆ‡å®¢è§€æ€§**ï¼šå¿…é ˆåš´æ ¼éµå¾ªè©•åˆ†æµç¨‹èˆ‡æ¨™æº–ï¼Œç¢ºä¿å°æ‰€æœ‰å­¸ç”Ÿçš„è©•åˆ†æ¨™æº–ä¸€è‡´ã€‚
4. **å»ºè¨­æ€§çš„å›é¥‹**ï¼šä¸åƒ…çµ¦å‡ºåˆ†æ•¸ï¼Œæ›´è¦æä¾›æ¸…æ™°ã€æœ‰å»ºè¨­æ€§çš„ã€Œæ‰¹æ”¹æ„è¦‹ã€ï¼Œè§£é‡‹åˆ†æ•¸çš„ç”±ä¾†ï¼Œä¸¦æå‡ºå…·é«”çš„æ”¹é€²å»ºè­°ã€‚`;
        }

        // å±•é–‹/æ”¶èµ·æç¤ºè©ç·¨è¼¯å™¨
        function togglePromptEditor() {
            const container = document.getElementById('promptEditorContainer');
            const btn = document.getElementById('togglePromptBtn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                btn.textContent = 'â–² æ”¶èµ·';
            } else {
                container.style.display = 'none';
                btn.textContent = 'â–¼ å±•é–‹ç·¨è¼¯';
            }
        }

        // æ¢å¾©é è¨­æç¤ºè©
        function resetPromptToDefault() {
            const textarea = document.getElementById('customPromptInput');
            if (textarea) {
                textarea.value = getDefaultGradingPrompt();
                showSuccessToast('âœ… å·²æ¢å¾©ç‚ºé è¨­è©•åˆ†æç¤ºè©');
            }
        }

        // å„²å­˜è‡ªå®šç¾©æç¤ºè©åˆ° localStorage
        function saveCustomPrompt() {
            const textarea = document.getElementById('customPromptInput');
            if (textarea) {
                localStorage.setItem('customGradingPrompt', textarea.value);
                showSuccessToast('ğŸ’¾ è©•åˆ†æç¤ºè©å·²å„²å­˜');
            }
        }

        // ç²å–ç•¶å‰ä½¿ç”¨çš„æç¤ºè©ï¼ˆå„ªå…ˆä½¿ç”¨è‡ªå®šç¾©çš„ï¼‰
        function getCurrentPrompt() {
            const customPrompt = localStorage.getItem('customGradingPrompt');
            return customPrompt || getDefaultGradingPrompt();
        }

        // å¾ Gemini ç²å–æ”¹é€²å»ºè­°çš„æç¤ºè©
        async function getSuggestedPromptFromGemini(result, item) {
            const currentPrompt = getCurrentPrompt();
            
            const analysisPrompt = `ä½ æ˜¯ä¸€ä½æ•™å­¸è¨­è¨ˆå°ˆå®¶ã€‚è«‹åˆ†æä»¥ä¸‹æ‰¹æ”¹çµæœï¼Œä¸¦æ¨è–¦ä¸€å€‹æ”¹é€²çš„è©•åˆ†æç¤ºè©ã€‚

**ç•¶å‰æç¤ºè©ï¼š**
${currentPrompt.substring(0, 500)}...

**æ‰¹æ”¹çµæœåˆ†æï¼š**
- é¡Œç›®ï¼š${item.assignmentTitle}
- æ»¿åˆ†ï¼š${item.totalPoints || 100}
- GPT è©•åˆ†ï¼š${result.gptScore} åˆ†
- GPT è©•èªï¼š${result.gptFeedback}
- Claude è©•åˆ†ï¼š${result.claudeScore} åˆ†  
- Claude è©•èªï¼š${result.claudeFeedback}
- æœ€çµ‚è©•åˆ†ï¼š${result.finalScore} åˆ†
${result.needArbitration ? `- ä»²è£åŸå› ï¼š${result.arbitrationReason}` : ''}

**è«‹æä¾›ï¼š**
1. ä¸€å€‹æ”¹é€²ç‰ˆçš„è©•åˆ†æç¤ºè©ï¼ˆç°¡åŒ–ç‰ˆï¼Œèšç„¦æœ¬æ¬¡æ‰¹æ”¹ç™¼ç¾çš„å•é¡Œï¼‰
2. æ”¹é€²ç†ç”±ï¼ˆç‚ºä»€éº¼è¦é€™æ¨£èª¿æ•´ï¼‰
3. é—œéµæ”¹é€²é»ï¼ˆ3-5 é»ï¼‰

è«‹ä»¥ JSON æ ¼å¼å›æ‡‰ï¼š
{
  "suggestedPrompt": "æ”¹é€²çš„æç¤ºè©",
  "improvementReason": "æ”¹é€²ç†ç”±",
  "keyPoints": ["æ”¹é€²é»1", "æ”¹é€²é»2", "æ”¹é€²é»3"],
  "version": "v" + æ–°çš„ç‰ˆæœ¬è™Ÿ
}`;

            const functionUrl = 'https://us-central1-YOUR_PROJECT_ID.cloudfunctions.net/aiGradeThreeAgent';
            
            try {
                // å˜—è©¦ä½¿ç”¨å¤šå€‹ Gemini æ¨¡å‹ç‰ˆæœ¬
                const models = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-pro'];
                let response = null;
                let lastError = null;

                for (const model of models) {
                    try {
                        response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEYS.GEMINI}`,
                            {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    contents: [{parts: [{text: analysisPrompt}]}],
                                    generationConfig: {temperature: 0.7, maxOutputTokens: 2000},
                                }),
                            }
                        );

                        if (response.ok) {
                            break; // æˆåŠŸï¼Œè·³å‡ºå¾ªç’°
                        }
                    } catch (err) {
                        lastError = err;
                        console.warn(`æ¨¡å‹ ${model} å¤±æ•—ï¼Œå˜—è©¦ä¸‹ä¸€å€‹...`);
                    }
                }

                if (!response || !response.ok) {
                    console.warn('æ‰€æœ‰ Gemini æ¨¡å‹éƒ½å¤±æ•—ï¼Œè·³éæç¤ºè©æ¨è–¦');
                    return null;
                }

                const geminiResult = await response.json();
                const content = geminiResult.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!content) {
                    return null;
                }

                // è§£æ JSON
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
                
                return null;
            } catch (error) {
                console.warn('æç¤ºè©æ¨è–¦å¤±æ•—ï¼Œå°‡è·³éæ­¤åŠŸèƒ½:', error.message);
                return null;
            }
        }

        // é¡¯ç¤ºå»ºè­°çš„æç¤ºè©
        function displaySuggestedPrompt(suggestion) {
            const logContent = document.getElementById('gradingLogContent');
            
            if (!suggestion) return;

            addLog('ğŸ’¡', `Gemini æ¨è–¦æ”¹é€²ç‰ˆæç¤ºè©\nç‰ˆæœ¬ï¼š${suggestion.version || 'v1.0'}`, 'ai');

            // å‰µå»ºå»ºè­°å¡ç‰‡
            const suggestionCard = document.createElement('div');
            suggestionCard.style.cssText = `
                background: white;
                border: 2px solid #4A90E2;
                padding: 18px;
                border-radius: 8px;
                margin-top: 16px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            `;
            
            suggestionCard.innerHTML = `
                <div style="margin-bottom: 14px; padding-bottom: 12px; border-bottom: 1px solid #e9ecef;">
                    <div style="font-size: 15px; font-weight: 600; margin-bottom: 6px; color: #2c3e50;">
                        ğŸ’¡ æç¤ºè©å„ªåŒ–å»ºè­°
                    </div>
                    <div style="font-size: 12px; color: #7f8c8d;">
                        ç‰ˆæœ¬ï¼š${suggestion.version || 'v1.0'} | åŸºæ–¼æœ¬æ¬¡æ‰¹æ”¹çµæœåˆ†æ
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #4A90E2;">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #2c5282;">é—œéµæ”¹é€²é»ï¼š</div>
                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; line-height: 1.8; color: #4a5568;">
                        ${suggestion.keyPoints?.map(point => `<li>${point}</li>`).join('') || ''}
                    </ul>
                </div>

                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 14px; border-left: 3px solid #48BB78;">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #2d3748;">æ”¹é€²ç†ç”±ï¼š</div>
                    <div style="font-size: 12px; line-height: 1.6; white-space: pre-wrap; color: #4a5568;">${suggestion.improvementReason || ''}</div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button onclick="applySuggestedPrompt(${JSON.stringify(suggestion.suggestedPrompt).replace(/"/g, '&quot;')})" style="
                        flex: 1;
                        padding: 10px 16px;
                        background: #4A90E2;
                        border: none;
                        color: white;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: 500;
                        font-size: 13px;
                        transition: all 0.2s;
                    " onmouseover="this.style.background='#357ABD'" onmouseout="this.style.background='#4A90E2'">
                        å¥—ç”¨å»ºè­°
                    </button>
                    <button onclick="viewSuggestedPrompt(${JSON.stringify(suggestion.suggestedPrompt).replace(/"/g, '&quot;')})" style="
                        flex: 1;
                        padding: 10px 16px;
                        background: white;
                        border: 1px solid #cbd5e0;
                        color: #4a5568;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: 500;
                        font-size: 13px;
                        transition: all 0.2s;
                    " onmouseover="this.style.background='#f7fafc'" onmouseout="this.style.background='white'">
                        æŸ¥çœ‹è©³æƒ…
                    </button>
                </div>
            `;

            logContent.appendChild(suggestionCard);
            logContent.scrollTop = logContent.scrollHeight;
        }

        // å¥—ç”¨å»ºè­°çš„æç¤ºè©
        function applySuggestedPrompt(suggestedPrompt) {
            const textarea = document.getElementById('customPromptInput');
            if (textarea) {
                textarea.value = suggestedPrompt;
                saveCustomPrompt();
                showSuccessToast('âœ… æ–°æç¤ºè©å·²å¥—ç”¨ä¸¦å„²å­˜ï¼');
                
                // æ›´æ–°æç¤ºè©é¡¯ç¤ºå€
                const logContent = document.getElementById('gradingLogContent');
                const applyLog = document.createElement('div');
                applyLog.style.cssText = `
                    background: #d1ecf1;
                    color: #0c5460;
                    padding: 12px 16px;
                    border-radius: 6px;
                    margin-top: 12px;
                    border-left: 3px solid #4A90E2;
                    font-size: 13px;
                    font-weight: 500;
                `;
                applyLog.textContent = 'âœ“ æ–°æç¤ºè©å·²å¥—ç”¨ï¼Œä¸‹æ¬¡æ‰¹æ”¹å°‡ä½¿ç”¨æ–°ç‰ˆæœ¬';
                logContent.appendChild(applyLog);
                logContent.scrollTop = logContent.scrollHeight;
            }
        }

        // é è¦½å»ºè­°çš„æç¤ºè©è©³æƒ…
        function viewSuggestedPrompt(suggestedPrompt) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 20000;
                animation: fadeIn 0.3s ease;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    width: 90%;
                    max-width: 900px;
                    max-height: 85vh;
                    overflow: hidden;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.4);
                    display: flex;
                    flex-direction: column;
                ">
                    <div style="
                        padding: 20px 24px;
                        background: #f8f9fa;
                        border-bottom: 2px solid #4A90E2;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #2c3e50;">å»ºè­°æç¤ºè©è©³æƒ…</h2>
                            <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="
                                background: #e9ecef;
                                border: 1px solid #dee2e6;
                                color: #6c757d;
                                width: 32px;
                                height: 32px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 18px;
                                line-height: 1;
                                transition: all 0.2s;
                            " onmouseover="this.style.background='#dee2e6'" onmouseout="this.style.background='#e9ecef'">Ã—</button>
                        </div>
                    </div>
                    <div style="flex: 1; overflow-y: auto; padding: 24px; background: #f8f9fa;">
                        <textarea readonly style="
                            width: 100%;
                            min-height: 400px;
                            padding: 16px;
                            border: 2px solid #e0e0e0;
                            border-radius: 12px;
                            font-family: 'Consolas', 'Monaco', monospace;
                            font-size: 13px;
                            line-height: 1.6;
                            background: white;
                            resize: vertical;
                        ">${suggestedPrompt}</textarea>
                    </div>
                    <div style="
                        padding: 16px 24px;
                        background: #f8f9fa;
                        border-top: 1px solid #dee2e6;
                        display: flex;
                        justify-content: flex-end;
                        gap: 12px;
                    ">
                        <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="
                            padding: 10px 20px;
                            background: white;
                            color: #6c757d;
                            border: 1px solid #dee2e6;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 500;
                            font-size: 14px;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='white'">
                            é—œé–‰
                        </button>
                        <button onclick="applySuggestedPrompt(\`${suggestedPrompt.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`); this.closest('div[style*=\\'position: fixed\\']').remove();" style="
                            padding: 10px 24px;
                            background: #4A90E2;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 500;
                            font-size: 14px;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#357ABD'" onmouseout="this.style.background='#4A90E2'">
                            å¥—ç”¨æ­¤æç¤ºè©
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // ç”Ÿæˆé€é¡Œè©³æƒ…çš„ HTML
        function generateQuestionDetails(aiResult) {
            // å¦‚æœæœ‰é€é¡Œæ‰¹æ”¹çµæœ
            if (aiResult.results && Array.isArray(aiResult.results)) {
                return aiResult.results.map((q, idx) => {
                    const questionNum = idx + 1;
                    const needArbitration = q.arbitrated || false;
                    const directConsensus = q.directConsensus || false;
                    
                    let statusHtml = '';
                    if (directConsensus) {
                        // ç›´æ¥å…±è­˜
                        statusHtml = `
                            <div style="background: #d4edda; padding: 16px; border-radius: 8px; border-left: 4px solid #28a745;">
                                <div style="font-weight: 600; color: #155724; margin-bottom: 12px; font-size: 14px;">âœ“ ç›´æ¥å…±è­˜ï¼ˆç„¡é ˆä»²è£ï¼‰</div>
                                
                                <!-- å…±è­˜åŸå›  -->
                                <div style="background: rgba(255, 255, 255, 0.7); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                                    <div style="font-size: 12px; color: #155724; font-weight: 600; margin-bottom: 6px;">ğŸ“Š è©•ä¼°çµæœ</div>
                                    <div style="font-size: 12px; color: #155724;">
                                        â€¢ èªæ„ç›¸ä¼¼åº¦ï¼š<strong>${(q.similarity * 100).toFixed(1)}%</strong> ${q.similarity >= 0.9 ? 'âœ“ é€šéé–€æª» (â‰¥90%)' : 'âœ— æœªé”é–€æª» (<90%)'}
                                        <br>â€¢ åˆ†æ•¸å·®è·ï¼š<strong>${q.scoreDiff || 0}</strong> åˆ† (${((q.scoreDiffPercent || 0) * 100).toFixed(1)}%) ${((q.scoreDiffPercent || 0) * 100) < 10 ? 'âœ“ é€šéé–€æª» (<10%)' : 'âœ— æœªé”é–€æª» (â‰¥10%)'}
                                        <br><br>
                                        <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px;">
                                            âœ“ èªæ„ç›¸ä¼¼åº¦ AND åˆ†æ•¸å·®è·éƒ½é€šé â†’ é”æˆå…±è­˜
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- è©•åˆ†è©³æƒ… -->
                                <div style="background: rgba(255, 255, 255, 0.7); padding: 12px; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #155724; font-weight: 600; margin-bottom: 6px;">ğŸ¯ è©•åˆ†è©³æƒ…</div>
                                    <div style="font-size: 12px; color: #155724;">
                                        â€¢ GPT-4ï¼š<strong>${q.gptScore}</strong> åˆ†
                                        <br>â€¢ Claude-3.5ï¼š<strong>${q.claudeScore}</strong> åˆ†
                                        <br>â€¢ æœ€çµ‚åˆ†æ•¸ï¼ˆå¹³å‡ï¼‰ï¼š<strong style="font-size: 16px; color: #28a745;">${q.finalScore}</strong> åˆ†
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (needArbitration) {
                        // éœ€è¦ Gemini ä»²è£
                        statusHtml = `
                            <div style="background: #fff3cd; padding: 16px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                <div style="font-weight: 600; color: #856404; margin-bottom: 12px; font-size: 14px;">âš–ï¸ Gemini ä»²è£</div>
                                
                                <!-- ä»²è£åŸå›  -->
                                <div style="background: rgba(255, 255, 255, 0.7); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                                    <div style="font-size: 12px; color: #856404; font-weight: 600; margin-bottom: 6px;">ğŸ“‹ ä»²è£åŸå› </div>
                                    <div style="font-size: 12px; color: #856404;">
                                        ç¶“é ${q.consensusRounds || 2} å›åˆå…±è­˜ä»æœªé”ä¸€è‡´
                                        <br>â€¢ èªæ„ç›¸ä¼¼åº¦ï¼š${q.similarity && !isNaN(q.similarity) ? (q.similarity * 100).toFixed(1) + '%' : 'ç„¡æ³•è¨ˆç®—'} ${q.similarity && q.similarity < 0.9 ? 'âŒ ä½æ–¼é–€æª» (90%)' : q.similarity ? 'âœ“' : ''}
                                        <br>â€¢ åˆ†æ•¸å·®è·ï¼š${q.scoreDiff || 0} åˆ† (${((q.scoreDiffPercent || 0) * 100).toFixed(1)}%) ${(q.scoreDiffPercent || 0) >= 0.3 ? 'âŒ è¶…éé–€æª» (30%)' : 'âœ“'}
                                    </div>
                                </div>
                                
                                <!-- é›™æ–¹è©•åˆ† -->
                                <div style="background: rgba(255, 255, 255, 0.7); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                                    <div style="font-size: 12px; color: #856404; font-weight: 600; margin-bottom: 6px;">ğŸ¤– é›™æ–¹è©•åˆ†</div>
                                    <div style="font-size: 12px; color: #856404;">
                                        â€¢ GPT-4 è©•åˆ†ï¼š<strong>${q.gptScore}</strong> åˆ†
                                        <br>â€¢ Claude-3.5 è©•åˆ†ï¼š<strong>${q.claudeScore}</strong> åˆ†
                                        <br>â€¢ åˆ†æ•¸å·®ç•°ï¼š<strong>${Math.abs(q.gptScore - q.claudeScore)}</strong> åˆ†
                                    </div>
                                </div>
                                
                                <!-- Gemini è£æ±º -->
                                <div style="background: rgba(255, 255, 255, 0.7); padding: 12px; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #856404; font-weight: 600; margin-bottom: 6px;">âš–ï¸ Gemini è£æ±º</div>
                                    <div style="font-size: 12px; color: #856404;">
                                        æœ€çµ‚åˆ†æ•¸ï¼š<strong style="font-size: 16px; color: #d68910;">${q.arbitrationScore || q.finalScore}</strong> åˆ†
                                        <br><br>
                                        <div style="background: white; padding: 10px; border-radius: 4px; margin-top: 8px;">
                                            <strong>ä»²è£ç†ç”±ï¼š</strong>
                                            <div style="margin-top: 6px; white-space: pre-wrap; line-height: 1.5;">
${q.arbitrationFeedback || 'ç³»çµ±æ¡ç”¨ Gemini ç¶œåˆè©•ä¼°å¾Œçš„åˆ†æ•¸'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (q.needConsensus && q.reachedConsensus) {
                        // å…±è­˜å›åˆå¾Œé”æˆå…±è­˜
                        statusHtml = `
                            <div style="background: #e3f2fd; padding: 16px; border-radius: 8px; border-left: 4px solid #2196f3;">
                                <div style="font-weight: 600; color: #1565c0; margin-bottom: 12px; font-size: 14px;">ğŸ¤ å…±è­˜å›åˆé”æˆä¸€è‡´</div>
                                
                                <!-- å…±è­˜éç¨‹ -->
                                <div style="background: rgba(255, 255, 255, 0.7); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                                    <div style="font-size: 12px; color: #1565c0; font-weight: 600; margin-bottom: 6px;">ğŸ“ å…±è­˜éç¨‹</div>
                                    <div style="font-size: 12px; color: #1565c0;">
                                        åˆæ¬¡æ‰¹æ”¹æ„è¦‹ä¸ä¸€è‡´ï¼Œé€²å…¥å…±è­˜å›åˆ
                                        <br>ç¶“é <strong>${q.consensusRounds || 1}</strong> å›åˆè¨è«–å¾Œï¼Œé›™æ–¹æ„è¦‹è¶¨æ–¼ä¸€è‡´
                                        <br><br>
                                        <span style="background: #2196f3; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px;">å·²é”æˆå…±è­˜ï¼Œç„¡é ˆä»²è£</span>
                                    </div>
                                </div>
                                
                                <!-- æœ€çµ‚è©•åˆ† -->
                                <div style="background: rgba(255, 255, 255, 0.7); padding: 12px; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #1565c0; font-weight: 600; margin-bottom: 6px;">ğŸ¯ æœ€çµ‚è©•åˆ†</div>
                                    <div style="font-size: 12px; color: #1565c0;">
                                        â€¢ GPT-4ï¼ˆèª¿æ•´å¾Œï¼‰ï¼š<strong>${q.gptScore}</strong> åˆ†
                                        <br>â€¢ Claude-3.5ï¼ˆèª¿æ•´å¾Œï¼‰ï¼š<strong>${q.claudeScore}</strong> åˆ†
                                        <br>â€¢ æœ€çµ‚åˆ†æ•¸ï¼ˆå¹³å‡ï¼‰ï¼š<strong style="font-size: 16px; color: #2196f3;">${q.finalScore}</strong> åˆ†
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // å…¶ä»–æƒ…æ³
                        statusHtml = `
                            <div style="background: #f8f9fa; padding: 12px 16px; border-radius: 6px; border-left: 3px solid #6c757d;">
                                <div style="font-size: 12px; color: #495057;">
                                    GPT: ${q.gptScore} åˆ† | Claude: ${q.claudeScore} åˆ† â†’ æœ€çµ‚: ${q.finalScore} åˆ†
                                </div>
                            </div>
                        `;
                    }
                    
                    return `
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 14px; font-weight: 500; color: #495057; margin-bottom: 8px;">
                                ç¬¬ ${questionNum} é¡Œ
                            </div>
                            ${statusHtml}
                        </div>
                    `;
                }).join('');
            }
            
            // å¦‚æœæ˜¯å–®é¡Œæ‰¹æ”¹ï¼Œé¡¯ç¤ºç°¡å–®è¨Šæ¯
            return `
                <div style="background: #f8f9fa; padding: 16px; border-radius: 6px; text-align: center; color: #6c757d;">
                    ${aiResult.arbitrationReason || 'å–®é¡Œæ‰¹æ”¹æ¨¡å¼'}
                </div>
            `;
        }
        
        // æŸ¥çœ‹ AI æ‰¹æ”¹è©³æƒ…
        async function viewAIGradingDetails(id) {
            const item = allSubmissions.find(s => s.id === id);
            if (!item) return;

            // å¾ Firestore è®€å–å®Œæ•´æ‰¹æ”¹çµæœ
            try {
                const doc = await db.collection('grading_events').doc(id).get();
                if (!doc.exists) {
                    showErrorToast('æ‰¾ä¸åˆ°æ‰¹æ”¹è¨˜éŒ„');
                return;
            }

                const data = doc.data();
                const aiResult = data.ai_result || {};

                // å‰µå»ºè©³æƒ…è¦–çª—
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.75);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 20000;
                    animation: fadeIn 0.3s ease;
                `;

                modal.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 12px;
                        width: 95%;
                        max-width: 1200px;
                        max-height: 90vh;
                        overflow: hidden;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        display: flex;
                        flex-direction: column;
                    ">
                        <!-- æ¨™é¡Œæ¬„ -->
                        <div style="
                            padding: 20px 24px;
                            background: #f8f9fa;
                            border-bottom: 2px solid #4A90E2;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <div>
                                <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #2c3e50;">
                                    ğŸ“Š AI æ‰¹æ”¹è©³ç´°å ±å‘Š
                                </h2>
                                <p style="margin: 6px 0 0 0; font-size: 13px; color: #7f8c8d;">
                                    å­¸ç”Ÿï¼š${item.studentName} | ä½œæ¥­ï¼š${item.assignmentTitle}
                                </p>
                            </div>
                            <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="
                                background: #e9ecef;
                                border: 1px solid #dee2e6;
                                color: #6c757d;
                                width: 32px;
                                height: 32px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 18px;
                            ">Ã—</button>
                        </div>

                        <!-- å…§å®¹å€ -->
                        <div style="flex: 1; overflow-y: auto; padding: 24px; background: #f8f9fa;">
                            
                            <!-- æ‰¹æ”¹ç¸½çµ -->
                            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #4A90E2;">
                                <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #2c3e50;">ğŸ“ˆ æ‰¹æ”¹ç¸½çµ</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                    <div>
                                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 4px;">æœ€çµ‚åˆ†æ•¸</div>
                                        ${(() => {
                                            const totalScore = data.total_score || aiResult.totalScore || aiResult.finalScore || 0;
                                            const maxScore = data.max_total_score || aiResult.maxTotalScore || 100;
                                            const percentage = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;
                                            return `
                                                <div style="font-size: 24px; font-weight: 600; color: #4A90E2;">${totalScore}/${maxScore} åˆ†</div>
                                                <div style="font-size: 14px; color: #7f8c8d; margin-top: 4px;">ç™¾åˆ†åˆ¶ï¼š${percentage} åˆ†</div>
                                            `;
                                        })()}
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 4px;">æ‰¹æ”¹æ–¹å¼</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #2c3e50;">${data.graded_by || 'ä¸‰ä»£ç†äºº AI'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 4px;">æ˜¯å¦ä»²è£</div>
                                        <div style="font-size: 14px; font-weight: 500; color: ${data.need_arbitration ? '#ff9800' : '#4caf50'};">
                                            ${data.need_arbitration ? 'âš–ï¸ æ˜¯' : 'âœ“ å¦'}
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 4px;">æ‰¹æ”¹æ™‚é–“</div>
                                        <div style="font-size: 14px; font-weight: 500; color: #2c3e50;">
                                            ${data.graded_at ? new Date(data.graded_at.toDate()).toLocaleString('zh-TW') : 'æœªçŸ¥'}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- GPT-4 è©•åˆ† -->
                            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #10a37f;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h3 style="margin: 0; font-size: 16px; color: #2c3e50;">ğŸ¤– GPT-4 è©•åˆ†</h3>
                                    <span style="font-size: 20px; font-weight: 600; color: #10a37f;">${data.gpt_score || aiResult.gptScore || 0} åˆ†</span>
                                </div>
                                <div style="background: #f8f9fa; padding: 14px; border-radius: 6px; font-size: 13px; line-height: 1.6; color: #4a5568; white-space: pre-wrap;">
${data.gpt_feedback || aiResult.gptFeedback || 'ç„¡è©•èª'}
                                </div>
                            </div>

                            <!-- Claude-3.5 è©•åˆ† -->
                            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #8b5cf6;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h3 style="margin: 0; font-size: 16px; color: #2c3e50;">ğŸ¤– Claude-3.5 è©•åˆ†</h3>
                                    <span style="font-size: 20px; font-weight: 600; color: #8b5cf6;">${data.claude_score || aiResult.claudeScore || 0} åˆ†</span>
                                </div>
                                <div style="background: #f8f9fa; padding: 14px; border-radius: 6px; font-size: 13px; line-height: 1.6; color: #4a5568; white-space: pre-wrap;">
${data.claude_feedback || aiResult.claudeFeedback || 'ç„¡è©•èª'}
                                </div>
                            </div>

                            <!-- é€é¡Œå…±è­˜/ä»²è£ç‹€æ…‹ -->
                            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #e9ecef;">
                                <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #2c3e50;">ğŸ” æ‰¹æ”¹æµç¨‹è©³æƒ…</h3>
                                ${generateQuestionDetails(aiResult)}
                            </div>

                            <!-- æœ€çµ‚è©•èª -->
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #4A90E2;">
                                <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #2c3e50;">ğŸ“ æœ€çµ‚è©•èª</h3>
                                <div style="background: #f8f9fa; padding: 14px; border-radius: 6px; font-size: 13px; line-height: 1.6; color: #4a5568; white-space: pre-wrap;">
${data.feedback || aiResult.finalFeedback || 'ç„¡è©•èª'}
                                </div>
                            </div>

                        </div>

                        <!-- åº•éƒ¨æŒ‰éˆ• -->
                        <div style="
                            padding: 16px 24px;
                            background: #f8f9fa;
                            border-top: 1px solid #dee2e6;
                            display: flex;
                            justify-content: flex-end;
                        ">
                            <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="
                                padding: 10px 24px;
                                background: #4A90E2;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-weight: 500;
                                font-size: 14px;
                            ">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

            } catch (error) {
                console.error('è®€å–æ‰¹æ”¹è©³æƒ…å¤±æ•—:', error);
                showErrorToast('è®€å–æ‰¹æ”¹è©³æƒ…å¤±æ•—ï¼š' + error.message);
            }
        }

        // æŸ¥çœ‹æ‰¹æ”¹æ­·å²
        async function viewGradingHistory(id) {
            const item = allSubmissions.find(s => s.id === id);
            if (!item) return;

            try {
                const historyRecords = [];
                
                // å¾ grading_events è®€å–è©²ä½œæ¥­çš„æ‰¹æ”¹è¨˜éŒ„ï¼ˆdoc.id = submission_idï¼‰
                const eventDoc = await db.collection('grading_events').doc(id).get();
                
                // åŠ å…¥æ‰¹æ”¹äº‹ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (eventDoc.exists) {
                    const data = eventDoc.data();
                    historyRecords.push({
                        id: eventDoc.id,
                        type: 'grading',
                        timestamp: data.graded_at,
                        score: data.total_score,
                        ai_result: data.ai_result,
                        gpt_score: data.gpt_score,
                        claude_score: data.claude_score,
                        need_arbitration: data.need_arbitration,
                        total_questions: data.total_questions,
                        arbitrated_questions: data.arbitrated_questions,
                        consensus_questions: data.consensus_questions,
                        data: data
                    });
                }

                // å˜—è©¦å¾ grading_logs è®€å–æ—¥èªŒè¨˜éŒ„ï¼ˆå¦‚æœç´¢å¼•å·²å»ºç«‹ï¼‰
                try {
                    const logsSnapshot = await db.collection('grading_logs')
                        .where('submission_id', '==', id)
                        .orderBy('created_at', 'desc')
                        .get();
                    
                    logsSnapshot.forEach(doc => {
                        const data = doc.data();
                        historyRecords.push({
                            id: doc.id,
                            type: 'log',
                            timestamp: data.created_at,
                            logs: data.logs,
                            total_logs: data.total_logs
                        });
                    });
                } catch (indexError) {
                    console.warn('âš ï¸ grading_logs ç´¢å¼•å°šæœªå»ºç«‹ï¼Œè·³éæ—¥èªŒæŸ¥è©¢:', indexError.message);
                    // ä¸å½±éŸ¿æ‰¹æ”¹è¨˜éŒ„çš„é¡¯ç¤º
                }

                // æŒ‰æ™‚é–“æ’åº
                historyRecords.sort((a, b) => {
                    const timeA = a.timestamp?.toDate?.() || new Date(0);
                    const timeB = b.timestamp?.toDate?.() || new Date(0);
                    return timeB - timeA;
                });

                // å‰µå»ºæ­·å²è¦–çª—
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.75);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 20000;
                    animation: fadeIn 0.3s ease;
                `;

                modal.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 12px;
                        width: 95%;
                        max-width: 1200px;
                        max-height: 90vh;
                        overflow: hidden;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        display: flex;
                        flex-direction: column;
                    ">
                        <!-- æ¨™é¡Œæ¬„ -->
                        <div style="
                            padding: 20px 24px;
                            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
                            color: white;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <div>
                                <h2 style="margin: 0; font-size: 18px; font-weight: 600;">
                                    ğŸ“œ æ‰¹æ”¹æ­·å²è¨˜éŒ„
                                </h2>
                                <p style="margin: 6px 0 0 0; font-size: 13px; opacity: 0.9;">
                                    å­¸ç”Ÿï¼š${item.studentName} | ä½œæ¥­ï¼š${item.assignmentTitle}
                                </p>
                            </div>
                            <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: 1px solid rgba(255, 255, 255, 0.3);
                                color: white;
                                width: 32px;
                                height: 32px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 18px;
                            ">Ã—</button>
                        </div>

                        <!-- å…§å®¹å€ -->
                        <div style="flex: 1; overflow-y: auto; padding: 24px; background: #f8f9fa;">
                            ${historyRecords.length === 0 ? `
                                <div style="text-align: center; padding: 48px; color: #7f8c8d;">
                                    <svg viewBox="0 0 20 20" fill="none" style="width: 48px; height: 48px; margin: 0 auto 16px; opacity: 0.5;">
                                        <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.5"/>
                                        <path d="M10 5v5l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                    </svg>
                                    <p style="font-size: 16px;">å°šç„¡æ‰¹æ”¹è¨˜éŒ„</p>
                                </div>
                            ` : historyRecords.map((record, index) => {
                                const timestamp = record.timestamp?.toDate?.() || new Date();
                                const timeStr = timestamp.toLocaleString('zh-TW', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit'
                                });

                                if (record.type === 'grading') {
                                    const hasResults = record.ai_result?.results && Array.isArray(record.ai_result.results);
                                    const totalQuestions = hasResults ? record.ai_result.results.length : (record.total_questions || 0);
                                    const arbitratedCount = hasResults ? record.ai_result.results.filter(q => q.arbitrated).length : (record.arbitrated_questions || 0);
                                    const consensusCount = hasResults ? record.ai_result.results.filter(q => q.directConsensus || q.reachedConsensus).length : (record.consensus_questions || 0);

                                    return `
                                        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #4A90E2;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                <h4 style="margin: 0; font-size: 15px; color: #2c3e50;">
                                                    ğŸ“Š æ‰¹æ”¹è¨˜éŒ„ #${index + 1}
                                                </h4>
                                                <span style="font-size: 12px; color: #7f8c8d;">${timeStr}</span>
                                            </div>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px;">
                                                <div>
                                                    <div style="font-size: 11px; color: #7f8c8d;">æœ€çµ‚åˆ†æ•¸</div>
                                                    <div style="font-size: 18px; font-weight: 600; color: #4A90E2;">${record.score || 0} åˆ†</div>
                                                </div>
                                                ${hasResults ? `
                                                <div>
                                                    <div style="font-size: 11px; color: #7f8c8d;">é¡Œç›®æ•¸é‡</div>
                                                    <div style="font-size: 14px; font-weight: 500; color: #2c3e50;">${totalQuestions} é¡Œ</div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 11px; color: #7f8c8d;">å…±è­˜é¡Œæ•¸</div>
                                                    <div style="font-size: 14px; font-weight: 500; color: #4caf50;">${consensusCount} é¡Œ</div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 11px; color: #7f8c8d;">ä»²è£é¡Œæ•¸</div>
                                                    <div style="font-size: 14px; font-weight: 500; color: #ff9800;">${arbitratedCount} é¡Œ</div>
                                                </div>
                                                ` : `
                                                <div>
                                                    <div style="font-size: 11px; color: #7f8c8d;">GPT åˆ†æ•¸</div>
                                                    <div style="font-size: 14px; font-weight: 500; color: #10a37f;">${record.gpt_score || 0} åˆ†</div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 11px; color: #7f8c8d;">Claude åˆ†æ•¸</div>
                                                    <div style="font-size: 14px; font-weight: 500; color: #8b5cf6;">${record.claude_score || 0} åˆ†</div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 11px; color: #7f8c8d;">æ˜¯å¦ä»²è£</div>
                                                    <div style="font-size: 14px; font-weight: 500; color: ${record.need_arbitration ? '#ff9800' : '#4caf50'};">
                                                        ${record.need_arbitration ? 'æ˜¯' : 'å¦'}
                                                    </div>
                                                </div>
                                                `}
                                            </div>
                                            <button onclick="viewAIGradingDetails('${id}')" style="
                                                width: 100%;
                                                padding: 10px;
                                                background: #4A90E2;
                                                color: white;
                                                border: none;
                                                border-radius: 4px;
                                                cursor: pointer;
                                                font-size: 13px;
                                                font-weight: 500;
                                            ">
                                                æŸ¥çœ‹å®Œæ•´è©³æƒ…
                                            </button>
                                        </div>
                                    `;
                                } else if (record.type === 'log') {
                                    return `
                                        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #26a69a;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                <h4 style="margin: 0; font-size: 15px; color: #2c3e50;">
                                                    ğŸ“ æ‰¹æ”¹æ—¥èªŒ #${index + 1}
                                                </h4>
                                                <span style="font-size: 12px; color: #7f8c8d;">${timeStr}</span>
                                            </div>
                                            <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 12px;">
                                                å…± ${record.total_logs || 0} æ¢æ—¥èªŒ
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <button onclick="viewGradingLog('${record.id}')" style="
                                                    flex: 1;
                                                    padding: 10px;
                                                    background: #26a69a;
                                                    color: white;
                                                    border: none;
                                                    border-radius: 4px;
                                                    cursor: pointer;
                                                    font-size: 13px;
                                                    font-weight: 500;
                                                ">
                                                    ğŸ“‹ æŸ¥çœ‹å®Œæ•´æ—¥èªŒ
                                                </button>
                                                <button onclick="deleteGradingLog('${record.id}', '${id}')" style="
                                                    padding: 10px 16px;
                                                    background: #f44336;
                                                    color: white;
                                                    border: none;
                                                    border-radius: 4px;
                                                    cursor: pointer;
                                                    font-size: 13px;
                                                    font-weight: 500;
                                                ">
                                                    ğŸ—‘ï¸ åˆªé™¤
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }
                            }).join('')}
                        </div>

                        <!-- åº•éƒ¨æŒ‰éˆ• -->
                        <div style="
                            padding: 16px 24px;
                            background: #f8f9fa;
                            border-top: 1px solid #dee2e6;
                            display: flex;
                            justify-content: flex-end;
                        ">
                            <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="
                                padding: 10px 24px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            ">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

            } catch (error) {
                console.error('è®€å–æ‰¹æ”¹æ­·å²å¤±æ•—:', error);
                showErrorToast('è®€å–æ‰¹æ”¹æ­·å²å¤±æ•—ï¼š' + error.message);
            }
        }

        // æŸ¥çœ‹æ‰¹æ”¹æ—¥èªŒè©³æƒ…
        async function viewGradingLog(logId) {
            try {
                const doc = await db.collection('grading_logs').doc(logId).get();
                if (!doc.exists) {
                    showErrorToast('æ‰¾ä¸åˆ°æ—¥èªŒè¨˜éŒ„');
                    return;
                }

                const data = doc.data();
                const logs = data.logs || [];

                // å‰µå»ºæ—¥èªŒè¦–çª—
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.75);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 30000;
                    animation: fadeIn 0.3s ease;
                `;

                const timestamp = data.created_at?.toDate?.() || new Date();
                const timeStr = timestamp.toLocaleString('zh-TW');

                modal.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 12px;
                        width: 90%;
                        max-width: 900px;
                        max-height: 85vh;
                        overflow: hidden;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        display: flex;
                        flex-direction: column;
                    ">
                        <!-- æ¨™é¡Œæ¬„ -->
                        <div style="
                            padding: 20px 24px;
                            background: linear-gradient(135deg, #26a69a 0%, #00897b 100%);
                            color: white;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <div>
                                <h2 style="margin: 0; font-size: 18px; font-weight: 600;">ğŸ“ æ‰¹æ”¹æ—¥èªŒ</h2>
                                <p style="margin: 6px 0 0 0; font-size: 13px; opacity: 0.9;">${timeStr} | å…± ${logs.length} æ¢</p>
                            </div>
                            <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="
                                background: rgba(255, 255, 255, 0.2);
                                border: 1px solid rgba(255, 255, 255, 0.3);
                                color: white;
                                width: 32px;
                                height: 32px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 18px;
                            ">Ã—</button>
                        </div>

                        <!-- æ—¥èªŒå…§å®¹ -->
                        <div style="flex: 1; overflow-y: auto; padding: 24px; background: #f8f9fa;">
                            ${logs.map((log, index) => {
                                const typeColors = {
                                    'info': '#2196f3',
                                    'success': '#4caf50',
                                    'warning': '#ff9800',
                                    'error': '#f44336',
                                    'ai': '#9c27b0'
                                };
                                const color = typeColors[log.type] || '#757575';
                                
                                return `
                                    <div style="
                                        background: white;
                                        padding: 12px 16px;
                                        border-radius: 6px;
                                        margin-bottom: 8px;
                                        border-left: 3px solid ${color};
                                        display: flex;
                                        align-items: flex-start;
                                        gap: 12px;
                                    ">
                                        <span style="
                                            font-size: 16px;
                                            min-width: 24px;
                                        ">${log.icon || 'ğŸ“'}</span>
                                        <div style="flex: 1;">
                                            <div style="font-size: 13px; color: #2c3e50; line-height: 1.5; white-space: pre-wrap;">${log.message}</div>
                                            ${log.timestamp ? `
                                                <div style="font-size: 11px; color: #95a5a6; margin-top: 4px;">
                                                    ${new Date(log.timestamp).toLocaleTimeString('zh-TW')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <!-- åº•éƒ¨æŒ‰éˆ• -->
                        <div style="
                            padding: 16px 24px;
                            background: #f8f9fa;
                            border-top: 1px solid #dee2e6;
                            display: flex;
                            justify-content: flex-end;
                        ">
                            <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="
                                padding: 10px 24px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 500;
                            ">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

            } catch (error) {
                console.error('è®€å–æ‰¹æ”¹æ—¥èªŒå¤±æ•—:', error);
                showErrorToast('è®€å–æ‰¹æ”¹æ—¥èªŒå¤±æ•—ï¼š' + error.message);
            }
        }

        // åˆªé™¤æ‰¹æ”¹æ—¥èªŒ
        async function deleteGradingLog(logId, submissionId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ‰¹æ”¹æ—¥èªŒå—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                return;
            }

            try {
                await db.collection('grading_logs').doc(logId).delete();
                showSuccessToast('âœ“ æ‰¹æ”¹æ—¥èªŒå·²åˆªé™¤');
                
                // é—œé–‰ç•¶å‰è¦–çª—ä¸¦é‡æ–°æ‰“é–‹ï¼ˆåˆ·æ–°åˆ—è¡¨ï¼‰
                const modal = document.querySelector('div[style*="position: fixed"]');
                if (modal) {
                    modal.remove();
                }
                
                // å»¶é²ä¸€ä¸‹å†é‡æ–°æ‰“é–‹ï¼Œç¢ºä¿åˆªé™¤å®Œæˆ
                setTimeout(() => {
                    viewGradingHistory(submissionId);
                }, 300);
                
            } catch (error) {
                console.error('åˆªé™¤æ‰¹æ”¹æ—¥èªŒå¤±æ•—:', error);
                showErrorToast('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // å¥—ç”¨æç¤ºè©å»ºè­°
        async function applyPromptSuggestion(submissionId) {
            try {
                const submission = allSubmissions.find(s => s.id === submissionId);
                if (!submission || !submission.ai_result || !submission.ai_result.promptSuggestion) {
                    showErrorToast('æ‰¾ä¸åˆ°æç¤ºè©å»ºè­°');
                    return;
                }
                
                const suggestion = submission.ai_result.promptSuggestion;
                const newPrompt = suggestion.updatedPrompt;
                
                if (!newPrompt) {
                    showErrorToast('æ²’æœ‰æ–°çš„æç¤ºè©å¯å¥—ç”¨');
                    return;
                }
                
                if (!confirm('ç¢ºå®šè¦å¥—ç”¨ Gemini å»ºè­°çš„æ–°æç¤ºè©å—ï¼Ÿ\n\nåŸæç¤ºè©å°‡è¢«æ›´æ–°ã€‚')) {
                    return;
                }
                
                // å„²å­˜åˆ° localStorage
                localStorage.setItem('customGradingPrompt', newPrompt);
                
                // æ›´æ–°ç·¨è¼¯å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const promptEditor = document.getElementById('customPromptEditor');
                if (promptEditor) {
                    promptEditor.value = newPrompt;
                }
                
                showSuccessToast('âœ“ æç¤ºè©å·²æ›´æ–°ï¼ä¸‹æ¬¡æ‰¹æ”¹å°‡ä½¿ç”¨æ–°ç‰ˆæœ¬');
                
                addLog('âœ…', 'æç¤ºè©å·²å¥—ç”¨ä¸¦å„²å­˜', 'success');
                
            } catch (error) {
                console.error('å¥—ç”¨æç¤ºè©å¤±æ•—:', error);
                showErrorToast('å¥—ç”¨æç¤ºè©å¤±æ•—ï¼š' + error.message);
            }
        }

        // åŸ·è¡Œ AI æ‰¹æ”¹
        async function executeAIGrading(id) {
            const item = allSubmissions.find(s => s.id === id);
            if (!item) return;

            const logContent = document.getElementById('gradingLogContent');
            const startBtn = document.getElementById('startGradingBtn');
            
            // ç¦ç”¨æŒ‰éˆ•
            startBtn.disabled = true;
            startBtn.style.opacity = '0.5';
            startBtn.style.cursor = 'not-allowed';

            // æ‰¹æ”¹æ—¥èªŒæ”¶é›†å™¨
            const gradingLogs = [];
            
            // æ·»åŠ æ—¥èªŒå‡½æ•¸
            function addLog(icon, message, type = 'info') {
                const colors = {
                    info: '#2196F3',
                    success: '#4CAF50',
                    warning: '#FF9800',
                    error: '#F44336',
                    ai: '#9C27B0'
                };
                
                const timestamp = new Date().toISOString();
                
                // è¨˜éŒ„åˆ°æ—¥èªŒé™£åˆ—
                gradingLogs.push({
                    icon,
                    message,
                    type,
                    timestamp
                });
                
                const logItem = document.createElement('div');
                logItem.style.cssText = `
                    background: white;
                    padding: 16px;
                    border-radius: 8px;
                    margin-bottom: 12px;
                    border-left: 4px solid ${colors[type]};
                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    animation: slideInRight 0.3s ease;
                `;
                logItem.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 24px;">${icon}</span>
                        <div style="flex: 1;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                                ${new Date().toLocaleTimeString('zh-TW')}
                            </div>
                            <div style="font-size: 14px; color: #333; white-space: pre-wrap;">${message}</div>
                        </div>
                    </div>
                `;
                logContent.appendChild(logItem);
                logContent.scrollTop = logContent.scrollHeight;
            }

            // æ¸…ç©ºç‹€æ…‹
            logContent.innerHTML = '';

            try {
                addLog('ğŸš€', 'é–‹å§‹ä¸‰ä»£ç†äºº AI æ‰¹æ”¹æµç¨‹...', 'info');
                addLog('ğŸ“', `é¡Œç›®ï¼š${item.assignmentTitle}\næ»¿åˆ†ï¼š${item.totalPoints || 100} åˆ†`, 'info');

                // === æ­¥é©Ÿ 1ï¼šå®‰å…¨æª¢æŸ¥ ===
                addLog('ğŸ›¡ï¸', 'åŸ·è¡Œå®‰å…¨æª¢æŸ¥ä»£ç†äºº...', 'info');
                addLog('ğŸ“š', 'æ­£åœ¨è¼‰å…¥æƒ¡æ„æ¨£æœ¬è³‡æ–™åº«ä¸¦å­¸ç¿’...', 'info');

                try {
                    const securityCheckUrl = 'https://us-central1-YOUR_PROJECT_ID.cloudfunctions.net/securityCheck';
                    const securityResponse = await fetch(securityCheckUrl, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            question: item.assignmentTitle,
                            answer: item.content
                        })
                    });

                    if (!securityResponse.ok) {
                        throw new Error(`å®‰å…¨æª¢æŸ¥ API éŒ¯èª¤: ${securityResponse.status}`);
                    }

                    const securityResult = await securityResponse.json();
                    
                    if (securityResult.success) {
                        if (securityResult.is_attack) {
                            // æª¢æ¸¬åˆ°æ”»æ“Šè¡Œç‚º
                            addLog('âš ï¸', `æª¢æ¸¬åˆ°æƒ¡æ„æç¤ºè©æ³¨å…¥æ”»æ“Šï¼\né¡å‹ï¼š${securityResult.reason}`, 'error');
                            addLog('ğŸš«', 'åŸºæ–¼å®‰å…¨è€ƒé‡ï¼Œå·²æ‹’çµ•æ‰¹æ”¹æ­¤ä½œæ¥­', 'error');
                            
                            // è¨˜éŒ„åˆ°è³‡æ–™åº«
                            await db.collection('grading_events').doc(id).update({
                                status: 'rejected',
                                rejection_reason: 'æª¢æ¸¬åˆ°æƒ¡æ„æç¤ºè©æ³¨å…¥æ”»æ“Š',
                                security_check: securityResult,
                                checked_at: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            showErrorToast('âš ï¸ æª¢æ¸¬åˆ°æƒ¡æ„æ”»æ“Šè¡Œç‚ºï¼Œå·²æ‹’çµ•æ‰¹æ”¹');
                            
                            // æ¢å¾©æŒ‰éˆ•
                            startBtn.disabled = false;
                            startBtn.style.opacity = '1';
                            startBtn.style.cursor = 'pointer';
                            startBtn.textContent = 'é–‹å§‹æ‰¹æ”¹';
                            return;
                        } else {
                            // å®‰å…¨é€šé
                            addLog('âœ“', `å®‰å…¨æª¢æŸ¥é€šé\næª¢æŸ¥åŸå› ï¼š${securityResult.reason}`, 'success');
                        }
                    } else {
                        // å®‰å…¨æª¢æŸ¥å¤±æ•—ï¼Œè¨˜éŒ„ä½†ç¹¼çºŒæ‰¹æ”¹
                        addLog('âš ï¸', 'å®‰å…¨æª¢æŸ¥æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œå°‡ç¹¼çºŒæ‰¹æ”¹æµç¨‹', 'warning');
                    }
                } catch (securityError) {
                    // å®‰å…¨æª¢æŸ¥å¤±æ•—ï¼Œè¨˜éŒ„ä½†ç¹¼çºŒæ‰¹æ”¹
                    addLog('âš ï¸', `å®‰å…¨æª¢æŸ¥æœå‹™é€£ç·šå¤±æ•—ï¼ˆ${securityError.message}ï¼‰ï¼Œå°‡ç¹¼çºŒæ‰¹æ”¹æµç¨‹`, 'warning');
                }

                // === æ­¥é©Ÿ 2ï¼šç²å–è©•åˆ†æç¤ºè© ===
                const customPrompt = getCurrentPrompt();
                const promptPreview = customPrompt.length > 100 ? 
                    customPrompt.substring(0, 100) + '...' : customPrompt;
                addLog('ğŸ“‹', `ä½¿ç”¨è©•åˆ†æç¤ºè©ï¼š${promptPreview}`, 'info');

                // === æ­¥é©Ÿ 3ï¼šæº–å‚™æ‰¹æ”¹è³‡æ–™ ===
                // å°‡ answers ç‰©ä»¶è½‰æ›ç‚ºé™£åˆ—æ ¼å¼
                const questions = [];
                const answers = [];
                
                if (item.answers && typeof item.answers === 'object') {
                    const answerKeys = Object.keys(item.answers);
                    const totalQuestions = answerKeys.length;
                    const totalPoints = item.totalPoints || 100;
                    
                    // å¹³å‡åˆ†é…åˆ†æ•¸ï¼Œç¢ºä¿ç¸½å’Œ = totalPoints
                    const baseScore = Math.floor(totalPoints / totalQuestions);
                    const remainder = totalPoints - (baseScore * totalQuestions);
                    
                    addLog('ğŸ“', `æª¢æ¸¬åˆ° ${totalQuestions} å€‹é¡Œç›®ï¼Œç¸½åˆ† ${totalPoints} åˆ†ï¼Œå¹³å‡æ¯é¡Œ ${baseScore} åˆ†`, 'info');
                    
                    answerKeys.forEach((questionText, idx) => {
                        // ç¬¬ä¸€é¡ŒåŠ ä¸Šé¤˜æ•¸ï¼Œç¢ºä¿ç¸½å’Œæ­£ç¢º
                        const maxScore = idx === 0 ? baseScore + remainder : baseScore;
                        questions.push({
                            text: questionText,
                            maxScore: maxScore
                        });
                        answers.push(item.answers[questionText]);
                    });
                    
                    const checkSum = questions.reduce((sum, q) => sum + q.maxScore, 0);
                    console.log(`âœ… åˆ†æ•¸åˆ†é…: ${questions.map((q, i) => `Q${i+1}=${q.maxScore}`).join(', ')} = ${checkSum} åˆ†`);
                } else {
                    // é™ç´šç‚ºå–®é¡Œæ¨¡å¼
                    addLog('âš ï¸', 'ç„¡æ³•è§£æé¡Œç›®çµæ§‹ï¼Œä½¿ç”¨å–®é¡Œæ‰¹æ”¹æ¨¡å¼', 'warning');
                    questions.push({
                        text: item.assignmentTitle,
                        maxScore: item.totalPoints || 100
                    });
                    answers.push(item.content);
                }
                
                // === æ­¥é©Ÿ 4ï¼šAI æ‰¹æ”¹ ===
                addLog('ğŸ¤–', `å‘¼å«ä¸‰ä»£ç†äºº AI æ‰¹æ”¹ç³»çµ±ï¼ˆ${questions.length} é¡Œï¼‰ä½¿ç”¨ GPT-4o...`, 'ai');
                
                const functionUrl = 'https://us-central1-YOUR_PROJECT_ID.cloudfunctions.net/aiGradeThreeAgent';
                
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        questions: questions,
                        answers: answers,
                        customPrompt: customPrompt
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'æ‰¹æ”¹å¤±æ•—');
                }

                // æª¢æŸ¥æ˜¯å¦ç‚ºé€é¡Œæ‰¹æ”¹çµæœ
                if (result.results && Array.isArray(result.results)) {
                    // é€é¡Œæ‰¹æ”¹æ¨¡å¼
                    addLog('ğŸ“Š', `æ”¶åˆ° ${result.results.length} é¡Œçš„æ‰¹æ”¹çµæœ`, 'success');
                    
                    // é€é¡Œé¡¯ç¤ºçµæœ
                    result.results.forEach((q, idx) => {
                        const questionNum = idx + 1;
                        
                        addLog('ğŸ“', `ç¬¬ ${questionNum} é¡Œï¼šGPT ${q.gptScore} åˆ† | Claude ${q.claudeScore} åˆ†`, 'info');
                        
                        if (q.directConsensus) {
                            const simText = q.similarity && !isNaN(q.similarity) ? `${(q.similarity * 100).toFixed(1)}%` : 'ç„¡æ³•è¨ˆç®—';
                            const scoreDiffPercent = ((q.scoreDiffPercent || 0) * 100).toFixed(1);
                            addLog('âœ“', `ç¬¬ ${questionNum} é¡Œï¼šç›´æ¥å…±è­˜ï¼ˆå¹³å‡ ${q.finalScore} åˆ†ï¼‰\nèªæ„ç›¸ä¼¼åº¦ ${simText} AND åˆ†æ•¸å·®è· ${scoreDiffPercent}% éƒ½é€šéé–€æª»`, 'success');
                        } else if (q.arbitrated) {
                            const simText = q.similarity && !isNaN(q.similarity) ? `${(q.similarity * 100).toFixed(1)}%` : 'ç„¡æ³•è¨ˆç®—';
                            const scoreDiff = q.scoreDiff || Math.abs(q.gptScore - q.claudeScore);
                            addLog('âš–ï¸', `ç¬¬ ${questionNum} é¡Œï¼šGemini ä»²è£\nç¶“é ${q.consensusRounds} å›åˆä»æœªé”ä¸€è‡´\nâ€¢ èªæ„ç›¸ä¼¼åº¦ï¼š${simText}\nâ€¢ åˆ†æ•¸å·®è·ï¼š${scoreDiff} åˆ†\nâ†’ æœ€çµ‚ï¼š${q.arbitrationScore || q.finalScore} åˆ†`, 'warning');
                        } else if (q.reachedConsensus) {
                            addLog('ğŸ¤', `ç¬¬ ${questionNum} é¡Œï¼šå…±è­˜å›åˆé”æˆä¸€è‡´\nç¶“é ${q.consensusRounds} å›åˆ â†’ å¹³å‡ ${q.finalScore} åˆ†`, 'success');
                        }
                    });
                    
                    // è¨ˆç®—ç™¾åˆ†åˆ¶åˆ†æ•¸
                    const percentage = result.maxTotalScore > 0 ? Math.round((result.totalScore / result.maxTotalScore) * 100) : 0;
                    addLog('ğŸ¯', `ç¸½åˆ†ï¼š${result.totalScore}/${result.maxTotalScore} åˆ†ï¼ˆç™¾åˆ†åˆ¶ï¼š${percentage} åˆ†ï¼‰`, 'success');
                } else {
                    // å–®é¡Œæ‰¹æ”¹æ¨¡å¼ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
                    addLog('âœ…', `GPT-4 æ‰¹æ”¹å®Œæˆ\nè©•åˆ†ï¼š${result.gptScore} åˆ†`, 'success');
                    addLog('ğŸ¤–', `Claude-3.5 æ‰¹æ”¹å®Œæˆ\nè©•åˆ†ï¼š${result.claudeScore} åˆ†`, 'success');

                    if (result.needArbitration) {
                        addLog('âš–ï¸', `åˆ†æ•¸å·®ç•°è¼ƒå¤§ï¼Œå•Ÿå‹• Gemini ä»²è£\n${result.arbitrationReason}`, 'warning');
                    } else {
                        addLog('âœ…', `å…©ä½ AI è©•åˆ†ç›¸è¿‘ï¼Œå–å¹³å‡åˆ†\n${result.arbitrationReason}`, 'success');
                    }

                    addLog('ğŸ¯', `æœ€çµ‚åˆ†æ•¸ï¼š${result.finalScore} åˆ†`, 'success');
                }

                // æ›´æ–°æ‰¹æ”¹çµæœåˆ° Firestore
                const updateData = {
                    status: 'completed',
                    graded_at: firebase.firestore.FieldValue.serverTimestamp(),
                    graded_by: result.gradedBy,
                    ai_result: result
                };
                
                // é€é¡Œæ‰¹æ”¹æ¨¡å¼
                if (result.results && Array.isArray(result.results)) {
                    updateData.total_score = result.totalScore;
                    updateData.max_total_score = result.maxTotalScore;
                    updateData.total_questions = result.results.length;
                    
                    // è¨ˆç®—ç¸½é«”çµ±è¨ˆ
                    const arbitratedCount = result.results.filter(q => q.arbitrated).length;
                    const consensusCount = result.results.filter(q => q.directConsensus).length;
                    updateData.arbitrated_questions = arbitratedCount;
                    updateData.consensus_questions = consensusCount;
                    updateData.need_arbitration = arbitratedCount > 0;
                    
                    // å½™ç¸½ GPT/Claude è©•èªï¼ˆå¾é€é¡Œçµæœä¸­çµ„åˆï¼‰
                    let gptTotalScore = 0;
                    let claudeTotalScore = 0;
                    const gptComments = [];
                    const claudeComments = [];
                    
                    result.results.forEach((q, idx) => {
                        gptTotalScore += q.gptScore || 0;
                        claudeTotalScore += q.claudeScore || 0;
                        
                        if (q.gptFeedback) {
                            gptComments.push(`ç¬¬${idx + 1}é¡Œ: ${q.gptFeedback}`);
                        }
                        if (q.claudeFeedback) {
                            claudeComments.push(`ç¬¬${idx + 1}é¡Œ: ${q.claudeFeedback}`);
                        }
                    });
                    
                    updateData.gpt_score = gptTotalScore;
                    updateData.gpt_feedback = gptComments.join('\n\n');
                    updateData.claude_score = claudeTotalScore;
                    updateData.claude_feedback = claudeComments.join('\n\n');
                    
                    // å½™ç¸½æœ€çµ‚è©•èªï¼ˆé¡¯ç¤ºå®Œæ•´çš„ GPT å’Œ Claude è©•èªï¼‰
                    const finalFeedback = [];
                    
                    if (gptComments.length > 0) {
                        finalFeedback.push('GPTè©•èªï¼š\n' + gptComments.map((c, i) => c).join('\n\n'));
                    }
                    
                    if (claudeComments.length > 0) {
                        finalFeedback.push('Claudeè©•èªï¼š\n' + claudeComments.map((c, i) => c).join('\n\n'));
                    }
                    
                    // å¦‚æœæœ‰ä»²è£ï¼ŒåŠ å…¥ Gemini ä»²è£è©•èª
                    if (arbitratedCount > 0) {
                        const arbitrationComments = result.results
                            .filter(q => q.arbitrated && q.arbitrationFeedback)
                            .map((q, idx) => `ç¬¬${result.results.findIndex(r => r === q) + 1}é¡Œ: ${q.arbitrationFeedback}`);
                        if (arbitrationComments.length > 0) {
                            finalFeedback.push('Gemini ä»²è£ï¼š\n' + arbitrationComments.join('\n\n'));
                        }
                    }
                    
                    updateData.feedback = finalFeedback.join('\n\n');
                    
                    // å¦‚æœæ²’æœ‰è©•èªï¼Œè‡³å°‘çµ¦å€‹æ‘˜è¦
                    if (!updateData.feedback.trim()) {
                        updateData.feedback = `æœ¬æ¬¡æ‰¹æ”¹å…± ${result.results.length} é¡Œï¼Œç¸½åˆ† ${result.totalScore}/${result.maxTotalScore}ã€‚æ‰€æœ‰é¡Œç›®å‡é”æˆå…±è­˜ï¼Œç„¡éœ€ä»²è£ã€‚`;
                    }
                } else {
                    // å–®é¡Œæ‰¹æ”¹æ¨¡å¼
                    updateData.total_score = result.finalScore;
                    updateData.feedback = result.finalFeedback;
                    updateData.gpt_score = result.gptScore;
                    updateData.gpt_feedback = result.gptFeedback;
                    updateData.claude_score = result.claudeScore;
                    updateData.claude_feedback = result.claudeFeedback;
                    updateData.need_arbitration = result.needArbitration;
                    updateData.arbitration_reason = result.arbitrationReason;
                }
                
                // ğŸ”¥ ç”Ÿæˆåˆ†æå°ˆç”¨æ•¸æ“šï¼ˆä¾›æ•¸æ“šåˆ†æé é¢ç›´æ¥ä½¿ç”¨ï¼‰
                const submissionDoc = await db.collection('grading_events').doc(id).get();
                const submissionData = submissionDoc.exists ? submissionDoc.data() : {};
                
                // ğŸ”¥ è§£æèª²ç¨‹è³‡è¨Šå’Œé¡Œç›®è³‡æ–™ï¼ˆç›´æ¥æŸ¥è©¢ï¼‰
                try {
                    const formId = submissionData.form_id;
                    if (formId) {
                        console.log(`  ğŸ” [æ‰¹é‡æ‰¹æ”¹] æŸ¥è©¢ formId=${formId.substring(0, 16)}... çš„èª²ç¨‹è³‡è¨Š`);
                        
                        let courseId = null;
                        let courseName = null;
                        let examTitle = null;
                        let examQuestions = null;
                        
                        // å¾ googleForms æŸ¥è©¢
                        const gf = await db.collection('googleForms').where('formId', '==', formId).limit(1).get();
                        if (!gf.empty) {
                            const gd = gf.docs[0].data();
                            const dataSrc = gd.examData || gd;
                            examTitle = gd.title || dataSrc.title || null;
                            examQuestions = dataSrc.questions || gd.questions || null;
                            
                            // å¦‚æœæœ‰ examIdï¼Œåå‘æŸ¥è©¢ exams å–å¾—èª²ç¨‹è³‡è¨Š
                            if (gd.examId) {
                                console.log(`  ğŸ”„ [æ‰¹é‡æ‰¹æ”¹] é€é examId=${gd.examId} åå‘æŸ¥è©¢ exams...`);
                                const examDoc = await db.collection('exams').doc(gd.examId).get();
                                if (examDoc.exists) {
                                    const examData = examDoc.data();
                                    courseId = examData.courseId || null;
                                    courseName = examData.courseName || null;
                                    examTitle = examTitle || examData.title || null;
                                    if (!examQuestions && Array.isArray(examData.questions)) {
                                        examQuestions = examData.questions;
                                    }
                                    console.log(`  âœ… [æ‰¹é‡æ‰¹æ”¹] åå‘æŸ¥è©¢æˆåŠŸ â†’ ${courseName || 'ç„¡'}`);
                                }
                            }
                        }
                        
                        submissionData.courseId = submissionData.courseId || courseId || null;
                        submissionData.courseName = submissionData.courseName || courseName || null;
                        submissionData.examTitle = submissionData.examTitle || examTitle || null;
                        submissionData.examQuestions = examQuestions || submissionData.examQuestions || null;
                    }
                } catch (e) {
                    console.warn('  âš ï¸ [æ‰¹é‡æ‰¹æ”¹] è§£æèª²ç¨‹è³‡è¨Šå¤±æ•—:', e);
                }
                
                // ğŸ”¥ å¦‚æœ examQuestions æ˜¯ ID é™£åˆ—ï¼Œéœ€è¦å¾ Firestore æŸ¥è©¢å¯¦éš›é¡Œç›®è³‡æ–™
                if (submissionData.examQuestions && Array.isArray(submissionData.examQuestions) && submissionData.examQuestions.length > 0) {
                    const firstItem = submissionData.examQuestions[0];
                    if (typeof firstItem === 'string') {
                        // æ˜¯ ID é™£åˆ—ï¼Œéœ€è¦æŸ¥è©¢
                        console.log(`  ğŸ” [æ‰¹é‡æ‰¹æ”¹] åµæ¸¬åˆ° examQuestions ç‚º ID é™£åˆ—ï¼ŒæŸ¥è©¢å¯¦éš›é¡Œç›®è³‡æ–™...`);
                        try {
                            const questionIds = submissionData.examQuestions.slice(0, 50); // æœ€å¤š 50 é¡Œ
                            const questionPromises = questionIds.map(qId => 
                                db.collection('questions').doc(qId).get().catch(() => null)
                            );
                            const questionDocs = await Promise.all(questionPromises);
                            const validQuestions = questionDocs
                                .filter(doc => doc && doc.exists)
                                .map(doc => ({ id: doc.id, ...doc.data() }));
                            
                            console.log(`  âœ… [æ‰¹é‡æ‰¹æ”¹] æˆåŠŸè¼‰å…¥ ${validQuestions.length}/${questionIds.length} å€‹é¡Œç›®`);
                            submissionData.examQuestions = validQuestions;
                        } catch (e) {
                            console.warn(`  âš ï¸ [æ‰¹é‡æ‰¹æ”¹] æŸ¥è©¢é¡Œç›®è³‡æ–™å¤±æ•—:`, e);
                        }
                    }
                }
                
                // ğŸ” è¨ºæ–·ï¼šæª¢æŸ¥ submissionData çš„å…§å®¹
                console.log('  ğŸ“‹ [æ‰¹é‡æ‰¹æ”¹] æº–å‚™ç”Ÿæˆåˆ†ææ•¸æ“šï¼ŒsubmissionData å…§å®¹:', {
                    courseId: submissionData.courseId,
                    courseName: submissionData.courseName,
                    examTitle: submissionData.examTitle,
                    examQuestions: submissionData.examQuestions ? 
                        `${submissionData.examQuestions.length} é¡Œ (${typeof submissionData.examQuestions[0]})` : 'ç„¡',
                    formId: submissionData.form_id
                });
                
                const analyticsData = generateAnalyticsData(submissionData, result);
                if (analyticsData) {
                    updateData.analytics_data = analyticsData;
                    addLog('ğŸ“Š', 'å·²ç”Ÿæˆæ•¸æ“šåˆ†æè³‡æ–™', 'success');
                    console.log('âœ… ç”Ÿæˆåˆ†ææ•¸æ“š:', analyticsData);
                } else {
                    console.warn('âš ï¸ æœªèƒ½ç”Ÿæˆåˆ†ææ•¸æ“š');
                }
                
                await db.collection('grading_events').doc(id).update(updateData);

                addLog('ğŸ’¾', 'æ‰¹æ”¹çµæœå·²å„²å­˜åˆ°è³‡æ–™åº«', 'success');
                addLog('âœ¨', 'æ‰¹æ”¹æµç¨‹å®Œæˆï¼', 'success');
                
                // å„²å­˜æ‰¹æ”¹æ—¥èªŒåˆ° Firestoreï¼ˆä¿ç•™ä¸€é€±ï¼‰
                try {
                    await db.collection('grading_logs').add({
                        submission_id: id,
                        logs: gradingLogs,
                        total_logs: gradingLogs.length,
                        created_at: firebase.firestore.FieldValue.serverTimestamp(),
                        expires_at: firebase.firestore.Timestamp.fromDate(new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)) // ä¸€é€±å¾ŒéæœŸ
                    });
                    addLog('ğŸ“', 'æ‰¹æ”¹æ—¥èªŒå·²å„²å­˜', 'success');
                } catch (logError) {
                    console.warn('å„²å­˜æ‰¹æ”¹æ—¥èªŒå¤±æ•—:', logError);
                }

                // æ›´æ–°æŒ‰éˆ• - æ”¹ç‚ºé—œé–‰åŠŸèƒ½
                startBtn.textContent = 'é—œé–‰';
                startBtn.style.background = '#6c757d';
                startBtn.disabled = false;
                startBtn.style.opacity = '1';
                startBtn.style.cursor = 'pointer';
                startBtn.onclick = () => closeAIGradingModal();

                // é¡¯ç¤ºé¡Œè©å„ªåŒ–å»ºè­°ï¼ˆå¦‚æœæœ‰ï¼‰
                if (result.promptSuggestion && result.promptSuggestion.hasIssues) {
                    addLog('ğŸ’¡', 'Gemini å·²åˆ†ææç¤ºè©ä¸¦æä¾›å„ªåŒ–å»ºè­°', 'ai');
                    
                    const promptCard = document.createElement('div');
                    promptCard.style.cssText = `
                        margin-top: 16px;
                        background: #fff3cd;
                        padding: 16px;
                        border-radius: 8px;
                        border-left: 4px solid #ff9800;
                    `;
                    promptCard.innerHTML = `
                        <div style="font-weight: 600; color: #856404; margin-bottom: 8px;">ğŸ’¡ æç¤ºè©å„ªåŒ–å»ºè­°</div>
                        <div style="font-size: 13px; color: #856404; margin-bottom: 12px;">
                            <strong>ä¿®æ”¹é‡é»ï¼š</strong>${result.promptSuggestion.diffSummary || 'å„ªåŒ–è©•åˆ†æ¨™æº–'}
                        </div>
                        <div style="font-size: 12px; color: #856404; margin-bottom: 12px;">
                            <strong>æ”¹é€²é»ï¼š</strong>
                            ${(result.promptSuggestion.improvements || []).map(imp => `<div>â€¢ ${imp}</div>`).join('')}
                        </div>
                        <div style="font-size: 12px; color: #856404; margin-bottom: 12px;">
                            <strong>åŸå› ï¼š</strong>${result.promptSuggestion.reason || 'ç„¡'}
                        </div>
                        ${result.promptSuggestion.updatedPrompt ? `
                        <details style="margin-top: 12px; margin-bottom: 12px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #856404; padding: 8px; background: #fff8e1; border-radius: 4px;">
                                ğŸ“„ æŸ¥çœ‹å®Œæ•´ä¿®æ”¹å¾Œæç¤ºè©
                            </summary>
                            <div style="margin-top: 8px; padding: 12px; background: white; border-radius: 4px; max-height: 300px; overflow-y: auto; font-size: 12px; white-space: pre-wrap; font-family: monospace; border: 1px solid #ddd;">
${result.promptSuggestion.updatedPrompt}</div>
                        </details>
                        <button onclick="applyPromptSuggestion('${id}')" style="
                            padding: 8px 16px;
                            background: #ff9800;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 13px;
                            font-weight: 500;
                        ">
                            ğŸ“ å¥—ç”¨å®Œæ•´ä¿®æ”¹å¾Œæç¤ºè©
                        </button>
                        ` : ''}
                    `;
                    logContent.appendChild(promptCard);
                }
                
                // é¡¯ç¤ºå¼±é»åˆ†æï¼ˆå¦‚æœæœ‰ï¼‰
                if (result.weaknessReview) {
                    addLog('ğŸ“ˆ', 'Gemini å·²å®Œæˆæ•´å·å¼±é»åˆ†æ', 'ai');
                    
                    const weaknessCard = document.createElement('div');
                    weaknessCard.style.cssText = `
                        margin-top: 16px;
                        background: #e3f2fd;
                        padding: 16px;
                        border-radius: 8px;
                        border-left: 4px solid #2196f3;
                    `;
                    
                    const clusters = result.weaknessReview.weaknessClusters || [];
                    const actions = result.weaknessReview.prioritizedActions || [];
                    const suggestions = result.weaknessReview.practiceSuggestions || [];
                    const riskScore = result.weaknessReview.riskScore || 0;
                    const coachComment = result.weaknessReview.coachComment || '';
                    
                    weaknessCard.innerHTML = `
                        <div style="font-weight: 600; color: #1565c0; margin-bottom: 8px;">ğŸ“ˆ å­¸ç¿’å¼±é»åˆ†æ</div>
                        
                        ${coachComment ? `
                        <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <div style="font-size: 12px; color: #1565c0; font-weight: 600; margin-bottom: 6px;">ğŸ’¬ æ•™ç·´è©•èª</div>
                            <div style="font-size: 13px; color: #2c3e50;">${coachComment}</div>
                        </div>
                        ` : ''}
                        
                        ${clusters.length > 0 ? `
                        <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <div style="font-size: 12px; color: #1565c0; font-weight: 600; margin-bottom: 6px;">ğŸ¯ å¼±é»ä¸»é¡Œï¼ˆ${clusters.length} å€‹ï¼‰</div>
                            ${clusters.slice(0, 3).map(c => `
                                <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                                    <div style="font-weight: 500; color: #2c3e50; font-size: 13px;">${c.topic}</div>
                                    <div style="font-size: 11px; color: #7f8c8d; margin-top: 4px;">
                                        å‡ºç¾ ${c.frequency} æ¬¡ | æ¶‰åŠé¡Œç›®ï¼š${c.evidenceQids.join(', ')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        ${suggestions.length > 0 ? `
                        <div style="background: white; padding: 12px; border-radius: 6px;">
                            <div style="font-size: 12px; color: #1565c0; font-weight: 600; margin-bottom: 6px;">âœï¸ ç·´ç¿’å»ºè­°</div>
                            ${suggestions.slice(0, 3).map(s => `<div style="font-size: 12px; color: #2c3e50; margin-bottom: 4px;">â€¢ ${s}</div>`).join('')}
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 12px; text-align: center;">
                            <span style="background: ${riskScore > 70 ? '#f44336' : riskScore > 40 ? '#ff9800' : '#4caf50'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                é¢¨éšªåˆ†æ•¸ï¼š${riskScore}/100
                            </span>
                        </div>
                    `;
                    logContent.appendChild(weaknessCard);
                }

                // é¡¯ç¤ºæŸ¥çœ‹è©³æƒ…æŒ‰éˆ•
                addLog('âœ¨', 'æ‰¹æ”¹æµç¨‹å®Œæˆï¼é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŸ¥çœ‹å®Œæ•´è©³æƒ…', 'success');
                
                // æ·»åŠ æŸ¥çœ‹è©³æƒ…æŒ‰éˆ•
                const viewDetailsBtn = document.createElement('div');
                viewDetailsBtn.style.cssText = `
                    margin-top: 16px;
                    text-align: center;
                `;
                viewDetailsBtn.innerHTML = `
                    <button onclick="viewAIGradingDetails('${id}')" style="
                        padding: 12px 24px;
                        background: #4A90E2;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 500;
                        font-size: 14px;
                        box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
                        transition: all 0.2s;
                    " onmouseover="this.style.background='#357ABD'; this.style.transform='translateY(-2px)'" 
                       onmouseout="this.style.background='#4A90E2'; this.style.transform='translateY(0)'">
                        ğŸ“Š æŸ¥çœ‹å®Œæ•´æ‰¹æ”¹è©³æƒ…
                    </button>
                `;
                logContent.appendChild(viewDetailsBtn);
                
                // é‡æ–°è¼‰å…¥ä½œæ¥­åˆ—è¡¨
                await loadSubmissions();

            } catch (error) {
                console.error('âŒ AI æ‰¹æ”¹å¤±æ•—:', error);
                addLog('âŒ', `æ‰¹æ”¹å¤±æ•—ï¼š${error.message}`, 'error');
                
                // æ¢å¾©æŒ‰éˆ•
                startBtn.disabled = false;
                startBtn.style.opacity = '1';
                startBtn.style.cursor = 'pointer';
            }
        }

        // é¡¯ç¤ºè¼‰å…¥ Toast
        function showLoadingToast(message) {
            const toast = document.createElement('div');
            toast.id = 'loadingToast';
            toast.style.cssText = `
            position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
                font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
                gap: 12px;
                animation: slideInRight 0.3s ease;
            `;
            
            toast.innerHTML = `
                <div class="loading-spinner" style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span>${message}</span>
            `;

            document.body.appendChild(toast);
            return toast;
        }

        // é¡¯ç¤ºæˆåŠŸ Toast
        function showSuccessToast(message) {
            showToast(message, 'success');
        }

        // é¡¯ç¤ºéŒ¯èª¤ Toast
        function showErrorToast(message) {
            showToast(message, 'error');
        }

        // é€šç”¨ Toast å‡½æ•¸
        function showToast(message, type = 'success') {
            const colors = {
                success: { bg: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', shadow: 'rgba(16, 185, 129, 0.3)' },
                error: { bg: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)', shadow: 'rgba(239, 68, 68, 0.3)' }
            };

            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                background: ${colors[type].bg};
            color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 4px 16px ${colors[type].shadow};
                font-size: 14px;
            font-weight: 500;
                animation: slideInRight 0.3s ease;
                max-width: 400px;
            `;
            
            toast.textContent = message;
            document.body.appendChild(toast);

            // 3 ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // æ·»åŠ å‹•ç•«æ¨£å¼
        if (!document.getElementById('toastAnimations')) {
            const style = document.createElement('style');
            style.id = 'toastAnimations';
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(400px); opacity: 0; }
                }
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
                @keyframes slideUp {
                    from { transform: translateY(30px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }

        // è·³è½‰åˆ°æ•¸æ“šåˆ†æé é¢ä¸¦è‡ªå‹•ç¯©é¸è©²å­¸ç”Ÿ
        function viewInAnalytics(studentEmail) {
            if (!studentEmail) {
                alert('ç„¡æ³•å–å¾—å­¸ç”Ÿè³‡æ–™');
                return;
            }
            
            // ä½¿ç”¨ localStorage å‚³éç¯©é¸åƒæ•¸
            localStorage.setItem('analytics_filter_student', studentEmail);
            
            // è·³è½‰åˆ°æ•¸æ“šåˆ†æé é¢
            window.location.href = 'analytic.html';
        }

        // åˆªé™¤ä½œæ¥­æäº¤
        async function deleteSubmission(id) {
            const item = allSubmissions.find(s => s.id === id);
            if (!item) return;

            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item.studentName}ã€çš„ä½œæ¥­å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                return;
            }

            try {
                await db.collection('grading_events').doc(id).delete();
                console.log('âœ… æˆåŠŸåˆªé™¤ä½œæ¥­');
                alert('ä½œæ¥­å·²åˆªé™¤');
                await loadSubmissions();
            } catch (error) {
                console.error('âŒ åˆªé™¤ä½œæ¥­å¤±æ•—:', error);
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // å·¥å…·å‡½æ•¸
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…æ‰¹æ”¹',
                'grading': 'æ‰¹æ”¹ä¸­',
                'completed': 'å·²å®Œæˆ'
            };
            return statusMap[status] || status;
        }

        function formatDateTime(date) {
            if (!date) return '-';
            if (typeof date.toLocaleDateString === 'function') {
                return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW');
            }
            return String(date);
        }

        // åˆ‡æ›é é¢
        function goToPage(page) {
            currentPage = page;
            renderSubmissions();
        }

        // ç¶å®šäº‹ä»¶ç›£è½å™¨ï¼ˆåœ¨æª”æ¡ˆæœ«å°¾å®šç¾©ï¼‰

        // === ä»¥ä¸‹æ˜¯èˆŠçš„è€ƒè©¦ç®¡ç†å‡½æ•¸ï¼Œæš«æ™‚ä¿ç•™ ===
        function openCreateExamModal() {
            return;
            document.getElementById('examForm').reset();
            document.getElementById('examStatus').value = 'draft';
            document.getElementById('examDuration').value = 60;
            document.getElementById('examTotalScore').value = 100;
            document.getElementById('selectedQuestionsList').innerHTML = `
                <div class="empty-questions-hint">
                    <svg viewBox="0 0 20 20" fill="none" style="width: 48px; height: 48px; opacity: 0.3;">
                        <path d="M4 6h12M4 10h12M4 14h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    <p>å°šæœªé¸æ“‡ä»»ä½•é¡Œç›®</p>
                </div>
            `;
            document.getElementById('examModal').style.display = 'flex';
        }

        // ç·¨è¼¯è€ƒè©¦
        async function editExam(examId) {
            const exam = allExams.find(e => e.id === examId);
            if (!exam) return;

            editingExamId = examId;
            document.getElementById('modalTitle').textContent = 'ç·¨è¼¯è€ƒè©¦';

            document.getElementById('examTitle').value = exam.title || '';
            document.getElementById('examSubject').value = exam.subject || '';
            document.getElementById('examDescription').value = exam.description || '';
            document.getElementById('examStatus').value = exam.status || 'draft';
            document.getElementById('examDuration').value = exam.duration || 60;
            document.getElementById('examTotalScore').value = exam.totalScore || 100;

            if (exam.startTime) {
                const start = exam.startTime.toDate ? exam.startTime.toDate() : new Date(exam.startTime);
                document.getElementById('examStartTime').value = start.toISOString().slice(0, 16);
            }

            if (exam.endTime) {
                const end = exam.endTime.toDate ? exam.endTime.toDate() : new Date(exam.endTime);
                document.getElementById('examEndTime').value = end.toISOString().slice(0, 16);
            }

            document.getElementById('shuffleQuestions').checked = exam.shuffleQuestions || false;
            document.getElementById('showScoreImmediately').checked = exam.showScoreImmediately || false;
            document.getElementById('allowReview').checked = exam.allowReview || false;

            // è¼‰å…¥å·²é¸æ“‡çš„é¡Œç›®
            if (exam.questions && exam.questions.length > 0) {
                selectedExamQuestions = new Set(exam.questions.map(q => q.id || q));
                renderSelectedQuestions();
            }

            document.getElementById('examModal').style.display = 'flex';
        }

        // é—œé–‰è€ƒè©¦æ¨¡æ…‹æ¡†
        function closeExamModal() {
            document.getElementById('examModal').style.display = 'none';
            editingExamId = null;
            selectedExamQuestions.clear();
        }

        // å„²å­˜è€ƒè©¦
        async function saveExam() {
            const form = document.getElementById('examForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            try {
                const examData = {
                    title: document.getElementById('examTitle').value.trim(),
                    subject: document.getElementById('examSubject').value.trim(),
                    description: document.getElementById('examDescription').value.trim(),
                    status: document.getElementById('examStatus').value,
                    duration: parseInt(document.getElementById('examDuration').value) || 60,
                    totalScore: parseInt(document.getElementById('examTotalScore').value) || 100,
                    shuffleQuestions: document.getElementById('shuffleQuestions').checked,
                    showScoreImmediately: document.getElementById('showScoreImmediately').checked,
                    allowReview: document.getElementById('allowReview').checked,
                    questions: Array.from(selectedExamQuestions),
                    questionCount: selectedExamQuestions.size,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const startTime = document.getElementById('examStartTime').value;
                const endTime = document.getElementById('examEndTime').value;

                if (startTime) {
                    examData.startTime = firebase.firestore.Timestamp.fromDate(new Date(startTime));
                }

                if (endTime) {
                    examData.endTime = firebase.firestore.Timestamp.fromDate(new Date(endTime));
                }

                if (editingExamId) {
                    await db.collection('exams').doc(editingExamId).update(examData);
                    console.log('âœ… è€ƒè©¦å·²æ›´æ–°');
                    alert('è€ƒè©¦æ›´æ–°æˆåŠŸï¼');
                } else {
                    examData.createdBy = currentUser.uid;
                    examData.teacherId = currentUser.uid;
                    examData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    examData.submissions = 0;

                    await db.collection('exams').add(examData);
                    console.log('âœ… è€ƒè©¦å·²æ–°å¢');
                    alert('è€ƒè©¦æ–°å¢æˆåŠŸï¼');
                }

                closeExamModal();
                await loadExams();

            } catch (error) {
                console.error('âŒ å„²å­˜è€ƒè©¦å¤±æ•—:', error);
                alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
            }
        }

        // åˆªé™¤è€ƒè©¦
        async function deleteExam(examId) {
            const exam = allExams.find(e => e.id === examId);
            if (!exam) return;

            if (!confirm(`ç¢ºå®šè¦åˆªé™¤è€ƒè©¦ã€Œ${exam.title}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                return;
            }

            try {
                await db.collection('exams').doc(examId).delete();
                console.log('âœ… æˆåŠŸåˆªé™¤è€ƒè©¦');
                alert('è€ƒè©¦å·²åˆªé™¤');
                await loadExams();
            } catch (error) {
                console.error('âŒ åˆªé™¤è€ƒè©¦å¤±æ•—:', error);
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // æ‰“é–‹é¡Œç›®é¸æ“‡å™¨
        async function openQuestionPicker() {
            try {
                // è¼‰å…¥é¡Œåº«
                const snapshot = await db.collection('questions')
                    .where('createdBy', '==', currentUser.uid)
                    .get();

                availableQuestions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // è¼‰å…¥ç§‘ç›®ç¯©é¸å™¨
                const subjects = [...new Set(availableQuestions.map(q => q.subject).filter(Boolean))];
                const subjectFilter = document.getElementById('questionSubjectFilter');
                subjectFilter.innerHTML = '<option value="">æ‰€æœ‰ç§‘ç›®</option>' +
                    subjects.map(s => `<option value="${s}">${s}</option>`).join('');

                filterQuestions();
                document.getElementById('questionPickerModal').style.display = 'flex';

            } catch (error) {
                console.error('âŒ è¼‰å…¥é¡Œåº«å¤±æ•—:', error);
                alert('è¼‰å…¥é¡Œåº«å¤±æ•—ï¼š' + error.message);
            }
        }

        // é—œé–‰é¡Œç›®é¸æ“‡å™¨
        function closeQuestionPicker() {
            document.getElementById('questionPickerModal').style.display = 'none';
        }

        // ç¯©é¸é¡Œç›®ï¼ˆåœ¨é¸æ“‡å™¨ä¸­ï¼‰
        function filterQuestions() {
            const searchTerm = document.getElementById('questionSearchInput').value.toLowerCase();
            const subjectFilter = document.getElementById('questionSubjectFilter').value;
            const difficultyFilter = document.getElementById('questionDifficultyFilter').value;

            const filtered = availableQuestions.filter(q => {
                if (searchTerm && !q.title.toLowerCase().includes(searchTerm)) return false;
                if (subjectFilter && q.subject !== subjectFilter) return false;
                if (difficultyFilter && q.difficulty !== difficultyFilter) return false;
                return true;
            });

            renderAvailableQuestions(filtered);
        }

        // æ¸²æŸ“å¯é¸é¡Œç›®åˆ—è¡¨
        function renderAvailableQuestions(questions) {
            const container = document.getElementById('availableQuestionsList');

            if (questions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®</p>';
                return;
            }

            container.innerHTML = questions.map(q => `
                <div class="question-picker-item ${selectedExamQuestions.has(q.id) ? 'selected' : ''}" onclick="toggleQuestionSelection('${q.id}')">
                    <input type="checkbox" ${selectedExamQuestions.has(q.id) ? 'checked' : ''} onclick="event.stopPropagation(); toggleQuestionSelection('${q.id}')">
                    <div class="question-picker-content">
                        <div class="question-picker-title">${q.title}</div>
                        <div class="question-picker-meta">
                            <span class="difficulty-badge difficulty-${q.difficulty}">${getDifficultyText(q.difficulty)}</span>
                            <span>${q.subject || 'æœªåˆ†é¡'}</span>
                            <span>${q.points || 0} åˆ†</span>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('selectedQuestionCount').textContent = selectedExamQuestions.size;
        }

        // åˆ‡æ›é¡Œç›®é¸æ“‡
        function toggleQuestionSelection(questionId) {
            if (selectedExamQuestions.has(questionId)) {
                selectedExamQuestions.delete(questionId);
            } else {
                selectedExamQuestions.add(questionId);
            }

            filterQuestions();
        }

        // ç¢ºèªé¡Œç›®é¸æ“‡
        function confirmQuestionSelection() {
            renderSelectedQuestions();
            closeQuestionPicker();
        }

        // æ¸²æŸ“å·²é¸æ“‡çš„é¡Œç›®
        function renderSelectedQuestions() {
            const container = document.getElementById('selectedQuestionsList');

            if (selectedExamQuestions.size === 0) {
                container.innerHTML = `
                    <div class="empty-questions-hint">
                        <p>å°šæœªé¸æ“‡ä»»ä½•é¡Œç›®</p>
                    </div>
                `;
                return;
            }

            const selectedQuestions = availableQuestions.filter(q => selectedExamQuestions.has(q.id));

            container.innerHTML = selectedQuestions.map((q, index) => `
                <div class="selected-question-item">
                    <span class="question-number">${index + 1}</span>
                    <div class="question-content">
                        <div>${q.title}</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">
                            ${q.subject || 'æœªåˆ†é¡'} | ${getDifficultyText(q.difficulty)} | ${q.points || 0} åˆ†
                        </div>
                    </div>
                    <button type="button" class="remove-question-btn" onclick="removeSelectedQuestion('${q.id}')">
                        <svg viewBox="0 0 20 20" fill="none" style="width: 16px; height: 16px;">
                            <path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        // ç§»é™¤å·²é¸æ“‡çš„é¡Œç›®
        function removeSelectedQuestion(questionId) {
            selectedExamQuestions.delete(questionId);
            renderSelectedQuestions();
        }

        // ç²å–ç‹€æ…‹å¾½ç« æ–‡å­—
        function getStatusBadge(status) {
            const statusMap = {
                'draft': 'è‰ç¨¿',
                'published': 'å·²ç™¼å¸ƒ',
                'ongoing': 'é€²è¡Œä¸­',
                'completed': 'å·²å®Œæˆ'
            };
            return statusMap[status] || status;
        }

        // ç²å–é›£åº¦æ–‡å­—
        function getDifficultyText(difficulty) {
            const map = {
                easy: 'ç°¡å–®',
                medium: 'ä¸­ç­‰',
                hard: 'å›°é›£'
            };
            return map[difficulty] || difficulty;
        }

        // åˆ‡æ›é é¢
        function goToPage(page) {
            currentPage = page;
            renderSubmissions();
        }

        // ç¶å®šäº‹ä»¶ç›£è½å™¨
        function bindEventListeners() {
            document.getElementById('logoutBtn').addEventListener('click', async function() {
                try {
                    await auth.signOut();
                    window.location.href = '../dashboard.html';
                } catch (error) {
                    console.error('ç™»å‡ºå¤±æ•—:', error);
                }
            });

            document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));

            // æ¨¡æ…‹æ¡†é»æ“ŠèƒŒæ™¯é—œé–‰
            document.getElementById('detailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDetailModal();
                }
            });

            document.getElementById('editModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditModal();
                }
            });

            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderSubmissions();
                    }
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(filteredSubmissions.length / itemsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderSubmissions();
                    }
                });
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>

    <!-- æ‰‹æ©Ÿé¸å–®æ§åˆ¶ -->
    <script src="../assets/js/mobile-menu.js"></script>

</body>

</html>