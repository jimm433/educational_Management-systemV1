<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹æ”¹æ•¸æ“šè¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #1976d2;
        }
        
        .btn {
            padding: 10px 20px;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        .btn:hover {
            background: #1565c0;
        }
        
        pre {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 600px;
        }
        
        .section {
            margin: 24px 0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
        }
        
        .success {
            color: #4caf50;
        }
        
        .error {
            color: #f44336;
        }
        
        .warning {
            color: #ff9800;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ” æ‰¹æ”¹æ•¸æ“šè¨ºæ–·å·¥å…·</h1>
        <p>é€™å€‹å·¥å…·æœƒæª¢æŸ¥æ‰¹æ”¹æ­·å²çš„å¯¦éš›æ•¸æ“šçµæ§‹ï¼Œå¹«åŠ©ä¿®å¾©æ•¸æ“šåˆ†æé é¢ã€‚</p>

        <div style="margin: 20px 0;">
            <button class="btn" onclick="loadAndAnalyze()">ğŸ” è¼‰å…¥ä¸¦åˆ†ææ•¸æ“š</button>
            <button class="btn" onclick="testGeminiFormat()">ğŸ¤– æ¸¬è©¦ Gemini æ ¼å¼åŒ–</button>
        </div>

        <div id="output"></div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "G-4MFQG2LB9Y"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        function addSection(title, content, type = 'info') {
            const output = document.getElementById('output');
            const section = document.createElement('div');
            section.className = 'section';
            section.innerHTML = `
                <h3 class="${type}">${title}</h3>
                ${content}
            `;
            output.appendChild(section);
        }

        async function loadAndAnalyze() {
            document.getElementById('output').innerHTML = '';

            try {
                addSection('ğŸ“¡ é–‹å§‹è¼‰å…¥æ•¸æ“š...', 'æ­£åœ¨å¾ Firestore è®€å–æ‰¹æ”¹è¨˜éŒ„');

                // è¼‰å…¥ grading_events
                const snapshot = await db.collection('grading_events')
                    .where('status', '==', 'completed')
                    .limit(5)
                    .get();

                addSection('âœ… è¼‰å…¥æˆåŠŸ', `æ‰¾åˆ° ${snapshot.size} ç­†æ‰¹æ”¹è¨˜éŒ„`, 'success');

                if (snapshot.empty) {
                    addSection('âš ï¸ è­¦å‘Š', 'æ²’æœ‰æ‰¾åˆ°æ‰¹æ”¹è¨˜éŒ„', 'warning');
                    return;
                }

                // åˆ†æç¬¬ä¸€ç­†æ•¸æ“š
                const firstDoc = snapshot.docs[0];
                const data = firstDoc.data();

                addSection('ğŸ“‹ å®Œæ•´æ•¸æ“šçµæ§‹', `<pre>${JSON.stringify(data, null, 2)}</pre>`);

                // åˆ†æé—œéµæ¬„ä½
                const analysis = {
                    'Document ID': firstDoc.id,
                    'å­¸ç”Ÿä¿¡ç®±': data.student_email || 'ç„¡',
                    'å­¸ç”Ÿå§“å': data.student_name || 'ç„¡',
                    'è€ƒè©¦ ID': data.exam_id || data.examId || data.form_id || 'ç„¡',
                    'ç‹€æ…‹': data.status || 'ç„¡',
                    'æ˜¯å¦æœ‰ ai_result': data.ai_result ? 'âœ… æ˜¯' : 'âŒ å¦',
                    'æ˜¯å¦æœ‰ answers': data.answers ? 'âœ… æ˜¯' : 'âŒ å¦',
                    'æ˜¯å¦æœ‰ tags': data.tags ? 'âœ… æ˜¯' : 'âŒ å¦',
                    'æ˜¯å¦æœ‰ courseId': data.courseId ? 'âœ… æ˜¯' : 'âŒ å¦',
                    'æ˜¯å¦æœ‰ courseName': data.courseName ? 'âœ… æ˜¯' : 'âŒ å¦'
                };

                let analysisHtml = '<ul>';
                for (const [key, value] of Object.entries(analysis)) {
                    analysisHtml += `<li><strong>${key}:</strong> ${value}</li>`;
                }
                analysisHtml += '</ul>';
                addSection('ğŸ” é—œéµæ¬„ä½åˆ†æ', analysisHtml);

                // åˆ†æ ai_result çµæ§‹
                if (data.ai_result) {
                    addSection('ğŸ¤– AI æ‰¹æ”¹çµæœçµæ§‹', `<pre>${JSON.stringify(data.ai_result, null, 2)}</pre>`);

                    if (data.ai_result.results && Array.isArray(data.ai_result.results)) {
                        const firstQuestion = data.ai_result.results[0];
                        addSection('ğŸ“ ç¬¬ä¸€é¡Œçš„çµæ§‹', `<pre>${JSON.stringify(firstQuestion, null, 2)}</pre>`);
                    }
                }

                // åˆ†æ answers çµæ§‹
                if (data.answers) {
                    addSection('âœï¸ Answers çµæ§‹', `<pre>${JSON.stringify(data.answers, null, 2)}</pre>`);
                    addSection('ğŸ”‘ Answers çš„ Keys', `<pre>${JSON.stringify(Object.keys(data.answers), null, 2)}</pre>`);
                }

                // å˜—è©¦æŸ¥æ‰¾é—œè¯çš„è€ƒè©¦è³‡æ–™
                const examId = data.exam_id || data.examId || data.form_id;
                if (examId) {
                    addSection('ğŸ” æŸ¥æ‰¾è€ƒè©¦è³‡æ–™...', `è€ƒè©¦ ID: ${examId}`);

                    const examSnapshot = await db.collection('exams')
                        .where('formId', '==', examId)
                        .limit(1)
                        .get();

                    if (!examSnapshot.empty) {
                        const examData = examSnapshot.docs[0].data();
                        addSection('ğŸ“š è€ƒè©¦è³‡æ–™', `<pre>${JSON.stringify(examData, null, 2)}</pre>`, 'success');
                    } else {
                        addSection('âš ï¸ æœªæ‰¾åˆ°è€ƒè©¦è³‡æ–™', `ç„¡æ³•æ‰¾åˆ° formId=${examId} çš„è€ƒè©¦`, 'warning');
                    }
                }

            } catch (error) {
                addSection('âŒ éŒ¯èª¤', `<pre>${error.message}\n${error.stack}</pre>`, 'error');
            }
        }

        async function testGeminiFormat() {
            try {
                addSection('ğŸ¤– æ¸¬è©¦ Gemini æ ¼å¼åŒ–...', 'æ­£åœ¨è¼‰å…¥æ•¸æ“šä¸¦å‘¼å« Gemini API');

                // è¼‰å…¥ä¸€ç­†æ‰¹æ”¹è¨˜éŒ„
                const snapshot = await db.collection('grading_events')
                    .where('status', '==', 'completed')
                    .limit(1)
                    .get();

                if (snapshot.empty) {
                    addSection('âš ï¸ è­¦å‘Š', 'æ²’æœ‰æ‰¾åˆ°æ‰¹æ”¹è¨˜éŒ„', 'warning');
                    return;
                }

                const data = snapshot.docs[0].data();

                // å‘¼å«å¾Œç«¯çš„ Gemini æ ¼å¼åŒ– API
                const response = await fetch('https://us-central1-YOUR_PROJECT_ID.cloudfunctions.net/formatGradingData', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gradingData: data
                    })
                });

                const result = await response.json();

                if (result.success) {
                    addSection('âœ… Gemini æ ¼å¼åŒ–æˆåŠŸ', `<pre>${JSON.stringify(result.formatted, null, 2)}</pre>`, 'success');
                } else {
                    addSection('âŒ Gemini æ ¼å¼åŒ–å¤±æ•—', `<pre>${JSON.stringify(result, null, 2)}</pre>`, 'error');
                }

            } catch (error) {
                addSection('âŒ éŒ¯èª¤', `<pre>${error.message}\n${error.stack}</pre>`, 'error');
            }
        }
    </script>
</body>