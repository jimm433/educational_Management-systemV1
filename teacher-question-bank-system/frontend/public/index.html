<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教育管理系統 - 登入</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/login.css">
    <!-- Firebase SDK v10 -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body>
    <!-- 登入頁面 -->
    <div class="login-wrapper">
        <!-- 左側區塊 - 品牌介紹 -->
        <div class="login-left">
            <div class="brand-section">
                <div class="brand-logo">
                    <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                        <rect x="8" y="12" width="32" height="28" rx="2" stroke="currentColor" stroke-width="2"/>
                        <path d="M8 18h32M16 12v-4M32 12v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="16" cy="26" r="1.5" fill="currentColor"/>
                        <circle cx="24" cy="26" r="1.5" fill="currentColor"/>
                        <circle cx="32" cy="26" r="1.5" fill="currentColor"/>
                        <rect x="16" y="31" width="16" height="2" rx="1" fill="currentColor"/>
                    </svg>
                    <h1>教育管理系統</h1>
                </div>
                <p class="brand-description">
                    整合題庫管理、考試評分、學習分析的完整教學平台
                </p>
                <div class="features-list">
                    <div class="feature-item">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
                            <path d="M6 10l3 3 5-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>智能題庫管理</span>
                    </div>
                    <div class="feature-item">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
                            <path d="M6 10l3 3 5-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>自動化考試評分</span>
                    </div>
                    <div class="feature-item">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
                            <path d="M6 10l3 3 5-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>學習成效分析</span>
                    </div>
                    <div class="feature-item">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
                            <path d="M6 10l3 3 5-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Google Forms 整合</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右側區塊 - 登入表單 -->
        <div class="login-right">
            <div class="login-form-container">
                <div class="login-header">
                    <h2>歡迎登入</h2>
                    <p>請選擇您的身份以繼續使用系統</p>
                </div>

                <!-- 身份選擇 -->
                <div class="role-selector">
                    <button class="role-card" data-role="teacher">
                        <div class="role-icon teacher-icon">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <path d="M16 4L4 10l12 6 12-6-12-6z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M4 16l12 6 12-6M4 22l12 6 12-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="role-content">
                            <h3>教師</h3>
                            <p>管理題庫、建立考試、批改作業</p>
                        </div>
                        <div class="role-check">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
                                <path d="M6 10l3 3 5-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </button>

                    <button class="role-card" data-role="student">
                        <div class="role-icon student-icon">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <circle cx="16" cy="12" r="5" stroke="currentColor" stroke-width="2"/>
                                <path d="M8 26c0-4.4 3.6-8 8-8s8 3.6 8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <div class="role-content">
                            <h3>學生</h3>
                            <p>參加考試、查看成績、學習課程</p>
                        </div>
                        <div class="role-check">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
                                <path d="M6 10l3 3 5-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </button>
                </div>

                <!-- 訊息顯示 -->
                <div class="message-box" id="message"></div>

                <!-- Google 登入按鈕 -->
                <button class="google-signin-btn" id="googleLoginBtn" disabled>
                    <svg class="google-logo" width="20" height="20" viewBox="0 0 20 20">
                        <path fill="#4285F4" d="M19.6 10.2c0-.7-.1-1.4-.2-2H10v3.8h5.4c-.2 1.2-1 2.2-2 2.9v2.5h3.2c1.9-1.7 3-4.3 3-7.2z"/>
                        <path fill="#34A853" d="M10 20c2.7 0 4.9-.9 6.6-2.4l-3.2-2.5c-.9.6-2 .9-3.4.9-2.6 0-4.8-1.8-5.6-4.1H1.1v2.6C2.8 17.7 6.1 20 10 20z"/>
                        <path fill="#FBBC04" d="M4.4 12c-.2-.6-.3-1.3-.3-2s.1-1.4.3-2V5.4H1.1C.4 6.8 0 8.4 0 10s.4 3.2 1.1 4.6l3.3-2.6z"/>
                        <path fill="#EA4335" d="M10 3.9c1.5 0 2.8.5 3.8 1.5l2.9-2.9C15 .9 12.7 0 10 0 6.1 0 2.8 2.3 1.1 5.4l3.3 2.6C5.2 5.6 7.4 3.9 10 3.9z"/>
                    </svg>
                    <span>使用 Google 帳號登入</span>
                </button>

                <!-- 清除快取連結 -->
                <div style="margin-top: 16px; text-align: center;">
                    <a href="clear-cache.html" style="color: #6b7280; text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; gap: 6px;">
                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg> 遇到問題？清除快取
                    </a>
                </div>

                <!-- 載入中 -->
                <div class="loading-overlay" id="loading">
                    <div class="loading-spinner"></div>
                    <p>正在登入中...</p>
                </div>

                <div class="login-footer">
                    <p>登入即表示您同意我們的<a href="#">服務條款</a>和<a href="#">隱私政策</a></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase 配置
        // ⚠️ 重要：請將此配置替換為您自己的 Firebase 專案配置
        // 詳細說明請參考 SETUP.md
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Google 身份驗證提供者
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.addScope('email');
        googleProvider.addScope('profile');
        googleProvider.setCustomParameters({
            prompt: 'select_account'
        });

        // DOM 元素
        const roleCards = document.querySelectorAll('.role-card');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const loading = document.getElementById('loading');
        const message = document.getElementById('message');

        // 全域變數
        let selectedRole = null;

        // 頁面載入時檢查登入狀態
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔍 檢查登入狀態...');

            // 檢查是否已經登入
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    console.log('✅ 使用者已登入，重導向到儀表板');
                    window.location.href = 'dashboard.html';
                } else {
                    console.log('📋 使用者未登入，顯示登入介面');
                }
            });
        });

        // 顯示訊息
        function showMessage(text, type = 'info') {
            message.textContent = text;
            message.className = `message-box ${type} show`;

            setTimeout(() => {
                message.classList.remove('show');
            }, 5000);
        }

        // 顯示載入狀態
        function showLoading(show) {
            if (show) {
                loading.classList.add('show');
                googleLoginBtn.disabled = true;
            } else {
                loading.classList.remove('show');
                googleLoginBtn.disabled = selectedRole ? false : true;
            }
        }

        // 身份選擇處理
        roleCards.forEach(card => {
            card.addEventListener('click', function() {
                roleCards.forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');

                selectedRole = this.dataset.role;
                googleLoginBtn.disabled = false;

                console.log('✅ 選擇身份:', selectedRole);
            });
        });

        // Google 登入
        async function signInWithGoogle(userRole) {
            try {
                showLoading(true);
                console.log('🔐 開始 Google 登入...');

                const result = await auth.signInWithPopup(googleProvider);
                const user = result.user;

                console.log('✅ Google 登入成功:', user.email);

                // 儲存使用者資料到 Firestore
                await saveUserToFirestore(user, userRole);

                showMessage('登入成功！正在導向儀表板...', 'success');

                // 強制清除快取並導向正確頁面
                setTimeout(() => {
                    // 確保版本號已設置
                    try {
                        localStorage.setItem('app_last_version', 'v5');
                        localStorage.setItem('app_error_count', '0');
                    } catch (e) {
                        console.warn('無法設置版本號:', e);
                    }

                    // 根據角色導向不同頁面
                    if (userRole === 'teacher') {
                        window.location.href = 'teacher/question.html?refresh=' + Date.now();
                    } else {
                        window.location.href = 'student/dashboard.html?refresh=' + Date.now();
                    }
                }, 1500);

            } catch (error) {
                showLoading(false);
                console.error('❌ Google 登入失敗:', error);

                // 簡化錯誤處理，不顯示過於詳細的錯誤
                let errorMessage = '登入失敗，請重試';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = '登入視窗被關閉';
                } else if (error.code === 'auth/cancelled-popup-request') {
                    // 忽略此錯誤，用戶可能快速點擊多次
                    return;
                }

                showMessage(errorMessage, 'error');
            }
        }

        // 儲存使用者資料到 Firestore
        async function saveUserToFirestore(user, role) {
            try {
                const userRef = db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();

                const userData = {
                    email: user.email,
                    name: user.displayName || user.email.split('@')[0],
                    photoURL: user.photoURL || '',
                    lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (!userDoc.exists) {
                    // 新使用者
                    userData.role = role;
                    userData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    userData.settings = {
                        theme: 'light',
                        notifications: true,
                        language: 'zh-TW'
                    };

                    await userRef.set(userData);
                    console.log('✅ 新使用者資料已儲存');
                } else {
                    // 現有使用者，只更新部分資料
                    await userRef.update(userData);
                    console.log('✅ 使用者資料已更新');
                }

            } catch (error) {
                console.error('❌ 儲存使用者資料失敗:', error);
                showMessage('儲存使用者資料失敗，但登入成功', 'error');
            }
        }

        // 登入按鈕事件
        googleLoginBtn.addEventListener('click', async() => {
            if (!selectedRole) {
                showMessage('請先選擇身份', 'error');
                return;
            }

            await signInWithGoogle(selectedRole);
        });

        // 頁面載入完成
        console.log('✅ 登入頁面載入完成');
        console.log('🔥 Firebase 專案:', firebaseConfig.projectId);
    </script>
</body>

</html>